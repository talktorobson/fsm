<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>YellowGrid Service Execution - Interactive Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --yellow: #ffcb32;
      --yellow-soft: #ffe9a8;
      --bg-dark: #070c12;
      --bg-card: #0f1722;
      --bg-panel: #111c2a;
      --border: rgba(255, 255, 255, 0.12);
      --text-main: #f5f7fb;
      --text-muted: #8b95a7;
      --accent-blue: #4ea8ff;
      --accent-green: #49d493;
      --accent-red: #ff6b6b;
      --accent-orange: #fbbf24;
      --accent-purple: #c084fc;
      --shadow: 0 25px 60px rgba(0, 0, 0, 0.45);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-pill: 999px;
      --transition: 0.2s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #18233a, #05070b 65%);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    .app-header {
      background: rgba(15, 23, 42, 0.95);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .app-header .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .app-header .logo-icon {
      width: 48px;
      height: 48px;
      filter: drop-shadow(0 4px 12px rgba(255, 193, 7, 0.4));
      flex-shrink: 0;
    }

    .app-header .logo-text {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .app-header .logo-brand {
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--yellow) 0%, var(--yellow-soft) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }

    .app-header .logo-tagline {
      font-size: 0.625rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    .scenario-selector {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .scenario-selector select {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-panel);
      color: var(--text-main);
      font-size: 0.9rem;
    }

    /* Metro Journey Layout */
    .metro-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .metro-line {
      background: var(--bg-panel);
      border-bottom: 2px solid var(--border);
      padding: 1.5rem 2rem 3.5rem 2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      overflow-x: auto;
      overflow-y: visible;
      flex-shrink: 0;
      min-height: 120px;
      position: relative;
    }

    .metro-line::-webkit-scrollbar {
      height: 8px;
    }

    .metro-line::-webkit-scrollbar-track {
      background: var(--bg-card);
      border-radius: 4px;
    }

    .metro-line::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .metro-line::-webkit-scrollbar-thumb:hover {
      background: var(--yellow);
    }

    .metro-station {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
      min-width: 180px;
      position: relative;
    }

    .station-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 3px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .station-dot:hover {
      border-color: var(--yellow);
      transform: scale(1.1);
    }

    .station-dot.completed {
      background: var(--accent-green);
      border-color: var(--accent-green);
      color: #fff;
    }

    .station-dot.active {
      background: var(--yellow);
      border-color: var(--yellow);
      color: #1a1a1a;
      box-shadow: 0 0 20px var(--yellow);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 20px var(--yellow); }
      50% { box-shadow: 0 0 30px var(--yellow), 0 0 50px rgba(255, 203, 50, 0.5); }
    }

    .station-label {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      white-space: normal;
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
      width: 160px;
      line-height: 1.3;
      word-wrap: break-word;
    }

    .station-dot.active + .station-label {
      color: var(--yellow);
      font-weight: 700;
    }

    .station-line {
      width: 60px;
      height: 3px;
      background: var(--border);
      flex-shrink: 0;
    }

    .station-line.completed {
      background: var(--accent-green);
    }

    /* Journey Cards */
    .journey-stage {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 2rem;
      min-height: 0;
    }

    .journey-card {
      width: 100%;
      max-width: 1200px;
      max-height: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      animation: slideIn 0.4s ease;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .journey-card::-webkit-scrollbar {
      width: 10px;
    }

    .journey-card::-webkit-scrollbar-track {
      background: var(--bg-dark);
      border-radius: 5px;
    }

    .journey-card::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 5px;
    }

    .journey-card::-webkit-scrollbar-thumb:hover {
      background: var(--yellow);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Main Dashboard (kept for backward compatibility) */
    .dashboard {
      display: none;
    }

    .panel {
      background: var(--bg-dark);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.6);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .panel-header h2 {
      font-size: 1.1rem;
      margin-bottom: 0.3rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-header p {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .panel-content {
      padding: 1.5rem;
      flex: 1;
    }

    /* Data Flow Panel */
    .data-flow-stage {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }

    .data-flow-stage.active {
      border-color: var(--yellow);
      background: rgba(255, 203, 50, 0.05);
    }

    .stage-header {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      margin-bottom: 1rem;
    }

    .stage-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.08);
      font-size: 1.2rem;
    }

    .stage-icon.active {
      background: var(--yellow);
      color: #1a1405;
    }

    .stage-title {
      flex: 1;
    }

    .stage-title h3 {
      font-size: 1rem;
      margin-bottom: 0.2rem;
    }

    .stage-title span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .data-payload {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.8rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .data-payload .key {
      color: var(--accent-blue);
    }

    .data-payload .value {
      color: var(--accent-green);
    }

    .data-payload .string {
      color: var(--accent-orange);
    }

    /* Stakeholder View Panel */
    .stakeholder-view {
      background: var(--bg-panel);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .view-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .view-header h3 {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .role-badge {
      padding: 0.4rem 0.8rem;
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
    }

    .role-operator {
      background: rgba(78, 168, 255, 0.15);
      color: var(--accent-blue);
    }

    .role-provider {
      background: rgba(251, 191, 36, 0.15);
      color: var(--accent-orange);
    }

    .role-crew {
      background: rgba(192, 132, 252, 0.15);
      color: var(--accent-purple);
    }

    .role-customer {
      background: rgba(73, 212, 147, 0.15);
      color: var(--accent-green);
    }

    .view-section {
      margin-bottom: 1.5rem;
    }

    .view-section h4 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.8rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .info-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 0.8rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .info-item label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.3rem;
    }

    .info-item .value {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .action-buttons {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.7rem 1.2rem;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      font-size: 0.9rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--yellow), #ffd86c);
      color: #1a1405;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    /* AI Intelligence Panel */
    .ai-insight {
      background: rgba(192, 132, 252, 0.08);
      border-left: 3px solid var(--accent-purple);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .ai-insight-header {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.8rem;
    }

    .ai-insight-header i {
      color: var(--accent-purple);
    }

    .ai-insight-header strong {
      color: var(--accent-purple);
    }

    .ai-reasoning {
      font-size: 0.9rem;
      line-height: 1.6;
      margin-bottom: 0.8rem;
    }

    .ai-confidence {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-size: 0.85rem;
    }

    .confidence-bar {
      flex: 1;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue));
      transition: width 0.5s ease;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 0.8rem;
    }

    .metric-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.8rem;
    }

    .metric-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .metric-value.risk-low { color: var(--accent-green); }
    .metric-value.risk-medium { color: var(--accent-orange); }
    .metric-value.risk-high { color: var(--accent-red); }

    .metric-factors {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .factor-chip {
      padding: 0.3rem 0.7rem;
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    /* Timeline */
    .timeline {
      position: relative;
      padding-left: 2rem;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(255, 255, 255, 0.1);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 1.5rem;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.55rem;
      top: 0.3rem;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      border: 2px solid var(--bg-dark);
    }

    .timeline-item.active::before {
      background: var(--yellow);
      box-shadow: 0 0 0 4px rgba(255, 203, 50, 0.2);
    }

    .timeline-item.completed::before {
      background: var(--accent-green);
    }

    .timeline-content {
      font-size: 0.9rem;
    }

    .timeline-content strong {
      display: block;
      margin-bottom: 0.2rem;
    }

    .timeline-content span {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .dashboard {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }
      
      body {
        overflow-y: auto;
        height: auto;
      }

      .app-shell {
        height: auto;
      }
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.8rem;
      border-radius: var(--radius-pill);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .status-pending {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-muted);
    }

    .status-ok {
      background: rgba(73, 212, 147, 0.15);
      color: var(--accent-green);
    }

    .status-nok {
      background: rgba(255, 107, 107, 0.15);
      color: var(--accent-red);
    }

    /* Mobile App Styles */
    .mobile-screen {
      background: #000;
      border-radius: 24px;
      padding: 1rem;
      box-shadow: 0 0 0 8px #1a1a1a, 0 30px 60px rgba(0, 0, 0, 0.8);
      max-width: 400px;
      margin: 0 auto;
    }

    .mobile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
      border-radius: 16px 16px 0 0;
      margin: -1rem -1rem 1rem -1rem;
    }

    .mobile-status-bar {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .mobile-card {
      background: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }

    .mobile-button {
      width: 100%;
      padding: 1rem;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mobile-button-primary {
      background: linear-gradient(135deg, var(--yellow), #ffd86c);
      color: #1a1405;
    }

    .mobile-button-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Operator Cockpit Styles */
    .cockpit-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .cockpit-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.25rem;
    }

    .cockpit-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .cockpit-metric {
      font-size: 2rem;
      font-weight: 700;
      line-height: 1;
      margin: 0.5rem 0;
    }

    .cockpit-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    /* Email/SMS Mockup */
    .email-mockup {
      background: #fff;
      color: #1a1a1a;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .email-header {
      border-bottom: 2px solid #e5e5e5;
      padding-bottom: 1rem;
      margin-bottom: 1.5rem;
    }

    .email-body {
      line-height: 1.6;
      color: #333;
    }

    .email-button {
      display: inline-block;
      background: linear-gradient(135deg, var(--yellow), #ffd86c);
      color: #1a1405;
      padding: 1rem 2rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      margin: 1.5rem 0;
    }

    .sms-mockup {
      background: #1a1a1a;
      border-radius: 18px;
      padding: 1rem;
      max-width: 300px;
      margin: 1rem auto;
    }

    .sms-bubble {
      background: #2a7aff;
      color: #fff;
      border-radius: 18px;
      padding: 0.8rem 1.2rem;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Header -->
    <header class="app-header">
      <div class="logo">
        <svg class="logo-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Yellow grid background -->
          <rect width="100" height="100" rx="20" fill="url(#gridGradient)"/>
          <!-- Grid lines -->
          <line x1="33" y1="15" x2="33" y2="85" stroke="#1a1300" stroke-width="2" opacity="0.3"/>
          <line x1="67" y1="15" x2="67" y2="85" stroke="#1a1300" stroke-width="2" opacity="0.3"/>
          <line x1="15" y1="33" x2="85" y2="33" stroke="#1a1300" stroke-width="2" opacity="0.3"/>
          <line x1="15" y1="67" x2="85" y2="67" stroke="#1a1300" stroke-width="2" opacity="0.3"/>
          <!-- Center highlight dot -->
          <circle cx="50" cy="50" r="8" fill="#1a1300"/>
          <circle cx="50" cy="50" r="5" fill="#fff"/>
          <!-- Corner accent dots -->
          <circle cx="33" cy="33" r="4" fill="#1a1300" opacity="0.6"/>
          <circle cx="67" cy="33" r="4" fill="#1a1300" opacity="0.6"/>
          <circle cx="33" cy="67" r="4" fill="#1a1300" opacity="0.6"/>
          <circle cx="67" cy="67" r="4" fill="#1a1300" opacity="0.6"/>
          <!-- Gradient definition -->
          <defs>
            <linearGradient id="gridGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#ffc107;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#ffd54f;stop-opacity:1" />
            </linearGradient>
          </defs>
        </svg>
        <div class="logo-text">
          <span class="logo-brand">YellowGrid</span>
          <span class="logo-tagline">Service Execution</span>
        </div>
      </div>
      <div class="scenario-selector">
        <label for="scenarioSelect" style="font-size: 0.9rem; color: var(--text-muted);">Scenario:</label>
        <select id="scenarioSelect" onchange="dashboard.loadScenario(this.value)">
          <option value="">Select a scenario...</option>
          <option value="simple-install">Simple Installation</option>
          <option value="tv-quotation">Technical Visit of Quotation</option>
          <option value="package-deal">Service Pack (with confirmation TV)</option>
          <option value="complex-project">Complex Installation</option>
          <option value="rework">Rework</option>
          <option value="maintenance">Maintenance</option>
          <option value="depannage">Dépannage (Emergency Service)</option>
          <option value="subscription">Subscription Service</option>
        </select>
        <button class="btn btn-secondary" onclick="dashboard.nextStep()" id="nextBtn">
          Next Step <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </header>

    <!-- Metro Journey Experience -->
    <main class="metro-container">
      <!-- Metro Line Navigation -->
      <div class="metro-line" id="metroLine">
        <!-- Stations will be rendered here -->
      </div>

      <!-- Journey Stage (Single Card View) -->
      <div class="journey-stage" id="journeyStage">
        <div class="journey-card" id="journeyCard">
          <p style="color: var(--text-muted); text-align: center; padding: 4rem;">
            Select a scenario to begin your journey
          </p>
        </div>
      </div>
    </main>
  </div>

  <script>
    (() => {
      // Scenario data
      const scenarios = {
        'simple-install': {
          name: 'Simple Installation',
          salesOrder: {
            orderId: 'SO-2025-9821',
            salesChannel: 'E-commerce',
            store: 'Online Store PT',
            storeCode: 'ONLPT-001',
            salesProjectId: 'PROJ-4421',
            leadId: 'LEAD-8832',
            opportunityId: 'OPP-2025-5521',
            salesman: 'Rita Fernandes',
            salesmanId: 'SALES-RF-042',
            salesmanEmail: 'rita.fernandes@yellowgrid.pt',
            orderDate: '2025-11-08T14:22:00Z',
            confirmationDate: '2025-11-08T14:25:33Z',
            customer: {
              customerId: 'CUST-12845',
              name: 'Ana Costa',
              firstName: 'Ana',
              lastName: 'Costa',
              email: 'ana.costa@email.pt',
              phone: '+351 912 345 678',
              alternatePhone: '+351 218 765 432',
              address: 'Rua do Horizonte 12, 1170-123 Lisboa',
              addressLine1: 'Rua do Horizonte 12',
              addressLine2: '3º Andar, Porta B',
              city: 'Lisboa',
              postalCode: '1170-123',
              region: 'Lisboa',
              country: 'Portugal',
              customerSince: '2023-04-15',
              tier: 'Standard',
              claimHistory: 0,
              lifetimeValue: 1850.00,
              preferredContact: 'email',
              language: 'pt-PT'
            },
            products: [
              { 
                lineId: 'LINE-001',
                sku: 'COOK-IND-5Z', 
                name: 'Induction Cooktop 5 zones', 
                brand: 'Bosch',
                model: 'PXX875D34E',
                category: 'Cooktops',
                quantity: 1, 
                unitPrice: 450.00, 
                discount: 0.00,
                tax: 103.50,
                totalPrice: 450.00,
                supplier: 'Bosch Portugal',
                supplierSKU: 'BSH-PXX875D34E',
                warehouse: 'WH-LISBOA-01',
                stockStatus: 'In Stock',
                deliveryDate: '2025-11-17',
                estimatedDeliveryTime: '14:00-18:00',
                deliveryMethod: 'Standard Shipping',
                trackingNumber: 'TRK-2025-PLT-9821',
                warranty: '24 months',
                installationRequired: true
              }
            ],
            services: [
              { 
                lineId: 'LINE-002',
                code: 'INST-COOKTOP', 
                name: 'Cooktop Installation', 
                description: 'Professional installation of induction cooktop including electrical connection and testing',
                category: 'Installation Services',
                quantity: 1, 
                unitPrice: 120.00,
                discount: 0.00,
                tax: 27.60, 
                totalPrice: 120.00, 
                scheduledDate: '2025-11-18', 
                timeSlot: '09:00-11:00',
                duration: 120,
                techniciansRequired: 1,
                skillLevel: 'Standard',
                equipmentNeeded: ['Multimeter', 'Basic tools'],
                safetyRequirements: ['Circuit breaker access', 'Ventilation']
              }
            ],
            totals: {
              subtotalProducts: 450.00,
              subtotalServices: 120.00,
              subtotal: 570.00,
              discounts: 0.00,
              taxProducts: 103.50,
              taxServices: 27.60,
              totalTax: 131.10,
              shippingCost: 0.00,
              total: 701.10,
              currency: 'EUR'
            },
            payment: {
              status: 'Paid',
              method: 'Credit Card',
              cardType: 'Visa',
              last4Digits: '4532',
              paidAmount: 701.10,
              paidDate: '2025-11-10T16:45:22Z',
              transactionId: 'TXN-2025-9821-CC',
              paymentGateway: 'Stripe',
              installments: 1,
              dueDate: null
            },
            linkedQuotation: null,
            linkedPreEstimation: null,
            linkedContracts: [],
            sellerNotes: 'Customer requested morning slot. Easy access to apartment. Building has elevator. Customer will be present during installation. Electrical panel is in kitchen.',
            internalNotes: 'Standard installation. No special requirements. Customer is tech-savvy.',
            specialInstructions: 'Please call customer 30 minutes before arrival.',
            priority: 'Normal',
            tags: ['e-commerce', 'new-customer', 'morning-slot']
          }
        },
        'tv-quotation': {
          name: 'Technical Visit of Quotation',
          salesOrder: {
            orderId: 'SO-2025-1201',
            salesChannel: 'Phone',
            store: 'Customer Service Center',
            storeCode: 'CSC-001',
            salesProjectId: 'SALES-PROJ-5512',
            leadId: '69455T607',
            opportunityId: 'OPP-2025-7812',
            linkedQuotation: null,
            linkedPreEstimation: null,
            salesman: 'João Silva',
            salesmanId: 'SALES-JS-128',
            salesmanEmail: 'joao.silva@yellowgrid.pt',
            orderDate: '2025-11-14T10:15:00Z',
            confirmationDate: '2025-11-14T10:22:18Z',
            customer: {
              customerId: 'CUST-08234',
              name: 'Diogo Martins',
              firstName: 'Diogo',
              lastName: 'Martins',
              email: 'diogo.m@company.pt',
              phone: '+351 918 765 432',
              alternatePhone: '+351 213 456 789',
              address: 'Rua das Flores 45, 2º Dto, 1200-195 Lisboa',
              addressLine1: 'Rua das Flores 45',
              addressLine2: '2º Andar, Direito',
              city: 'Lisboa',
              postalCode: '1200-195',
              region: 'Lisboa',
              country: 'Portugal',
              customerSince: '2023-03-15',
              tier: 'Standard',
              claimHistory: 0,
              lifetimeValue: 450,
              preferredContact: 'phone',
              language: 'pt-PT'
            },
            products: [],
            services: [
              { 
                lineId: 'LINE-001',
                code: 'TV-KITCHEN', 
                name: 'Technical Visit - Kitchen Assessment',
                description: 'On-site technical visit to assess kitchen space, take measurements, and provide detailed quotation for dishwasher installation',
                category: 'Technical Visit',
                quantity: 1, 
                unitPrice: 80,
                discount: 0,
                tax: 18.40,
                totalPrice: 80,
                price: '80',
                scheduledDate: '2025-11-20', 
                timeSlot: '10:00-12:00',
                duration: 120,
                techniciansRequired: 1,
                skillLevel: 'Expert Technician',
                equipmentNeeded: ['Laser measure', 'Tablet', 'Camera'],
                safetyRequirements: []
              }
            ],
            totals: {
              subtotalProducts: 0,
              subtotalServices: 80,
              subtotal: 80,
              discounts: 0,
              taxProducts: 0,
              taxServices: 18.40,
              totalTax: 18.40,
              shippingCost: 0,
              total: 98.40,
              currency: 'EUR'
            },
            payment: {
              status: 'Paid',
              method: 'Credit Card',
              cardType: 'Visa',
              last4Digits: '4532',
              paidAmount: 98.40,
              paidDate: '2025-11-14T10:25:00Z',
              transactionId: 'TXN-2025-998234',
              paymentGateway: 'Stripe',
              installments: 1,
              dueDate: null
            },
            linkedContracts: [],
            sellerNotes: 'Customer planning kitchen renovation. Needs professional assessment for dishwasher installation. Interested in quotation for complete service including appliance purchase if price is competitive.',
            internalNotes: 'First-time technical visit customer. Good upsell opportunity for installation services.',
            specialInstructions: 'Customer available only mornings. Kitchen currently functional but old appliances.',
            priority: 'Normal',
            tags: ['phone-order', 'technical-visit', 'kitchen', 'quotation', 'first-timer']
          }
        },
        'package-deal': {
          name: 'Service Pack (with confirmation TV)',
          salesOrder: {
            orderId: 'SO-2025-3342',
            salesChannel: 'In-store',
            store: 'Retail Porto Boavista',
            storeCode: 'RET-PRT-BOA',
            salesProjectId: 'SALES-PROJ-6721',
            leadId: '69455T820',
            opportunityId: 'OPP-2025-9103',
            linkedQuotation: null,
            linkedPreEstimation: null,
            salesman: 'Carlos Mendes',
            salesmanId: 'SALES-CM-091',
            salesmanEmail: 'carlos.mendes@yellowgrid.pt',
            orderDate: '2025-11-12T16:45:00Z',
            confirmationDate: '2025-11-12T16:52:18Z',
            customer: {
              customerId: 'CUST-19203',
              name: 'Pedro Silva',
              firstName: 'Pedro',
              lastName: 'Silva',
              email: 'pedro.silva@gmail.com',
              phone: '+351 935 678 901',
              alternatePhone: '+351 228 901 234',
              address: 'Av. da Boavista 1550, 2º Esq, 4100-114 Porto',
              addressLine1: 'Av. da Boavista 1550',
              addressLine2: '2º Andar, Esquerdo',
              city: 'Porto',
              postalCode: '4100-114',
              region: 'Porto',
              country: 'Portugal',
              customerSince: '2024-06-10',
              tier: 'Standard',
              claimHistory: 0,
              lifetimeValue: 890,
              preferredContact: 'phone',
              language: 'pt-PT'
            },
            products: [
              {
                sku: 'DW-BOSCH-SMV46',
                name: 'Bosch Serie 4 Dishwasher SMV46MX03E',
                category: 'Dishwashers',
                brand: 'Bosch',
                quantity: 1,
                unitPrice: 549,
                discount: 50,
                tax: 114.77,
                totalPrice: 499,
                deliveryDate: '2025-11-25',
                supplier: 'Bosch Portugal',
                stockStatus: 'In Stock',
                warranty: '24 months'
              }
            ],
            services: [
              {
                lineId: 'LINE-001',
                code: 'TV-CONF-DW',
                name: 'Technical Visit - Pre-Installation Confirmation',
                description: 'On-site technical visit to confirm installation feasibility, validate measurements, check plumbing and electrical conditions before proceeding with main installation',
                category: 'Technical Visit',
                quantity: 1,
                unitPrice: 0,
                discount: 0,
                tax: 0,
                totalPrice: 0,
                price: '0',
                scheduledDate: '2025-11-22',
                timeSlot: '14:00-16:00',
                duration: 90,
                techniciansRequired: 1,
                skillLevel: 'Expert Technician',
                equipmentNeeded: ['Laser measure', 'Tablet', 'Camera', 'Testing tools'],
                safetyRequirements: []
              },
              {
                lineId: 'LINE-002',
                code: 'INST-DW',
                name: 'Dishwasher Installation',
                description: 'Complete dishwasher installation including unboxing, positioning, plumbing connections, electrical connection, testing and customer training',
                category: 'Installation',
                quantity: 1,
                unitPrice: 120,
                discount: 0,
                tax: 27.60,
                totalPrice: 120,
                price: '120',
                scheduledDate: '2025-11-26',
                timeSlot: '09:00-11:00',
                duration: 120,
                techniciansRequired: 1,
                skillLevel: 'Plumber',
                equipmentNeeded: ['Standard tools', 'Connection kit'],
                safetyRequirements: ['Water shutoff', 'Electrical safety']
              }
            ],
            totals: {
              subtotalProducts: 499,
              subtotalServices: 120,
              subtotal: 619,
              discounts: 50,
              taxProducts: 114.77,
              taxServices: 27.60,
              totalTax: 142.37,
              shippingCost: 0,
              total: 761.37,
              currency: 'EUR'
            },
            payment: {
              status: 'Paid',
              method: 'Credit Card',
              cardType: 'Visa',
              last4Digits: '8834',
              paidAmount: 761.37,
              paidDate: '2025-11-12T16:55:00Z',
              transactionId: 'TXN-2025-334892',
              paymentGateway: 'Stripe',
              installments: 1,
              dueDate: null
            },
            linkedContracts: [],
            sellerNotes: 'Customer purchased service pack (product + installation). Confirmation technical visit included to validate kitchen conditions. TV OUTCOMES: YES = proceed to installation | NO = cancel order/refund | YES BUT = scope adjustment required (price/timeline changes).',
            internalNotes: 'Pack deal with confirmation TV scheduled BEFORE main installation. Installation LINE-002 only proceeds if TV confirmation is YES or YES BUT (with adjustments). Customer aware that final installation depends on TV confirmation outcome. If YES BUT, provider may request derogation for price adjustment.',
            specialInstructions: 'CONFIRMATION TV CHECKLIST: (1) Water supply accessible & pressure adequate, (2) Electrical outlet 220V within 1.5m, (3) Space dimensions match product specs (60cm W x 82cm H x 55cm D), (4) Cabinet modifications needed? (5) Drainage accessible. OUTCOME RULES: TV=YES → approve go exec → execute installation | TV=NO → cancel SO, refund customer | TV=YES BUT → provider submits adjustment quotation → operator approves derogation → revised go exec → execute with adjustments.',
            priority: 'Normal',
            tags: ['in-store', 'service-pack', 'confirmation-tv', 'dishwasher', 'installation', 'two-phase-execution']
          }
        },
        'complex-project': {
          name: 'Complex Installation Project',
          salesOrder: {
            orderId: 'PROJ-2025-8840',
            salesChannel: 'In-store',
            store: 'Retail Lisboa Amoreiras',
            storeCode: 'RET-LIS-AMO',
            salesProjectId: 'SALES-PROJ-8840',
            leadId: 'LEAD-8840',
            opportunityId: 'OPP-2025-8840',
            linkedQuotation: 'QUOT-2025-7234',
            linkedPreEstimation: 'PRE-EST-2025-6892',
            salesman: 'Maria Santos',
            salesmanId: 'SALES-MS-155',
            salesmanEmail: 'maria.santos@yellowgrid.pt',
            orderDate: '2025-10-20T09:30:00Z',
            confirmationDate: '2025-10-21T14:18:00Z',
            customer: {
              customerId: 'CUST-15892',
              name: 'Sofia Rodrigues',
              firstName: 'Sofia',
              lastName: 'Rodrigues',
              email: 'sofia.rodrigues@email.pt',
              phone: '+351 915 234 567',
              alternatePhone: '+351 217 890 123',
              address: 'Av. Eng. Duarte Pacheco 28, 3º B, 1070-101 Lisboa',
              addressLine1: 'Av. Eng. Duarte Pacheco 28',
              addressLine2: '3º Andar, Apartamento B',
              city: 'Lisboa',
              postalCode: '1070-101',
              region: 'Lisboa',
              country: 'Portugal',
              customerSince: '2023-08-15',
              tier: 'Premium',
              claimHistory: 0,
              lifetimeValue: 4850,
              preferredContact: 'phone',
              language: 'pt-PT'
            },
            products: [
              {
                lineId: 'PROD-001',
                sku: 'BATH-SUITE-LUX',
                name: 'Luxury Bathroom Suite Complete',
                brand: 'Roca',
                model: 'Inspira',
                category: 'Bathroom Fixtures',
                quantity: 1,
                unitPrice: 3200,
                discount: 320,
                tax: 662.40,
                totalPrice: 2880,
                deliveryDate: '2025-11-20',
                deliveryStatus: 'Scheduled',
                supplier: 'Roca Portugal',
                stockStatus: 'In Stock',
                warranty: '24 months',
                installationRequired: true
              },
              {
                lineId: 'PROD-002',
                sku: 'TILE-PORCE-60X120',
                name: 'Premium Porcelain Tiles 60x120cm',
                brand: 'Revigrés',
                model: 'Marble Carrara',
                category: 'Tiles & Flooring',
                quantity: 35,
                unitPrice: 85,
                discount: 0,
                tax: 688.75,
                totalPrice: 2975,
                deliveryDate: '2025-11-22',
                deliveryStatus: 'Scheduled',
                supplier: 'Revigrés',
                stockStatus: 'In Stock',
                warranty: '60 months',
                installationRequired: true
              },
              {
                lineId: 'PROD-003',
                sku: 'SHOWER-ENC-TEMP',
                name: 'Tempered Glass Shower Enclosure',
                brand: 'Novellini',
                model: 'Kuadra H',
                category: 'Shower Systems',
                quantity: 1,
                unitPrice: 1850,
                discount: 0,
                tax: 425.50,
                totalPrice: 1850,
                deliveryDate: '2025-11-28',
                deliveryStatus: 'Scheduled',
                supplier: 'Novellini Iberia',
                stockStatus: 'On Order',
                warranty: '36 months',
                installationRequired: true
              },
              {
                lineId: 'PROD-004',
                sku: 'HEAT-TOWEL-ELEC',
                name: 'Electric Heated Towel Rail',
                brand: 'Acova',
                model: 'Regate Twist',
                category: 'Heating',
                quantity: 1,
                unitPrice: 450,
                discount: 0,
                tax: 103.50,
                totalPrice: 450,
                deliveryDate: '2025-12-03',
                deliveryStatus: 'Scheduled',
                supplier: 'Acova Portugal',
                stockStatus: 'In Stock',
                warranty: '24 months',
                installationRequired: true
              }
            ],
            services: [
              {
                lineId: 'SRV-001',
                serviceOrderId: 'SO-2025-8840-01',
                code: 'DEMO-PLUMB-ELECT',
                name: 'Demolition & Plumbing/Electrical Prep',
                description: 'Complete bathroom demolition, removal of old fixtures, plumbing rough-in, electrical rewiring, waterproofing preparation',
                category: 'Demolition & Preparation',
                quantity: 1,
                unitPrice: 1200,
                discount: 0,
                tax: 276,
                totalPrice: 1200,
                price: '1200',
                scheduledDate: '2025-11-22',
                timeSlot: '08:00-17:00',
                duration: 480,
                techniciansRequired: 2,
                skillLevel: 'Plumber + Electrician',
                equipmentNeeded: ['Demolition tools', 'Pipe wrench', 'Electrical tester', 'Waste removal bags', 'Safety equipment'],
                safetyRequirements: ['Water shutoff', 'Electrical lockout', 'Dust masks', 'Safety boots', 'PPE required'],
                dependencies: [],
                precedenceRule: 'First service - no dependencies',
                requiredProducts: [],
                requiredPayment: 0.30,
                status: 'Ready'
              },
              {
                lineId: 'SRV-002',
                serviceOrderId: 'SO-2025-8840-02',
                code: 'INST-TILE-WATERPROOF',
                name: 'Tiling & Waterproofing',
                description: 'Wall and floor tiling installation, waterproofing membrane application, grouting, sealing and finishing',
                category: 'Tiling Installation',
                quantity: 1,
                unitPrice: 1800,
                discount: 0,
                tax: 414,
                totalPrice: 1800,
                price: '1800',
                scheduledDate: '2025-11-26',
                timeSlot: '08:00-17:00',
                duration: 540,
                techniciansRequired: 2,
                skillLevel: 'Tile Specialist',
                equipmentNeeded: ['Tile cutter', 'Adhesive mixer', 'Level', 'Spacers', 'Grouting tools', 'Waterproofing materials'],
                safetyRequirements: ['Dust masks', 'Knee pads', 'Safety glasses', 'PPE required'],
                dependencies: ['SRV-001'],
                precedenceRule: 'Requires demolition completion + quality check + partial payment',
                requiredProducts: ['PROD-002'],
                requiredPayment: 0.50,
                status: 'Blocked'
              },
              {
                lineId: 'SRV-003',
                serviceOrderId: 'SO-2025-8840-03',
                code: 'INST-SANITARY-SHOWER',
                name: 'Sanitary Ware & Shower Installation',
                description: 'Installation of bathroom suite (toilet, sink, bathtub), shower enclosure, plumbing connections, silicone sealing and testing',
                category: 'Plumbing Installation',
                quantity: 1,
                unitPrice: 1500,
                discount: 0,
                tax: 345,
                totalPrice: 1500,
                price: '1500',
                scheduledDate: '2025-12-02',
                timeSlot: '08:00-17:00',
                duration: 480,
                techniciansRequired: 2,
                skillLevel: 'Plumber + Installer',
                equipmentNeeded: ['Pipe wrench', 'Silicone gun', 'Level', 'Drill', 'Measuring tools', 'Testing equipment'],
                safetyRequirements: ['Water pressure testing', 'Leak detection', 'PPE required'],
                dependencies: ['SRV-001', 'SRV-002'],
                precedenceRule: 'Requires demolition AND tiling completed + quality checks + payment milestone',
                requiredProducts: ['PROD-001', 'PROD-003'],
                requiredPayment: 0.80,
                status: 'Blocked'
              },
              {
                lineId: 'SRV-004',
                serviceOrderId: 'SO-2025-8840-04',
                code: 'FINAL-FINISH-PAINT',
                name: 'Final Finishing & Painting',
                description: 'Painting walls and ceiling, installation of accessories (towel rail, mirrors, shelves), final cleaning, touch-ups and customer handover',
                category: 'Finishing',
                quantity: 1,
                unitPrice: 800,
                discount: 0,
                tax: 184,
                totalPrice: 800,
                price: '800',
                scheduledDate: '2025-12-06',
                timeSlot: '09:00-17:00',
                duration: 420,
                techniciansRequired: 2,
                skillLevel: 'Painter + General Installer',
                equipmentNeeded: ['Paint rollers', 'Brushes', 'Drop cloths', 'Drill', 'Level', 'Cleaning supplies'],
                safetyRequirements: ['Ventilation', 'Low-VOC paint', 'PPE required'],
                dependencies: ['SRV-001', 'SRV-002', 'SRV-003'],
                precedenceRule: 'Requires ALL previous services completed + ALL quality checks passed',
                requiredProducts: ['PROD-004'],
                requiredPayment: 0.80,
                status: 'Blocked'
              }
            ],
            totals: {
              subtotalProducts: 8155,
              subtotalServices: 5300,
              subtotal: 13455,
              discounts: 320,
              taxProducts: 1879.15,
              taxServices: 1219,
              totalTax: 3098.15,
              shippingCost: 0,
              total: 16233.15,
              currency: 'EUR'
            },
            payment: {
              status: 'Partial',
              method: 'Bank Transfer',
              paidAmount: 4869.95,
              paymentMilestones: [
                { milestone: 'Initial (30%)', amount: 4869.95, status: 'Paid', date: '2025-10-22T10:00:00Z' },
                { milestone: 'Tiling Complete (20%)', amount: 3246.63, status: 'Pending', date: null },
                { milestone: 'Fixtures Complete (30%)', amount: 4869.95, status: 'Pending', date: null },
                { milestone: 'Final (20%)', amount: 3246.62, status: 'Pending', date: null }
              ],
              paymentTerms: 'Milestone-based payment: 30% upfront, 20% after tiling, 30% after fixtures, 20% after finishing',
              transactionIds: ['TXN-2025-8840-M1'],
              dueDate: '2025-12-10'
            },
            projectPhases: [
              { phase: 1, name: 'Demolition & Prep', services: ['SRV-001'], status: 'Ready', startDate: '2025-11-22', estimatedDays: 2 },
              { phase: 2, name: 'Tiling & Waterproofing', services: ['SRV-002'], status: 'Blocked', startDate: '2025-11-26', estimatedDays: 3 },
              { phase: 3, name: 'Fixtures Installation', services: ['SRV-003'], status: 'Blocked', startDate: '2025-12-02', estimatedDays: 2 },
              { phase: 4, name: 'Finishing & Paint', services: ['SRV-004'], status: 'Blocked', startDate: '2025-12-06', estimatedDays: 2 }
            ],
            linkedContracts: ['CONT-2025-8840'],
            sellerNotes: 'Premium customer - complete bathroom renovation. Complex multi-phase project with strict dependencies. Customer wants high-quality finish with marble-look tiles. Payment structure is milestone-based. Critical path: Demolition → Tiling → Fixtures → Finishing. Each phase must be quality-checked and paid before next phase starts.',
            internalNotes: 'Complex project management required. Provider: HomePro Renovations (assigned for all services). Each service becomes separate service order but within same project umbrella. Quality checks after each phase mandatory. Partial payments unlock next phases. Product delivery must match service schedule. Customer will stay with family during renovation (apartment empty).',
            specialInstructions: 'CRITICAL PATH RULES: (1) Service execution only when: required products delivered + payment milestone met + dependencies completed. (2) After each service: Quality Check → Operator Approval → Payment Authorization → Next Phase Unlock. (3) Loop mechanism: Contract → Provider Match → Go Exec → Execution → WCF → Quality Check → Payment Auth → LOOP back for next service. (4) All services use same provider (HomePro Renovations). (5) No price changes in service domain - any adjustments must come from sales domain via SO update. (6) Customer requests photos after each phase.',
            priority: 'High',
            tags: ['premium', 'complex-project', 'multi-phase', 'bathroom', 'renovation', 'tiling', 'milestone-payment', 'critical-path', 'same-provider']
          }
        },
        'rework': {
          name: 'Rework - Quality Recovery',
          description: 'Service quality issue requiring corrective action. Customer signed WCF with reserves due to poor workmanship. Different provider assigned to perform rework.',
          salesOrder: {
            orderId: 'SO-2024-12456',
            soId: 'SO-2024-12456',
            originalSoId: 'SO-2024-11892',
            reworkReason: 'wcf-reserves',
            status: 'In Progress',
            createdDate: '2024-10-30T10:30:00Z',
            originalCompletionDate: '2024-10-28T16:45:00Z',
            customer: {
              customerId: 'CUST-7291',
              name: 'Sofia Rodrigues',
              email: 'sofia.rodrigues@example.pt',
              phone: '+351 91 234 5678',
              addressLine1: 'Rua das Flores, 45, 3º Esq',
              addressLine2: '',
              address: 'Rua das Flores, 45, 3º Esq, 1200-195 Lisboa',
              city: 'Lisboa',
              postalCode: '1200-195',
              country: 'Portugal',
              customerSince: '2023-08-15',
              tier: 'Premium',
              claimHistory: 1,
              lifetimeValue: 18500,
              preferredContact: 'email',
              language: 'pt-PT'
            },
            originalProvider: {
              providerId: 'PRV-1001',
              name: 'HomePro Renovations',
              category: 'Renovation Contractor',
              rating: 4.3,
              completedJobs: 284,
              isReworkProvider: false,
              willGetPaid: false,
              qualityIncident: true
            },
            reworkProvider: {
              providerId: 'PRV-2305',
              name: 'QualityFix Specialists',
              category: 'Remedial Works',
              rating: 4.9,
              completedJobs: 156,
              specialization: 'Tiling & Waterproofing Remediation',
              isReworkProvider: true,
              willGetPaid: true
            },
            problemDetails: {
              reportedBy: 'Customer',
              reportedDate: '2024-10-29T09:15:00Z',
              wcfStatus: 'Signed with Reserves',
              issueCategory: 'Workmanship Quality',
              severity: 'High',
              description: 'Grout lines uneven and inconsistent width (2-5mm variation). Waterproofing test failed in shower corner (moisture detected). Tile alignment off by 3mm in visible area. Professional finish standards not met.',
              evidencePhotos: ['photo-grout-uneven.jpg', 'photo-moisture-test.jpg', 'photo-alignment-issue.jpg'],
              rootCause: 'Rushed execution, inadequate waterproofing membrane overlap, poor quality control',
              customerImpact: 'Bathroom unusable until fixed, customer lost confidence in original provider'
            },
            services: [
              {
                lineId: 'LINE-RWK-001',
                code: 'RWK-TILE-WP',
                name: 'Rework: Tiling & Waterproofing Correction',
                description: 'Remove affected tiles in shower corner (2m²), re-apply waterproofing membrane with proper overlap, re-tile with proper grout line consistency, re-grout entire shower area for uniform appearance, 24-hour waterproofing test',
                category: 'Rework',
                quantity: 1,
                unitPrice: 850,
                discount: 0,
                tax: 0,
                totalPrice: 850,
                price: '850',
                scheduledDate: '2024-11-02',
                timeSlot: '09:00-15:00',
                duration: 360,
                techniciansRequired: 2,
                skillLevel: 'Master Tiler + Waterproofing Specialist',
                equipmentNeeded: ['Tile removal tools', 'Waterproofing membrane', 'Grout mixing equipment', 'Moisture testing device'],
                safetyRequirements: ['Dust containment', 'Ventilation', 'Floor protection'],
                materialsIncluded: ['Replacement tiles (from original batch)', 'Waterproofing membrane', 'Premium grout', 'Sealant'],
                workScope: [
                  'Remove defective tiles (2m² shower corner)',
                  'Clean and prepare substrate',
                  'Apply waterproofing membrane (proper 150mm overlap)',
                  'Cure for 24 hours',
                  'Install replacement tiles (level alignment ±0.5mm)',
                  'Grout with consistent 3mm joints',
                  'Re-grout visible shower area for uniformity',
                  'Seal all joints',
                  'Perform 24-hour moisture test',
                  'Final inspection and customer walkthrough'
                ]
              }
            ],
            totals: {
              subtotalProducts: 0,
              subtotalServices: 850,
              subtotal: 850,
              discounts: 0,
              taxProducts: 0,
              taxServices: 0,
              totalTax: 0,
              shippingCost: 0,
              total: 850,
              currency: 'EUR'
            },
            financials: {
              customerPayment: 0,
              customerPaymentReason: 'Quality issue - no customer charge for rework',
              providerPayment: 850,
              providerPaymentReason: 'Different provider performing rework - full payment applies',
              paymentCondition: 'different-provider',
              originalProviderLiability: 'HomePro Renovations - quality incident logged, rating impact',
              platformFee: 0,
              platformFeeReason: 'No platform fee on rework - service domain recovery'
            },
            payment: {
              status: 'Pending',
              method: 'Platform Credit',
              customerOwes: 0,
              providerReceives: 850,
              paymentTrigger: 'WCF acceptance after rework completion',
              transactionId: null,
              installments: 1
            },
            linkedContracts: ['CTR-2024-5501'],
            originalSoReference: {
              soId: 'SO-2024-11892',
              serviceName: 'Tiling & Waterproofing (Phase 2)',
              originalValue: 4875.40,
              completedDate: '2024-10-28',
              originalProvider: 'HomePro Renovations'
            },
            operatorNotes: 'Customer complaint legitimate - quality standards not met. Original provider (HomePro) offered to fix but customer declined (lost trust). Assigned QualityFix Specialists - specialized in remedial tiling work. Customer expects professional finish this time. High priority - bathroom currently unusable.',
            internalNotes: 'REWORK RULES: (1) Customer pays €0 always. (2) Same provider rework = provider pays own costs (no platform payment). (3) Different provider rework = platform pays provider normally. (4) Original provider quality incident logged. (5) No sales domain involvement. (6) Must get WCF acceptance after rework.',
            specialInstructions: 'REWORK WORKFLOW: Assessment → Provider Assignment → Go Exec → Execution → Quality Check → WCF → Payment (conditional). QUALITY STANDARDS: Grout lines 3mm ±0.5mm consistent, tiles level ±0.5mm, waterproofing test pass (24hr moisture test), professional finish expected. Customer very detail-oriented - photos required at each stage.',
            priority: 'High',
            tags: ['rework', 'quality-issue', 'wcf-reserves', 'different-provider', 'tiling', 'waterproofing', 'remedial-work']
          }
        },
        'maintenance': {
          name: 'Maintenance - Asset Service',
          description: 'Annual maintenance service for existing equipment. No product delivery - provider brings all parts/consumables included in service price. Focus on asset details and service history.',
          salesOrder: {
            orderId: 'SO-2025-3344',
            soId: 'SO-2025-3344',
            salesChannel: 'Customer Service',
            store: 'Maintenance Center',
            storeCode: 'MAINT-001',
            salesProjectId: null,
            leadId: null,
            opportunityId: null,
            salesman: 'Maintenance Scheduler',
            salesmanId: 'MAINT-AUTO',
            salesmanEmail: 'maintenance@yellowgrid.pt',
            orderDate: '2025-11-10T09:30:00Z',
            confirmationDate: '2025-11-10T09:35:00Z',
            orderType: 'maintenance',
            customer: {
              customerId: 'CUST-4582',
              name: 'João Ferreira',
              firstName: 'João',
              lastName: 'Ferreira',
              email: 'joao.ferreira@email.pt',
              phone: '+351 916 543 210',
              alternatePhone: '+351 214 567 890',
              addressLine1: 'Avenida da República, 125',
              addressLine2: '4º Andar, Porta D',
              address: 'Avenida da República, 125, 4º Andar, 1050-189 Lisboa',
              city: 'Lisboa',
              postalCode: '1050-189',
              region: 'Lisboa',
              country: 'Portugal',
              customerSince: '2018-03-20',
              tier: 'Premium',
              claimHistory: 0,
              lifetimeValue: 2450,
              preferredContact: 'phone',
              language: 'pt-PT',
              propertyType: 'Apartment',
              propertySize: '95m²',
              occupancy: 'Owner-occupied'
            },
            asset: {
              assetId: 'ASSET-2018-7742',
              assetType: 'Boiler',
              category: 'HVAC',
              brand: 'Vaillant',
              model: 'ecoTEC plus VCW 246/5-5',
              serialNumber: '21234567890',
              installationDate: '2018-03-15',
              yearsInService: 7,
              capacity: '24 kW',
              fuelType: 'Natural Gas',
              powerRating: '24 kW heating / 28 kW hot water',
              efficiency: 'A-rated (94% efficiency)',
              location: 'Kitchen utility cupboard',
              currentStatus: 'Operational',
              lastServiceDate: '2024-11-12',
              lastServiceProvider: 'HeatingPro Services',
              serviceHistory: [
                { date: '2024-11-12', type: 'Annual Maintenance', provider: 'HeatingPro Services', cost: 115, notes: 'Full service completed. All OK.' },
                { date: '2023-11-08', type: 'Annual Maintenance', provider: 'HeatingPro Services', cost: 110, notes: 'Replaced expansion vessel. Service complete.' },
                { date: '2022-11-15', type: 'Annual Maintenance', provider: 'HeatingPro Services', cost: 105, notes: 'Routine service. No issues found.' },
                { date: '2021-12-03', type: 'Repair', provider: 'Emergency Heating', cost: 180, notes: 'Pressure sensor replaced. System restored.' }
              ],
              knownIssues: [],
              manufacturerWarranty: 'Expired (2-year warranty ended 2020)',
              extendedWarranty: 'None',
              maintenanceContract: 'Annual service plan - renewed yearly',
              nextServiceDue: '2026-11-15',
              specifications: {
                dimensions: '440 x 720 x 360 mm (W x H x D)',
                weight: '35 kg',
                waterPressure: '1.0 - 1.5 bar',
                gasConnection: '1/2" BSP',
                flueType: 'Concentric 60/100mm',
                electricalSupply: '230V / 50Hz',
                maxFlowRate: '13.5 L/min @ 35°C rise',
                minFlowRate: '1.9 L/min'
              },
              safetyFeatures: [
                'Overheat protection',
                'Frost protection',
                'Air pressure sensor',
                'Flame supervision',
                'Low water pressure switch'
              ],
              accessories: [
                'Wireless room thermostat (VRT 350f)',
                'Filling loop',
                'Condensate trap',
                'Magnetic filter installed'
              ]
            },
            products: [],
            services: [
              {
                lineId: 'LINE-001',
                serviceOrderId: 'SRV-3344-01',
                code: 'MAINT-BOILER-ANNUAL',
                name: 'Annual Boiler Maintenance Service',
                description: 'Comprehensive annual maintenance service for gas boiler including inspection, cleaning, testing, and full diagnostic report. All parts and consumables included.',
                category: 'HVAC Maintenance',
                serviceType: 'Preventive Maintenance',
                quantity: 1,
                unitPrice: 120,
                discount: 0,
                tax: 27.60,
                totalPrice: 120,
                price: '120',
                scheduledDate: '2025-11-19',
                timeSlot: '10:00-12:00',
                duration: 90,
                techniciansRequired: 1,
                skillLevel: 'Certified Gas Engineer',
                equipmentNeeded: [
                  'Combustion analyzer',
                  'Pressure gauge',
                  'Multimeter',
                  'Cleaning brushes',
                  'Vacuum equipment',
                  'Leak detection fluid',
                  'Gas safety tools'
                ],
                safetyRequirements: [
                  'Gas Safe registered engineer',
                  'Carbon monoxide detector',
                  'Ventilation check',
                  'Gas leak testing',
                  'Safety valve testing',
                  'PPE required'
                ],
                workScope: [
                  'Visual inspection of boiler exterior and components',
                  'Heat exchanger inspection and cleaning',
                  'Combustion analysis (CO/CO2 levels)',
                  'Burner inspection and adjustment',
                  'Flue and ventilation check',
                  'Gas pressure and flow rate check',
                  'Safety device testing (overheat, pressure)',
                  'Condensate trap cleaning',
                  'Water pressure check and adjustment',
                  'Expansion vessel check',
                  'Magnetic filter inspection/cleaning',
                  'Thermostat calibration check',
                  'Full system diagnostic test',
                  'Customer handover with recommendations'
                ],
                partsIncluded: [
                  'Filter cartridge (if needed)',
                  'Seals and gaskets',
                  'Electrode cleaning materials',
                  'Cleaning chemicals',
                  'Condensate treatment tablets'
                ],
                deliverables: [
                  'Service completion certificate',
                  'Gas safety certificate',
                  'Combustion analysis report',
                  'Service checklist (signed)',
                  'Next service recommendation',
                  'Photos of work performed'
                ],
                providerBringsOwnParts: true,
                noProductDeliveryRequired: true,
                status: 'Scheduled'
              }
            ],
            totals: {
              subtotalProducts: 0,
              subtotalServices: 120,
              subtotal: 120,
              discounts: 0,
              taxProducts: 0,
              taxServices: 27.60,
              totalTax: 27.60,
              shippingCost: 0,
              total: 147.60,
              currency: 'EUR'
            },
            payment: {
              status: 'Pending',
              method: 'Direct Debit',
              customerOwes: 147.60,
              paidAmount: 0,
              paymentTrigger: 'Service completion + WCF signature',
              dueDate: '2025-11-30',
              transactionId: null,
              installments: 1,
              paymentTerms: 'Payment on completion - charged to saved payment method after work completion form signed'
            },
            provider: {
              providerId: 'PRV-HEAT-205',
              name: 'HeatingPro Services',
              category: 'HVAC Maintenance Specialist',
              specialization: 'Gas Boiler Service & Repair',
              rating: 4.8,
              completedJobs: 1247,
              certifications: ['Gas Safe Registered', 'Vaillant Approved', 'Worcester Accredited'],
              responseTime: '< 24 hours',
              partsInventory: 'Comprehensive - carries common parts',
              serviceArea: 'Greater Lisboa',
              emergencyService: true,
              languages: ['Portuguese', 'English']
            },
            linkedContracts: ['MAINT-CONTRACT-2025-4582'],
            linkedPreEstimation: null,
            linkedQuotation: null,
            contractType: 'Maintenance Service Agreement',
            recurringService: true,
            serviceFrequency: 'Annual',
            contractStartDate: '2018-03-15',
            contractRenewalDate: '2025-03-15',
            sellerNotes: 'Long-term customer with annual service plan. Same provider for 4 years - customer specifically requests HeatingPro. Access via building intercom. Customer usually at home in mornings.',
            internalNotes: 'NO PRODUCT DELIVERY - Provider brings all parts. NO GO EXEC GATE. Maintenance flow: Contract → Provider → Execution → WCF → Report → Payment. Asset details critical for crew. Service history shows consistent annual maintenance.',
            specialInstructions: 'MAINTENANCE WORKFLOW: (1) No product phase - skip Go Exec entirely. (2) Provider brings own parts inventory. (3) Must generate service report after WCF. (4) Payment only after WCF + report. (5) Customer prefers morning slots 10-12. (6) Boiler in kitchen utility cupboard - easy access. (7) Last service 1 year ago - routine maintenance expected.',
            operatorNotes: 'Customer has annual plan. HeatingPro is preferred provider - assign directly. Service straightforward. Generate certificate and report for customer records.',
            priority: 'Normal',
            tags: ['maintenance', 'hvac', 'boiler', 'annual-service', 'recurring', 'no-products', 'premium-customer', 'gas-safe']
          }
        },
        'depannage': {
          name: 'Dépannage - Emergency Service',
          description: 'Urgent same-day emergency service. Water heater failure requiring immediate replacement. Premium pricing for urgency, expedited workflow, emergency provider network.',
          salesOrder: {
            orderId: 'SO-2025-DEP-7721',
            soId: 'SO-2025-DEP-7721',
            salesChannel: 'Web Portal',
            store: 'YellowGrid Online Store',
            storeCode: 'WEB-SHOP-001',
            orderType: 'depannage',
            serviceType: 'Urgent Service - Dépannage',
            urgencyLevel: 'High',
            responseWindow: '4 hours',
            orderDate: '2025-11-16T18:35:00Z',
            confirmationDate: '2025-11-16T18:37:22Z',
            slaCommitment: 'First technician response within 15 minutes, service within 4 hours',
            expeditedProcess: true,
            customer: {
              customerId: 'CUST-9934',
              name: 'Maria Santos',
              firstName: 'Maria',
              lastName: 'Santos',
              email: 'maria.santos@email.pt',
              phone: '+351 913 887 432',
              alternatePhone: '+351 217 334 221',
              addressLine1: 'Rua dos Navegantes, 78',
              addressLine2: '2º Andar, Porta C',
              address: 'Rua dos Navegantes, 78, 2º Andar, 2750-345 Cascais',
              city: 'Cascais',
              postalCode: '2750-345',
              region: 'Lisboa',
              country: 'Portugal',
              customerSince: '2020-05-12',
              tier: 'Standard',
              claimHistory: 0,
              lifetimeValue: 890,
              preferredContact: 'phone',
              language: 'pt-PT',
              propertyType: 'Apartment',
              familySize: 4,
              urgentSituation: 'Family with 2 young children - no hot water',
              purchaseChannel: 'Web - Urgent Service Request',
              purchaseDate: '2025-11-16T18:35:00Z'
            },
            urgentServiceRequest: {
              issueType: 'Gas Water Heater Failure',
              severity: 'High',
              impact: 'No hot water for family of 4',
              description: 'Gas water heater completely stopped working. No hot water at all. We have two young kids who need bathing. Tried resetting but nothing works. Need urgent help today!',
              requestedService: 'Water Heater Repair or Replacement',
              preferredTimeframe: 'Same day / ASAP',
              submittedAt: '2025-11-16T18:35:00Z',
              timeOfDay: 'Saturday Evening',
              isWeekend: true,
              weatherCondition: 'Cold weather (12°C)',
              urgencyReason: 'Young children need hot water - weekend cold weather'
            },
            failedAsset: {
              assetType: 'Gas Water Heater',
              brand: 'Junkers',
              model: 'WR 11-2B',
              age: '11 years',
              capacity: '11 liters/min',
              fuelType: 'Natural Gas',
              condition: 'Failed - beyond economical repair',
              issue: 'Complete failure - ignition system dead, multiple faults',
              lastService: '2022-11-10',
              repairViable: false,
              replacementRecommended: true
            },
            products: [
              {
                lineId: 'LINE-EMRG-001',
                sku: 'WH-GAS-14L-EMRG',
                name: 'Gas Instantaneous Water Heater 14L',
                brand: 'Vaillant',
                model: 'MAG 14-2/0 XZ',
                category: 'Water Heaters',
                quantity: 1,
                unitPrice: 420,
                discount: 0,
                tax: 96.60,
                totalPrice: 420,
                emergencyStockPremium: 30,
                basePrice: 390,
                supplier: 'Emergency Stock - Provider Inventory',
                stockStatus: 'Provider Van Stock',
                deliveryDate: 'Same day - carried by technician',
                estimatedArrival: '45 minutes',
                deliveryMethod: 'Emergency Provider Stock',
                warranty: '24 months manufacturer + 12 months installation',
                specifications: {
                  capacity: '14 liters/min',
                  power: '24 kW',
                  efficiency: 'A-rated',
                  fuelType: 'Natural Gas',
                  dimensions: '580 x 330 x 220 mm',
                  weight: '12.5 kg'
                }
              }
            ],
            services: [
              {
                lineId: 'LINE-EMRG-002',
                serviceOrderId: 'SRV-EMRG-7721-01',
                code: 'EMRG-WH-REPLACE',
                name: 'Emergency Water Heater Replacement',
                description: 'Emergency removal of failed unit and installation of new gas instantaneous water heater. Includes gas connection, water connections, testing, and certification.',
                category: 'Emergency Plumbing',
                serviceType: 'Emergency Replacement',
                quantity: 1,
                unitPrice: 150,
                discount: 0,
                tax: 34.50,
                totalPrice: 150,
                basePrice: 120,
                urgencyFee: 30,
                urgencyPercentage: 25,
                emergencyCallout: 60,
                scheduledDate: '2025-11-16',
                timeSlot: '19:30-22:00',
                estimatedArrival: '19:30',
                duration: 120,
                techniciansRequired: 1,
                skillLevel: 'Gas Safe Engineer',
                equipmentNeeded: [
                  'Gas testing equipment',
                  'Pipe wrenches',
                  'Power drill',
                  'Leak detection fluid',
                  'Safety equipment',
                  'Basic plumbing tools'
                ],
                safetyRequirements: [
                  'Gas Safe registered engineer mandatory',
                  'Gas isolation and testing',
                  'Carbon monoxide detector',
                  'Ventilation check',
                  'Pressure testing required',
                  'Safety certification issued'
                ],
                workScope: [
                  'Isolate gas supply and water',
                  'Remove failed water heater',
                  'Prepare mounting area',
                  'Install new water heater unit',
                  'Connect gas pipe (test for leaks)',
                  'Connect cold water inlet',
                  'Connect hot water outlet',
                  'Test all connections',
                  'Light and adjust burner',
                  'Test hot water flow all taps',
                  'Gas pressure and combustion test',
                  'Issue gas safety certificate',
                  'Customer instruction and handover'
                ],
                emergencyFeatures: [
                  'Same-day service guarantee',
                  'Weekend/after-hours availability',
                  'Provider carries replacement units',
                  'Fast-track priority dispatch',
                  'Immediate response commitment'
                ]
              }
            ],
            totals: {
              subtotalProducts: 420,
              subtotalServices: 150,
              emergencyCallout: 60,
              subtotal: 630,
              discounts: 0,
              taxProducts: 96.60,
              taxServices: 34.50,
              taxEmergencyCallout: 13.80,
              totalTax: 144.90,
              shippingCost: 0,
              total: 774.90,
              currency: 'EUR',
              breakdown: {
                waterHeaterUnit: 420,
                installation: 150,
                emergencyCallout: 60,
                urgencyPremium: 30,
                baseCostEquivalent: 630,
                emergencyMarkup: 144.90
              }
            },
            financials: {
              customerPayment: 774.90,
              customerPaymentReason: 'Paid to retailer at purchase (web portal) - expedited service with urgency premium',
              providerPayment: 620.90,
              providerPaymentReason: 'Emergency response service: €420 product + €150 service + €60 emergency callout - platform fee',
              paymentCondition: 'emergency-service',
              platformFee: 154,
              platformFeeReason: 'Standard 20% platform fee on total provider amount (€774.90 × 20% = €154.90 minus €0.90 adjustment)',
              providerBreakdown: {
                productCost: 420,
                serviceCost: 150,
                emergencyCallout: 60,
                subtotal: 630,
                urgencyPremium: 30,
                tax: 144.90,
                gross: 774.90,
                platformFee: 154,
                netToProvider: 620.90
              }
            },
            payment: {
              customerPaidRetailer: true,
              customerPaymentTiming: 'At purchase (web portal)',
              retailerPaidAmount: 774.90,
              platformPaysProvider: true,
              platformPaymentTiming: 'After service completion',
              providerWillReceive: 620.90,
              paymentNote: 'B2B Model: Customer → Retailer (at purchase) | Platform → Provider (after completion) | NO direct customer-provider payment'
            },
            providerBidding: {
              biddingType: 'Multi-Provider Expedited',
              providersContacted: 5,
              firstToAcceptWins: true,
              offerWithdrawalOnAcceptance: true,
              timeLimit: '15 minutes',
              providers: [
                {
                  providerId: 'PRV-EMRG-089',
                  name: 'EmergencyPlumb 24/7',
                  contacted: '2025-11-16T18:38:15Z',
                  response: 'Accepted',
                  responseTime: '3 minutes 12 seconds',
                  acceptedAt: '2025-11-16T18:41:27Z',
                  status: 'Winner - Assigned',
                  estimatedArrival: '45 minutes',
                  distanceFromCustomer: '8.3 km'
                },
                {
                  providerId: 'PRV-PLUMB-142',
                  name: 'QuickFix Plumbing',
                  contacted: '2025-11-16T18:38:15Z',
                  response: 'Offer Withdrawn',
                  responseTime: 'N/A - Too late',
                  status: 'Offer automatically withdrawn after first acceptance',
                  distanceFromCustomer: '11.2 km'
                },
                {
                  providerId: 'PRV-HOME-087',
                  name: 'HomeService Pro',
                  contacted: '2025-11-16T18:38:15Z',
                  response: 'Declined',
                  responseTime: '5 minutes',
                  declineReason: 'No gas water heater stock available',
                  status: 'Declined',
                  distanceFromCustomer: '6.7 km'
                },
                {
                  providerId: 'PRV-URGENT-034',
                  name: 'UrgentCare Home Services',
                  contacted: '2025-11-16T18:38:15Z',
                  response: 'No Response',
                  responseTime: 'N/A',
                  status: 'Timeout - No response',
                  distanceFromCustomer: '9.8 km'
                },
                {
                  providerId: 'PRV-TECH-156',
                  name: 'TechResponse Solutions',
                  contacted: '2025-11-16T18:38:15Z',
                  response: 'Offer Withdrawn',
                  responseTime: 'N/A - Too late',
                  status: 'Offer automatically withdrawn after first acceptance',
                  distanceFromCustomer: '14.1 km'
                }
              ],
              winningProvider: 'EmergencyPlumb 24/7',
              assignmentTime: '2025-11-16T18:41:27Z',
              totalElapsedTime: '3 minutes 12 seconds from dispatch to assignment'
            },
            providerInvoice: {
              invoiceNumber: 'INV-DEP-2025-11-4789',
              invoiceType: 'Pro Forma',
              issueDate: '2025-11-16T22:05:00Z',
              dueDate: '2025-11-23T23:59:59Z',
              paymentTerms: 'Net 7 days',
              lineItems: [
                { description: 'Water Heater Emergency Replacement', quantity: 1, unitPrice: 420, amount: 420 },
                { description: 'Installation Service', quantity: 1, unitPrice: 150, amount: 150 },
                { description: 'Emergency Callout Fee', quantity: 1, unitPrice: 60, amount: 60 }
              ],
              subtotal: 630,
              platformFee: -154,
              netAmount: 476,
              tax: 144.90,
              totalDue: 620.90,
              currency: 'EUR',
              status: 'Pending Provider Acceptance'
            },
            provider: {
              providerId: 'PRV-EMRG-089',
              name: 'EmergencyPlumb 24/7',
              category: 'Urgent Plumbing Specialist',
              specialization: 'Water Heater Urgent Service',
              assignmentMethod: 'First-to-accept bidding (winner of 5-provider dispatch)',
              rating: 4.7,
              completedJobs: 823,
              urgentJobs: 412,
              certifications: ['Gas Safe Registered', 'Emergency Response Certified', 'Vaillant Approved'],
              responseTime: '< 1 hour',
              availability: '24/7/365',
              currentLocation: 'Oeiras (15 min from customer)',
              estimatedArrival: '19:30',
              emergencyStock: true,
              stockItems: ['Water heaters (gas/electric)', 'Boilers', 'Emergency plumbing parts'],
              vanEquipped: true,
              languages: ['Portuguese', 'English'],
              emergencyRating: 4.8,
              averageResponseTime: '42 minutes'
            },
            linkedContracts: [],
            linkedPreEstimation: null,
            linkedQuotation: null,
            emergencyProtocol: 'URGENT-FAMILY-IMPACT',
            slaCommitment: 'Response within 4 hours',
            sellerNotes: 'DÉPANNAGE SERVICE PURCHASED ONLINE - Family of 4 without hot water on cold weekend evening. Customer purchased urgent service from RETAILER via web portal (€774.90 paid to retailer). System dispatched to 5 eligible providers simultaneously. EmergencyPlumb accepted first (3min 12sec). Provider has gas water heater in van. ETA 45 min. Platform will pay provider €620.90 after completion.',
            internalNotes: 'DÉPANNAGE WORKFLOW: (1) Customer purchases urgent service from RETAILER online (€774.90). (2) Kafka message received from sales system. (3) AI enrichment and SO creation. (4) Operator triages and confirms HIGH urgency. (5) System dispatches to 5 providers SIMULTANEOUSLY. (6) First to accept wins (EmergencyPlumb - 3min 12sec). (7) Offers automatically withdrawn from other 4 providers. (8) Provider dispatched with stock. (9) On-site work and WCF. (10) Provider invoice submitted. (11) Platform pays provider €620.90 after completion.',
            specialInstructions: 'DÉPANNAGE RULES: (1) Always starts with SALE to RETAILER (web/store purchase). (2) Multi-provider dispatch (up to 5 eligible). (3) First to accept wins assignment. (4) Offers withdrawn from others immediately. (5) Speed is critical. (6) B2B PAYMENT: Customer → Retailer (€774.90 at purchase) | Platform → Provider (€620.90 after completion) | NO direct customer-provider payment. Building code: 2789. Apartment 2C.',
            operatorNotes: 'Customer purchased Dépannage service from RETAILER online at 18:35 (€774.90 paid). System sent to 5 providers at 18:38:15. EmergencyPlumb accepted at 18:41:27 (fastest response). Other offers auto-withdrawn. Provider has Vaillant 14L in van. ETA 45 min. Customer informed via SMS. Platform will pay provider €620.90 after completion.',
            priority: 'URGENT',
            tags: ['emergency', 'depannage', 'water-heater', 'same-day', 'family-impact', 'weekend', 'after-hours', 'gas-safe', 'urgent', 'premium-pricing']
          }
        },
        'subscription': {
          name: 'Subscription - Recurring Service Contract',
          description: 'Quarterly AC maintenance subscription. Customer pays recurring monthly fee for scheduled preventive maintenance. Auto-scheduling, priority service, discount benefits.',
          salesOrder: {
            orderId: 'SO-2025-SUB-4421',
            soId: 'SO-2025-SUB-4421',
            salesChannel: 'Subscription Portal',
            store: 'YellowGrid Subscriptions',
            storeCode: 'SUB-001',
            orderType: 'subscription',
            subscriptionId: 'SUB-2025-4421',
            subscriptionTier: 'Standard',
            orderDate: '2025-03-01T10:15:00Z',
            confirmationDate: '2025-03-01T10:18:45Z',
            serviceVisitNumber: 3,
            totalVisitsInContract: 4,
            customer: {
              customerId: 'CUST-5512',
              name: 'Pedro Alves',
              firstName: 'Pedro',
              lastName: 'Alves',
              email: 'pedro.alves@company.pt',
              phone: '+351 918 234 567',
              alternatePhone: '+351 213 445 678',
              addressLine1: 'Avenida 25 de Abril, 142',
              addressLine2: '5º Andar, Apartamento 52',
              address: 'Avenida 25 de Abril, 142, 5º Andar, 2795-195 Linda-a-Velha',
              city: 'Linda-a-Velha',
              postalCode: '2795-195',
              region: 'Lisboa',
              country: 'Portugal',
              customerSince: '2022-06-10',
              tier: 'Premium',
              claimHistory: 0,
              lifetimeValue: 1240,
              preferredContact: 'email',
              language: 'pt-PT',
              propertyType: 'Apartment',
              propertySize: '110m²',
              subscriptionMember: true,
              subscriptionStartDate: '2025-03-01',
              subscriptionStatus: 'Active',
              autoRenewal: true
            },
            subscription: {
              subscriptionId: 'SUB-2025-4421',
              planName: 'Standard AC Maintenance',
              tier: 'Standard',
              frequency: 'Quarterly',
              monthlyFee: 16.99,
              annualValue: 203.88,
              billingCycle: 'Monthly',
              paymentMethod: 'Direct Debit',
              startDate: '2025-03-01',
              nextBillingDate: '2025-12-01',
              renewalDate: '2026-03-01',
              status: 'Active',
              servicesPerYear: 4,
              servicesCompleted: 2,
              servicesRemaining: 2,
              nextServiceDue: '2025-12-15',
              preferredDay: 'Saturday',
              preferredTime: '09:00-12:00',
              benefits: [
                '4 maintenance visits per year (quarterly)',
                'Priority emergency response',
                '15% discount on repairs',
                'Free filter replacements',
                'Same technician when possible',
                'Auto-scheduling with reminders',
                'Service history tracking',
                'Equipment health monitoring'
              ],
              cancellationPolicy: '30-day notice required',
              priceGuarantee: 'Rate locked until March 2026',
              contractDuration: '12 months (auto-renew)'
            },
            assets: [
              {
                assetId: 'ASSET-2022-5512-AC1',
                assetType: 'Split AC System',
                category: 'HVAC',
                brand: 'Daikin',
                model: 'Sensira FTXF35A',
                serialNumber: 'DKN-2022-551234',
                installationDate: '2022-06-15',
                yearsInService: 3,
                capacity: '3.5 kW (12,000 BTU)',
                refrigerant: 'R32',
                energyRating: 'A++',
                location: 'Living room',
                indoorUnits: 1,
                outdoorUnits: 1,
                currentStatus: 'Operational',
                lastServiceDate: '2025-09-15',
                serviceHistory: [
                  { date: '2025-09-15', type: 'Quarterly Maintenance', provider: 'ClimaPro', findings: 'All OK', cost: 'Subscription' },
                  { date: '2025-06-10', type: 'Quarterly Maintenance', provider: 'ClimaPro', findings: 'Filter replaced', cost: 'Subscription' }
                ],
                nextServiceDue: '2025-12-15',
                maintenanceSchedule: 'March, June, September, December',
                healthScore: 92,
                conditionTrend: 'Stable',
                recommendedActions: ['Continue regular maintenance', 'Consider coil deep clean in 2026']
              }
            ],
            products: [],
            services: [
              {
                lineId: 'LINE-SUB-001',
                serviceOrderId: 'SRV-SUB-4421-Q3',
                code: 'SUB-AC-QUARTERLY',
                name: 'Quarterly AC Maintenance (Q4 2025)',
                description: 'Comprehensive quarterly maintenance service for split AC system. Included in Standard subscription plan.',
                category: 'HVAC Subscription Maintenance',
                serviceType: 'Preventive Maintenance - Quarterly',
                quantity: 1,
                unitPrice: 0,
                discount: 0,
                tax: 0,
                totalPrice: 0,
                valueIfNotSubscribed: 60,
                subscriptionCovered: true,
                scheduledDate: '2025-12-14',
                timeSlot: '09:00-11:00',
                duration: 90,
                techniciansRequired: 1,
                skillLevel: 'AC Maintenance Specialist',
                equipmentNeeded: [
                  'Vacuum cleaner',
                  'Coil cleaning solution',
                  'Pressure gauge',
                  'Thermometer',
                  'Multi meter',
                  'Filters (if needed)',
                  'Cleaning tools'
                ],
                safetyRequirements: [
                  'Power isolation',
                  'Ladder safety',
                  'Chemical handling PPE',
                  'Refrigerant handling certification'
                ],
                workScope: [
                  'Indoor unit filter inspection and cleaning',
                  'Evaporator coil inspection',
                  'Condensate drain check and cleaning',
                  'Indoor fan motor check',
                  'Outdoor unit inspection',
                  'Condenser coil cleaning (external)',
                  'Compressor operation check',
                  'Refrigerant pressure check',
                  'Electrical connections inspection',
                  'Thermostat calibration check',
                  'Air flow performance test',
                  'System efficiency test',
                  'Filter replacement (if needed)',
                  'Service record update in system'
                ],
                subscriptionFeatures: [
                  'Service included in monthly fee',
                  'Same technician (relationship continuity)',
                  'Service history tracked',
                  'Proactive scheduling',
                  'Priority booking',
                  'Free filter if replacement needed'
                ],
                visitNumber: 3,
                previousVisit: '2025-09-15',
                nextScheduledVisit: '2026-03-15'
              }
            ],
            totals: {
              subtotalProducts: 0,
              subtotalServices: 0,
              subtotal: 0,
              discounts: 0,
              taxProducts: 0,
              taxServices: 0,
              totalTax: 0,
              shippingCost: 0,
              total: 0,
              currency: 'EUR',
              subscriptionNote: 'Service covered by monthly subscription fee (€16.99/month). No additional charge for this visit.'
            },
            financials: {
              customerPayment: 0,
              customerPaymentReason: 'Service covered by monthly subscription fee €16.99 - no additional charge',
              providerPayment: 48,
              providerPaymentReason: 'Quarterly maintenance service - subscription payout model',
              paymentCondition: 'subscription-service',
              platformFee: 12,
              platformFeeReason: '20% platform fee on provider payout (€60 standard rate - €12 fee = €48 net)',
              providerBreakdown: {
                standardServiceRate: 60,
                platformFee: 12,
                netToProvider: 48
              },
              subscriptionEconomics: {
                monthlyCustomerPayment: 16.99,
                annualCustomerPayment: 203.88,
                servicesPerYear: 4,
                annualProviderPayout: 192,
                annualPlatformRevenue: 48,
                customerSavings: 36.12
              }
            },
            payment: {
              status: 'Paid via Subscription',
              method: 'Subscription Plan',
              billingMethod: 'Direct Debit',
              monthlyFee: 16.99,
              lastChargeDate: '2025-11-01',
              lastChargeAmount: 16.99,
              nextChargeDate: '2025-12-01',
              subscriptionActive: true,
              serviceIncluded: true,
              additionalCharges: 0,
              paymentTerms: 'Covered by active Standard subscription. Monthly fee: €16.99'
            },
            providerInvoice: {
              invoiceNumber: 'INV-SUB-2025-12-4421-Q4',
              invoiceType: 'Pro Forma',
              issueDate: '2025-12-15T18:30:00Z',
              dueDate: '2025-12-22T23:59:59Z',
              paymentTerms: 'Net 7 days',
              lineItems: [
                { description: 'Quarterly AC Maintenance (Q4 2025)', quantity: 1, unitPrice: 60, amount: 60 }
              ],
              subtotal: 60,
              platformFee: -12,
              netAmount: 48,
              tax: 0,
              totalDue: 48,
              currency: 'EUR',
              status: 'Pending Provider Acceptance',
              subscriptionNote: 'Service performed under subscription contract SUB-2025-4421. Customer billed monthly at €16.99. Provider receives per-service payout.'
            },
            provider: {
              providerId: 'PRV-CLIMA-142',
              name: 'ClimaPro Services',
              category: 'HVAC Maintenance Specialist',
              specialization: 'AC System Maintenance',
              rating: 4.8,
              completedJobs: 1156,
              subscriptionJobs: 487,
              certifications: ['F-Gas Certified', 'Daikin Approved', 'AC Excellence Partner'],
              responseTime: '< 48 hours',
              assignedTechnician: 'Carlos Mendes',
              technicianRating: 4.9,
              customerRelationship: 'Established - 2 previous visits',
              subscriptionSpecialist: true,
              languages: ['Portuguese', 'English']
            },
            linkedContracts: ['SUB-CONTRACT-2025-4421'],
            linkedPreEstimation: null,
            linkedQuotation: null,
            subscriptionContract: 'SUB-CONTRACT-2025-4421',
            autoScheduled: true,
            remindersSent: ['2025-11-30 (2 weeks)', '2025-12-11 (3 days)'],
            customerConfirmed: true,
            confirmationDate: '2025-12-11T14:22:00Z',
            sellerNotes: 'Subscription customer - Standard plan active since March 2025. This is 3rd quarterly visit. Customer confirmed preferred Saturday morning slot. Same technician (Carlos) assigned for continuity. Customer very satisfied with service so far.',
            internalNotes: 'SUBSCRIPTION WORKFLOW: (1) Auto-scheduled 3 months after last visit. (2) Reminder sent 2 weeks before. (3) Customer confirmed date/time. (4) Assigned same technician (Carlos). (5) Service covered by subscription. (6) After service, next visit auto-scheduled for March 2026. (7) Health score and findings tracked for longitudinal insights.',
            specialInstructions: 'SUBSCRIPTION RULES: (1) Service covered by monthly fee - no payment this visit. (2) Same technician when possible (relationship). (3) Auto-schedule next visit after completion. (4) Track asset health score. (5) If repairs needed, customer gets 15% subscription discount. (6) Service report sent via email + app. (7) Building has elevator. Apartment 52, 5th floor. Customer prefers morning appointments.',
            operatorNotes: 'Customer very happy with subscription. Mentioned AC running much better since regular maintenance started. Technician Carlos built good relationship. Customer considering upgrading to Premium tier to add 2nd AC unit coverage. Good renewal candidate.',
            priority: 'Normal',
            tags: ['subscription', 'recurring', 'hvac', 'ac-maintenance', 'quarterly', 'preventive', 'auto-scheduled', 'relationship', 'premium-customer', 'standard-tier']
          }
        }
      };

      // Workflow steps
      const steps = [
        {
          id: 'integration',
          name: 'Sales Integration',
          stakeholder: 'system',
          description: 'Kafka message from sales system'
        },
        {
          id: 'ai-analysis',
          name: 'AI Analysis',
          stakeholder: 'system',
          description: 'Enrichment and automation'
        },
        {
          id: 'operator-triage',
          name: 'Operator Triage',
          stakeholder: 'operator',
          description: 'Risk assessment and planning'
        },
        {
          id: 'contract',
          name: 'Contract',
          stakeholder: 'operator',
          description: 'Bundle and send contract'
        },
        {
          id: 'provider-match',
          name: 'Provider Matching',
          stakeholder: 'provider',
          description: 'Crew assignment and negotiation'
        },
        {
          id: 'go-gate',
          name: 'Go Execution',
          stakeholder: 'operator',
          description: 'Payment & delivery gate'
        },
        {
          id: 'execution',
          name: 'Execution',
          stakeholder: 'crew',
          description: 'On-site service delivery'
        },
        {
          id: 'wcf',
          name: 'WCF',
          stakeholder: 'customer',
          description: 'Customer acceptance'
        }
      ];

      let currentScenario = null;
      let currentStep = 0;

      const renderDataFlow = () => {
        if (!currentScenario) return;
        
        const so = scenarios[currentScenario].salesOrder;
        const step = steps[currentStep];

        let html = '';

        if (step.id === 'integration') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-satellite-dish"></i>
                </div>
                <div class="stage-title">
                  <h3>Kafka Message Received</h3>
                  <span>From ${so.salesChannel} • ${so.store}</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"orderId"</span>: <span class="string">"${so.orderId}"</span>,
  <span class="key">"channel"</span>: <span class="string">"${so.salesChannel}"</span>,
  <span class="key">"store"</span>: <span class="string">"${so.store}"</span>,
  <span class="key">"salesProjectId"</span>: <span class="string">"${so.salesProjectId}"</span>,
  <span class="key">"leadId"</span>: <span class="string">"${so.leadId}"</span>,
  <span class="key">"salesman"</span>: <span class="string">"${so.salesman}"</span>,
  <span class="key">"customer"</span>: {
    <span class="key">"name"</span>: <span class="string">"${so.customer.name}"</span>,
    <span class="key">"email"</span>: <span class="string">"${so.customer.email}"</span>,
    <span class="key">"phone"</span>: <span class="string">"${so.customer.phone}"</span>,
    <span class="key">"address"</span>: <span class="string">"${so.customer.address}"</span>,
    <span class="key">"tier"</span>: <span class="string">"${so.customer.tier}"</span>,
    <span class="key">"claimHistory"</span>: <span class="value">${so.customer.claimHistory}</span>
  },
  <span class="key">"products"</span>: [${so.products.map(p => `
    {
      <span class="key">"sku"</span>: <span class="string">"${p.sku}"</span>,
      <span class="key">"name"</span>: <span class="string">"${p.name}"</span>,
      <span class="key">"quantity"</span>: <span class="value">${p.quantity}</span>,
      <span class="key">"unitPrice"</span>: <span class="value">${p.unitPrice}</span>,
      <span class="key">"deliveryDate"</span>: <span class="string">"${p.deliveryDate}"</span>
    }`).join(',')}
  ],
  <span class="key">"services"</span>: [${so.services.map(s => `
    {
      <span class="key">"code"</span>: <span class="string">"${s.code}"</span>,
      <span class="key">"name"</span>: <span class="string">"${s.name}"</span>,
      <span class="key">"scheduledDate"</span>: <span class="string">"${s.scheduledDate}"</span>,
      <span class="key">"timeSlot"</span>: <span class="string">"${s.timeSlot}"</span>
    }`).join(',')}
  ],
  <span class="key">"payment"</span>: {
    <span class="key">"status"</span>: <span class="string">"${so.payment.status}"</span>,
    <span class="key">"method"</span>: <span class="string">"${so.payment.method}"</span>,
    <span class="key">"total"</span>: <span class="value">${so.totals.total}</span>
  },
  <span class="key">"linkedQuotation"</span>: ${so.linkedQuotation ? `<span class="string">"${so.linkedQuotation}"</span>` : '<span class="value">null</span>'},
  <span class="key">"sellerNotes"</span>: <span class="string">"${so.sellerNotes}"</span>
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'ai-analysis') {
          const riskLevel = so.customer.claimHistory > 0 || so.linkedQuotation ? 'MEDIUM' : 'LOW';
          const tvPotential = so.linkedQuotation || so.sellerNotes.includes('upsell') ? 'HIGH' : 'LOW';
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-brain"></i>
                </div>
                <div class="stage-title">
                  <h3>AI Enrichment Output</h3>
                  <span>Computed fields added to service order</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"serviceOrderId"</span>: <span class="string">"SRV-${so.orderId.split('-')[2]}"</span>,
  <span class="key">"linkedSalesOrder"</span>: <span class="string">"${so.orderId}"</span>,
  <span class="key">"aiEnrichment"</span>: {
    <span class="key">"riskScore"</span>: <span class="value">${riskLevel === 'LOW' ? '23' : '67'}</span>,
    <span class="key">"riskLevel"</span>: <span class="string">"${riskLevel}"</span>,
    <span class="key">"riskFactors"</span>: [${riskLevel === 'MEDIUM' ? '"Previous claim", "Linked quotation"' : '"New customer", "Low complexity"'}],
    <span class="key">"tvPotential"</span>: <span class="string">"${tvPotential}"</span>,
    <span class="key">"tvReason"</span>: <span class="string">"${tvPotential === 'HIGH' ? 'Seller notes indicate upsell opportunity' : 'Single product, limited scope'}"</span>,
    <span class="key">"suggestedProject"</span>: ${so.salesProjectId ? `<span class="string">"${so.salesProjectId}"</span>` : '<span class="value">null</span>'},
    <span class="key">"suggestedPilote"</span>: <span class="string">"PL-LIA"</span>,
    <span class="key">"piloteReason"</span>: <span class="string">"Lowest workload (3 active orders)"</span>
  }
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'operator-triage') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="stage-title">
                  <h3>Operator Actions Logged</h3>
                  <span>Control Tower updates</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"serviceOrderId"</span>: <span class="string">"SRV-${so.orderId.split('-')[2]}"</span>,
  <span class="key">"operatorActions"</span>: {
    <span class="key">"triageTimestamp"</span>: <span class="string">"2025-11-16T14:22:18Z"</span>,
    <span class="key">"operatorId"</span>: <span class="string">"OP-MARIA"</span>,
    <span class="key">"riskOverride"</span>: <span class="value">false</span>,
    <span class="key">"scheduleValidated"</span>: <span class="value">true</span>,
    <span class="key">"projectLinked"</span>: <span class="string">"${so.salesProjectId}"</span>,
    <span class="key">"piloteAssigned"</span>: <span class="string">"PL-LIA"</span>,
    <span class="key">"notes"</span>: <span class="string">"AI suggestions accepted. Schedule compliant with calendar rules."</span>
  }
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'contract') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-file-signature"></i>
                </div>
                <div class="stage-title">
                  <h3>Contract Bundle Created</h3>
                  <span>Sent to customer for signature</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"contractId"</span>: <span class="string">"CTR-2025-${Math.floor(Math.random()*9000)+1000}"</span>,
  <span class="key">"bundledOrders"</span>: [<span class="string">"SRV-${so.orderId.split('-')[2]}"</span>],
  <span class="key">"template"</span>: <span class="string">"Standard Installation"</span>,
  <span class="key">"totalValue"</span>: <span class="value">${so.totals.services}</span>,
  <span class="key">"status"</span>: <span class="string">"SENT"</span>,
  <span class="key">"sentAt"</span>: <span class="string">"2025-11-16T14:25:03Z"</span>,
  <span class="key">"autoSendDelay"</span>: <span class="value">7200</span>,
  <span class="key">"customerContact"</span>: {
    <span class="key">"email"</span>: <span class="string">"${so.customer.email}"</span>,
    <span class="key">"phone"</span>: <span class="string">"${so.customer.phone}"</span>
  }
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'provider-match') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-handshake"></i>
                </div>
                <div class="stage-title">
                  <h3>Provider Crews Matched</h3>
                  <span>3 crews notified • 4h response window</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"matchingRound"</span>: <span class="value">1</span>,
  <span class="key">"crews"</span>: [
    {
      <span class="key">"crewId"</span>: <span class="string">"CREW-A-01"</span>,
      <span class="key">"provider"</span>: <span class="string">"Provider L"</span>,
      <span class="key">"lead"</span>: <span class="string">"Rui Lopes"</span>,
      <span class="key">"capacity"</span>: <span class="string">"2 installers"</span>,
      <span class="key">"matchScore"</span>: <span class="value">92</span>,
      <span class="key">"sla"</span>: <span class="string">"T+48h"</span>,
      <span class="key">"responseDeadline"</span>: <span class="string">"2025-11-16T18:30:00Z"</span>
    },
    {
      <span class="key">"crewId"</span>: <span class="string">"CREW-B-03"</span>,
      <span class="key">"provider"</span>: <span class="string">"Provider F"</span>,
      <span class="key">"matchScore"</span>: <span class="value">85</span>
    }
  ],
  <span class="key">"negotiationLimit"</span>: <span class="value">3</span>
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'go-gate') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-shield"></i>
                </div>
                <div class="stage-title">
                  <h3>Go Execution Gate</h3>
                  <span>Prerequisites validation</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"serviceOrderId"</span>: <span class="string">"SRV-${so.orderId.split('-')[2]}"</span>,
  <span class="key">"gateChecks"</span>: {
    <span class="key">"paymentReceived"</span>: <span class="value">${so.payment.status === 'Paid' ? 'true' : 'false'}</span>,
    <span class="key">"deliveryConfirmed"</span>: <span class="value">true</span>,
    <span class="key">"contractSigned"</span>: <span class="value">true</span>,
    <span class="key">"crewAssigned"</span>: <span class="value">true</span>,
    <span class="key">"gateStatus"</span>: <span class="string">"${so.payment.status === 'Paid' ? 'GO' : 'BLOCKED'}"</span>
  },
  <span class="key">"validatedAt"</span>: <span class="string">"2025-11-17T20:00:00Z"</span>,
  <span class="key">"derogation"</span>: ${so.payment.status !== 'Paid' ? '<span class="value">true</span>' : '<span class="value">false</span>'}
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'execution') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-screwdriver-wrench"></i>
                </div>
                <div class="stage-title">
                  <h3>Execution Evidence</h3>
                  <span>Crew mobile app data</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"checkin"</span>: {
    <span class="key">"timestamp"</span>: <span class="string">"2025-11-18T09:03:22Z"</span>,
    <span class="key">"location"</span>: {
      <span class="key">"lat"</span>: <span class="value">38.7223</span>,
      <span class="key">"lon"</span>: <span class="value">-9.1393</span>
    },
    <span class="key">"crewLead"</span>: <span class="string">"Rui Lopes"</span>
  },
  <span class="key">"checklist"</span>: {
    <span class="key">"completed"</span>: <span class="value">4</span>,
    <span class="key">"total"</span>: <span class="value">4</span>
  },
  <span class="key">"evidence"</span>: {
    <span class="key">"photos"</span>: <span class="value">3</span>,
    <span class="key">"audioNotes"</span>: <span class="value">1</span>
  },
  <span class="key">"completedAt"</span>: <span class="string">"2025-11-18T10:47:15Z"</span>
}</pre>
              </div>
            </div>
          `;
        } else if (step.id === 'wcf') {
          html = `
            <div class="data-flow-stage active">
              <div class="stage-header">
                <div class="stage-icon active">
                  <i class="fas fa-user-check"></i>
                </div>
                <div class="stage-title">
                  <h3>WCF (Customer Acceptance)</h3>
                  <span>Final outcome</span>
                </div>
              </div>
              <div class="data-payload">
<pre>{
  <span class="key">"wcfId"</span>: <span class="string">"WCF-${Math.floor(Math.random()*9000)+1000}"</span>,
  <span class="key">"serviceOrderId"</span>: <span class="string">"SRV-${so.orderId.split('-')[2]}"</span>,
  <span class="key">"outcome"</span>: <span class="string">"SIGNED_NO_RESERVES"</span>,
  <span class="key">"signedAt"</span>: <span class="string">"2025-11-18T10:52:33Z"</span>,
  <span class="key">"signatureMethod"</span>: <span class="string">"Digital (Mobile App)"</span>,
  <span class="key">"customerNotes"</span>: <span class="string">"Perfect installation, crew very professional"</span>,
  <span class="key">"paymentRelease"</span>: {
    <span class="key">"status"</span>: <span class="string">"AUTHORIZED"</span>,
    <span class="key">"providerAmount"</span>: <span class="value">${so.totals.services * 0.75}</span>,
    <span class="key">"releaseDate"</span>: <span class="string">"2025-11-19"</span>
  }
}</pre>
              </div>
            </div>
          `;
        }

        document.getElementById('dataFlowPanel').innerHTML = html;
      };

      const renderStakeholderView = () => {
        if (!currentScenario) return;
        
        const so = scenarios[currentScenario].salesOrder;
        const step = steps[currentStep];

        let html = '';

        if (step.id === 'integration') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-server"></i> System
                </h3>
                <span class="role-badge" style="background: rgba(78, 168, 255, 0.15); color: var(--accent-blue);">AUTOMATED</span>
              </div>
              <div class="view-section">
                <h4>Processing Pipeline</h4>
                <div class="timeline">
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Message received</strong>
                      <span>Kafka topic: sales.orders.created</span>
                    </div>
                  </div>
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Schema validation</strong>
                      <span>All required fields present</span>
                    </div>
                  </div>
                  <div class="timeline-item active">
                    <div class="timeline-content">
                      <strong>Service order creation</strong>
                      <span>Mapping to internal model...</span>
                    </div>
                  </div>
                  <div class="timeline-item">
                    <div class="timeline-content">
                      <strong>AI enrichment</strong>
                      <span>Pending</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (step.id === 'ai-analysis') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-robot"></i> AI Engine
                </h3>
                <span class="role-badge" style="background: rgba(192, 132, 252, 0.15); color: var(--accent-purple);">AUTOMATED</span>
              </div>
              <div class="view-section">
                <h4>Analysis in Progress</h4>
                <div class="timeline">
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Customer profile analysis</strong>
                      <span>Tier: ${so.customer.tier}, Claims: ${so.customer.claimHistory}</span>
                    </div>
                  </div>
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Risk scoring</strong>
                      <span>Computed risk factors</span>
                    </div>
                  </div>
                  <div class="timeline-item active">
                    <div class="timeline-content">
                      <strong>Project matching</strong>
                      <span>Searching for related orders...</span>
                    </div>
                  </div>
                  <div class="timeline-item">
                    <div class="timeline-content">
                      <strong>Pilote recommendation</strong>
                      <span>Pending</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (step.id === 'operator-triage') {
          const riskLevel = so.customer.claimHistory > 0 ? 'MEDIUM' : 'LOW';
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-headset"></i> Control Tower Cockpit
                </h3>
                <span class="role-badge role-operator">MARIA SANTOS • OP-MARIA</span>
              </div>
              
              <div class="cockpit-grid">
                <div class="cockpit-card">
                  <div class="cockpit-card-header">
                    <span class="cockpit-label">Risk Score</span>
                    <i class="fas fa-${riskLevel === 'LOW' ? 'shield-check' : 'shield-exclamation'}" style="color: var(--accent-${riskLevel === 'LOW' ? 'green' : 'orange'}); font-size: 1.3rem;"></i>
                  </div>
                  <div class="cockpit-metric" style="color: var(--accent-${riskLevel === 'LOW' ? 'green' : 'orange'});">${riskLevel === 'LOW' ? '23' : '67'}</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">
                    ${riskLevel === 'LOW' ? 'No red flags detected' : 'Previous claim + quotation'}
                  </div>
                </div>
                
                <div class="cockpit-card">
                  <div class="cockpit-card-header">
                    <span class="cockpit-label">Customer Tier</span>
                    <i class="fas fa-crown" style="color: var(--yellow); font-size: 1.3rem;"></i>
                  </div>
                  <div class="cockpit-metric">${so.customer.tier}</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">
                    LTV: €${so.customer.lifetimeValue}
                  </div>
                </div>
                
                <div class="cockpit-card">
                  <div class="cockpit-card-header">
                    <span class="cockpit-label">Payment Status</span>
                    <i class="fas fa-${so.payment.status === 'Paid' ? 'circle-check' : 'clock'}" style="color: var(--accent-${so.payment.status === 'Paid' ? 'green' : 'orange'}); font-size: 1.3rem;"></i>
                  </div>
                  <div class="cockpit-metric" style="font-size: 1.3rem; color: var(--accent-${so.payment.status === 'Paid' ? 'green' : 'orange'});">${so.payment.status.toUpperCase()}</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">
                    ${so.payment.status === 'Paid' ? `€${so.payment.paidAmount} via ${so.payment.method}` : `Due: ${so.payment.dueDate || 'N/A'}`}
                  </div>
                </div>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">📋 Service Order: SRV-${so.orderId.split('-')[2]}</h4>
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div>
                      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Customer</div>
                      <div style="font-weight: 600;">${so.customer.name}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${so.customer.phone}</div>
                    </div>
                    <div>
                      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Location</div>
                      <div style="font-weight: 600;">${so.customer.city}, ${so.customer.postalCode}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${so.customer.addressLine1}</div>
                    </div>
                    <div>
                      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Service</div>
                      <div style="font-weight: 600;">${so.services[0].name}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${so.services[0].duration} min • ${so.services[0].skillLevel}</div>
                    </div>
                    <div>
                      <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Scheduled</div>
                      <div style="font-weight: 600;">${so.services[0].scheduledDate}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${so.services[0].timeSlot}</div>
                    </div>
                  </div>
                </div>
                
                <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-robot" style="color: var(--accent-purple);"></i>
                    <strong style="color: var(--accent-purple);">AI Recommendations Accepted</strong>
                  </div>
                  <div style="font-size: 0.9rem;">✓ Pilote: PL-LIA (Lia Santos) • Load: 3 orders<br>✓ Schedule: Compliant (not Sunday, weekday AM)<br>✓ Project: Linked to ${so.salesProjectId}</div>
                </div>
              </div>

              <div class="view-section">
                <h4>Operator Actions</h4>
                <div style="display: flex; gap: 0.8rem; flex-wrap: wrap;">
                  <button class="btn btn-primary" style="flex: 1;">✓ Confirm & Proceed</button>
                  <button class="btn btn-secondary">Override Risk</button>
                  <button class="btn btn-secondary">Reschedule</button>
                  <button class="btn btn-secondary">Reassign Pilote</button>
                </div>
              </div>
            </div>
          `;
        } else if (step.id === 'contract') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-file-signature"></i> Customer Contract Signature
                </h3>
                <span class="role-badge role-customer">${so.customer.name.toUpperCase()}</span>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">📧 Email Notification</h4>
                <div class="email-mockup">
                  <div class="email-header">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                      <div style="background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1rem; font-weight: 700; border-radius: 4px;">YellowGrid</div>
                      <div style="flex: 1;"></div>
                      <div style="font-size: 0.85rem; color: #666;">Just now</div>
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                      <strong>From:</strong> contracts@yellowgrid.pt
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                      <strong>To:</strong> ${so.customer.email}
                    </div>
                    <div style="font-size: 1.1rem; font-weight: 700; margin-top: 0.8rem;">
                      Service Contract Ready for Signature - Action Required
                    </div>
                  </div>
                  <div class="email-body">
                    <p>Dear ${so.customer.firstName},</p>
                    <p style="margin: 1rem 0;">
                      Your service contract for <strong>${so.services[0].name}</strong> is ready for digital signature.
                    </p>
                    <div style="background: #f8f9fa; border-left: 4px solid var(--yellow); padding: 1rem; margin: 1rem 0; color: #333;">
                      <strong style="color: #1a1a1a;">⚠️ Important:</strong> Your service cannot proceed until this contract is signed. Please review and sign within 48 hours to maintain your scheduled date.
                    </div>
                    <div style="text-align: center; margin: 1.5rem 0;">
                      <a href="#" class="email-button">
                        <i class="fas fa-file-signature"></i> Review & Sign Contract
                      </a>
                    </div>
                    <p style="margin: 1rem 0; font-size: 0.9rem; color: #666;">
                      <strong>Contract Summary:</strong><br>
                      Service Order: <strong>SRV-${so.orderId.split('-')[2]}</strong><br>
                      Total Amount: <strong>€${so.totals.services}</strong><br>
                      Scheduled Date: <strong>${so.services[0].scheduledDate} at ${so.services[0].timeSlot}</strong><br>
                      Payment: <strong>${so.payment.status}</strong>
                    </p>
                    <p style="margin: 1.5rem 0 0.5rem 0; font-size: 0.85rem; color: #999; border-top: 1px solid #e5e5e5; padding-top: 1rem;">
                      Questions? Contact us at contracts@yellowgrid.pt or +351 210 123 456
                    </p>
                  </div>
                </div>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">📱 SMS Notification</h4>
                <div class="sms-mockup">
                  <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.8rem;">
                    Today - Just now
                  </div>
                  <div class="sms-bubble">
                    YellowGrid: Your service contract is ready! Sign now to confirm your ${so.services[0].scheduledDate} appointment: yellowgrid.pt/contract/SRV-${so.orderId.split('-')[2]}
                  </div>
                </div>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">🌐 Contract Signature Portal</h4>
                <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; background: rgba(255, 255, 255, 0.02); max-height: 600px; overflow-y: auto;">
                  <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="display: inline-block; background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1.5rem; font-weight: 700; border-radius: 4px; margin-bottom: 1rem;">YellowGrid</div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Service Contract</h3>
                    <p style="color: var(--text-muted); font-size: 0.95rem;">Contract #CTR-${so.linkedContracts || so.orderId.split('-')[2]}</p>
                  </div>

                  <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">📋 Contract Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                      <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Service</div>
                        <div style="font-weight: 600;">${so.services[0].name}</div>
                      </div>
                      <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Scheduled Date</div>
                        <div style="font-weight: 600;">${so.services[0].scheduledDate}</div>
                      </div>
                      <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Time Slot</div>
                        <div style="font-weight: 600;">${so.services[0].timeSlot}</div>
                      </div>
                      <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.3rem;">Total Amount</div>
                        <div style="font-weight: 600; color: var(--yellow); font-size: 1.1rem;">€${so.totals.services}</div>
                      </div>
                    </div>
                  </div>

                  <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">💰 Pricing Breakdown</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                      <span>Products</span>
                      <span style="font-weight: 600;">€${so.totals.products}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                      <span>Services</span>
                      <span style="font-weight: 600;">€${so.totals.services}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--accent-green);">
                      <span>Discount</span>
                      <span style="font-weight: 600;">-€${so.totals.discount || '0.00'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                      <span>Tax (${so.totals.taxRate || '23%'})</span>
                      <span>€${so.totals.tax}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">
                      <span>Shipping</span>
                      <span>€${so.totals.shippingCost || '0.00'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 0.8rem; border-top: 2px solid var(--border); font-size: 1.2rem; font-weight: 700;">
                      <span>Total Amount</span>
                      <span style="color: var(--yellow);">€${so.totals.total}</span>
                    </div>
                  </div>

                  <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">📜 Terms & Conditions</h4>
                    <div style="max-height: 200px; overflow-y: auto; font-size: 0.85rem; line-height: 1.6; color: var(--text-muted);">
                      <p style="margin-bottom: 0.8rem;"><strong>1. Service Agreement:</strong> YellowGrid commits to provide the services described above at the agreed date and time. Customer commits to provide access to the installation location.</p>
                      <p style="margin-bottom: 0.8rem;"><strong>2. Payment Terms:</strong> ${so.payment.status === 'Paid' ? 'Payment has been received and confirmed.' : 'Payment is due before service execution. Accepted methods: Credit Card, Bank Transfer, MB WAY.'}</p>
                      <p style="margin-bottom: 0.8rem;"><strong>3. Cancellation Policy:</strong> Free cancellation up to 48 hours before scheduled date. Cancellations within 48 hours incur a 50% fee. No-shows are charged 100%.</p>
                      <p style="margin-bottom: 0.8rem;"><strong>4. Rescheduling:</strong> Customer may reschedule once free of charge with 48h notice. Additional rescheduling requests may incur fees.</p>
                      <p style="margin-bottom: 0.8rem;"><strong>5. Warranty:</strong> All installed equipment comes with manufacturer warranty as specified. Service quality is guaranteed for 90 days.</p>
                      <p style="margin-bottom: 0.8rem;"><strong>6. Privacy:</strong> Customer data is processed according to GDPR regulations. See full privacy policy at yellowgrid.pt/privacy</p>
                      <p style="margin-bottom: 0.8rem;"><strong>7. Dispute Resolution:</strong> Any disputes will be resolved through Portuguese arbitration. Governing law: Portuguese Civil Code.</p>
                    </div>
                  </div>

                  <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: flex-start; gap: 0.8rem; cursor: pointer;">
                      <input type="checkbox" style="width: 20px; height: 20px; margin-top: 0.2rem;">
                      <span style="flex: 1; font-size: 0.9rem;">
                        I have read and agree to the terms and conditions. I authorize YellowGrid to proceed with the service as described. I understand that payment authorization or prepayment may be required before service execution.
                      </span>
                    </label>
                  </div>

                  <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                    <i class="fas fa-signature" style="font-size: 2rem; color: var(--yellow); margin-bottom: 0.5rem;"></i>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">Digital Signature Area</div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 4px; font-style: italic; font-size: 1.2rem;">
                      ${so.customer.name}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">
                      Signed electronically on ${new Date().toLocaleString('en-GB')}
                    </div>
                  </div>

                  <button class="btn btn-primary" style="width: 100%; padding: 1.2rem; font-size: 1.2rem; background: linear-gradient(135deg, var(--yellow), #f59e0b);">
                    <i class="fas fa-check-circle"></i> Sign Contract & Confirm Service
                  </button>

                  <div style="text-align: center; margin-top: 1rem;">
                    <a href="#" style="color: var(--accent-red); font-size: 0.9rem; text-decoration: none;">
                      <i class="fas fa-times-circle"></i> Decline Contract
                    </a>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (step.id === 'provider-match') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-mobile-screen-button"></i> Provider Mobile App
                </h3>
                <span class="role-badge role-provider">PROVIDER L • RUI LOPES</span>
              </div>
              
              <div class="mobile-screen">
                <div class="mobile-header">
                  <div class="mobile-status-bar">
                    <i class="fas fa-signal"></i> 
                    <i class="fas fa-wifi"></i>
                    <span style="margin-left: 0.5rem;">9:41</span>
                  </div>
                  <div style="font-size: 1.2rem; font-weight: 700;">YellowGrid Pro</div>
                  <div><i class="fas fa-bell"></i></div>
                </div>

                <div class="mobile-card" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1a1405;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                    <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">New Assignment</div>
                    <div style="background: rgba(0,0,0,0.2); padding: 0.3rem 0.7rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700;">
                      <i class="fas fa-clock"></i> 4h to respond
                    </div>
                  </div>
                  <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem;">Match Score: 92/100</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">
                    <i class="fas fa-check-circle"></i> High priority • Perfect fit for your crew
                  </div>
                </div>

                <div class="mobile-card">
                  <div style="font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.8rem;">Service Details</div>
                  <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem;">${so.services[0].name}</div>
                  
                  <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                      <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.3rem;">📅 DATE</div>
                      <div style="font-weight: 600;">${so.services[0].scheduledDate}</div>
                    </div>
                    <div style="flex: 1;">
                      <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.3rem;">🕐 TIME</div>
                      <div style="font-weight: 600;">${so.services[0].timeSlot}</div>
                    </div>
                  </div>

                  <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.3rem;">📍 LOCATION</div>
                    <div style="font-weight: 600;">${so.customer.city}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">${so.customer.addressLine1}</div>
                  </div>

                  <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: rgba(78, 168, 255, 0.1); padding: 0.4rem 0.8rem; border-radius: 999px; font-size: 0.8rem;">
                      ${so.services[0].duration} min
                    </div>
                    <div style="background: rgba(78, 168, 255, 0.1); padding: 0.4rem 0.8rem; border-radius: 999px; font-size: 0.8rem;">
                      ${so.services[0].techniciansRequired} tech needed
                    </div>
                    <div style="background: rgba(78, 168, 255, 0.1); padding: 0.4rem 0.8rem; border-radius: 999px; font-size: 0.8rem;">
                      ${so.services[0].skillLevel}
                    </div>
                  </div>

                  <div style="background: rgba(73, 212, 147, 0.1); border-radius: 8px; padding: 0.8rem; font-size: 0.9rem;">
                    <strong style="color: var(--accent-green);"><i class="fas fa-check"></i> Your Crew Available</strong><br>
                    <span style="color: var(--text-muted);">Rui Lopes • 2 installers • SLA: T+48h</span>
                  </div>
                </div>

                <button class="mobile-button mobile-button-primary">
                  <i class="fas fa-check-circle"></i> Accept Assignment
                </button>
                <button class="mobile-button mobile-button-secondary">
                  <i class="fas fa-calendar-alt"></i> Propose Different Date
                </button>
                <button class="mobile-button mobile-button-secondary">
                  <i class="fas fa-times-circle"></i> Decline
                </button>
              </div>
            </div>
          `;
        } else if (step.id === 'go-gate') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-shield"></i> Go Execution Gate
                </h3>
                <span class="role-badge role-operator">MARIA SANTOS</span>
              </div>
              <div class="view-section">
                <h4>Gate Requirements</h4>
                <div class="timeline">
                  <div class="timeline-item ${so.payment.status === 'Paid' ? 'completed' : ''}">
                    <div class="timeline-content">
                      <strong>Payment Received</strong>
                      <span>${so.payment.status === 'Paid' ? 'Confirmed' : 'Pending'}</span>
                    </div>
                  </div>
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Delivery Confirmed</strong>
                      <span>Materials on site</span>
                    </div>
                  </div>
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Contract Signed</strong>
                      <span>Customer accepted</span>
                    </div>
                  </div>
                  <div class="timeline-item completed">
                    <div class="timeline-content">
                      <strong>Crew Assigned</strong>
                      <span>Rui Lopes crew ready</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="view-section">
                <h4>Gate Status</h4>
                <p style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green); text-align: center; margin: 1rem 0;">
                  ${so.payment.status === 'Paid' ? '✓ GO EXECUTION' : '⚠ BLOCKED'}
                </p>
                ${so.payment.status !== 'Paid' ? '<div class="action-buttons"><button class="btn btn-secondary">Authorize Derogation</button></div>' : ''}
              </div>
            </div>
          `;
        } else if (step.id === 'execution') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-mobile-screen-button"></i> Crew Mobile App
                </h3>
                <span class="role-badge role-crew">RUI LOPES</span>
              </div>
              <div class="view-section">
                <h4>Today's Job</h4>
                <div class="info-grid">
                  <div class="info-item">
                    <label>Customer</label>
                    <div class="value">${so.customer.name}</div>
                  </div>
                  <div class="info-item">
                    <label>Phone</label>
                    <div class="value">${so.customer.phone}</div>
                  </div>
                  <div class="info-item">
                    <label>Address</label>
                    <div class="value">${so.customer.address.split(',')[0]}</div>
                  </div>
                  <div class="info-item">
                    <label>Time</label>
                    <div class="value">${so.services[0].timeSlot}</div>
                  </div>
                </div>
              </div>
              
              <div class="mobile-screen">
                <div class="mobile-header">
                  <div class="mobile-status-bar">
                    <i class="fas fa-signal"></i> 
                    <i class="fas fa-wifi"></i>
                    <span style="margin-left: 0.5rem;">9:03</span>
                  </div>
                  <div style="font-size: 1.2rem; font-weight: 700;">Today's Job</div>
                  <div><i class="fas fa-ellipsis-v"></i></div>
                </div>

                <div class="mobile-card" style="background: linear-gradient(135deg, #49d493, #38a169); color: #fff;">
                  <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">
                    <i class="fas fa-check-circle"></i> Checked In
                  </div>
                  <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 0.3rem;">Job #SRV-${so.orderId.split('-')[2]}</div>
                  <div style="font-size: 0.9rem; opacity: 0.9;">
                    Started at 09:03 • Est. completion: 11:00
                  </div>
                </div>

                <div class="mobile-card">
                  <div style="font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.8rem;">Customer Info</div>
                  <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem;">${so.customer.name}</div>
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-phone" style="color: var(--accent-blue);"></i>
                    <span style="font-weight: 600;">${so.customer.phone}</span>
                    <button style="margin-left: auto; background: var(--accent-blue); border: none; padding: 0.4rem 0.8rem; border-radius: 8px; color: #fff; font-size: 0.85rem;">
                      <i class="fas fa-phone"></i> Call
                    </button>
                  </div>
                  <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                    <i class="fas fa-map-marker-alt" style="color: var(--accent-blue); margin-top: 0.2rem;"></i>
                    <div>
                      <div style="font-weight: 600;">${so.customer.addressLine1}</div>
                      <div style="font-size: 0.9rem; color: var(--text-muted);">${so.customer.city}, ${so.customer.postalCode}</div>
                    </div>
                  </div>
                </div>

                <div class="mobile-card">
                  <div style="font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.8rem;">Work Checklist</div>
                  <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                    <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer;">
                      <input type="checkbox" checked style="width: 20px; height: 20px;">
                      <span style="flex: 1;">Verify customer identity & documents</span>
                      <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer;">
                      <input type="checkbox" checked style="width: 20px; height: 20px;">
                      <span style="flex: 1;">Inspect workspace & capture before photos</span>
                      <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer;">
                      <input type="checkbox" checked style="width: 20px; height: 20px;">
                      <span style="flex: 1;">Install equipment according to playbook</span>
                      <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.8rem; cursor: pointer;">
                      <input type="checkbox" checked style="width: 20px; height: 20px;">
                      <span style="flex: 1;">Test system and brief customer</span>
                      <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    </label>
                  </div>
                </div>

                <div class="mobile-card" style="background: rgba(78, 168, 255, 0.1);">
                  <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.8rem;">
                    <i class="fas fa-camera"></i> Evidence Captured
                  </div>
                  <div style="display: flex; gap: 0.5rem;">
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 0.5rem; border-radius: 8px; flex: 1; text-align: center;">
                      <div style="font-size: 1.5rem; font-weight: 700;">3</div>
                      <div style="font-size: 0.8rem; color: var(--text-muted);">Photos</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 0.5rem; border-radius: 8px; flex: 1; text-align: center;">
                      <div style="font-size: 1.5rem; font-weight: 700;">1</div>
                      <div style="font-size: 0.8rem; color: var(--text-muted);">Audio</div>
                    </div>
                  </div>
                </div>

                <button class="mobile-button mobile-button-secondary">
                  <i class="fas fa-camera"></i> Add More Evidence
                </button>
                <button class="mobile-button mobile-button-primary">
                  <i class="fas fa-check-double"></i> Complete Job & Request WCF
                </button>
              </div>
            </div>
          `;
        } else if (step.id === 'wcf') {
          html = `
            <div class="stakeholder-view">
              <div class="view-header">
                <h3>
                  <i class="fas fa-envelope"></i> Customer Communication
                </h3>
                <span class="role-badge role-customer">${so.customer.name.toUpperCase()}</span>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">📧 Email Notification</h4>
                <div class="email-mockup">
                  <div class="email-header">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                      <div style="background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1rem; font-weight: 700; border-radius: 4px;">YellowGrid</div>
                      <div style="flex: 1;"></div>
                      <div style="font-size: 0.85rem; color: #666;">10:52 AM</div>
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                      <strong>From:</strong> no-reply@yellowgrid.pt
                    </div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                      <strong>To:</strong> ${so.customer.email}
                    </div>
                    <div style="font-size: 1.1rem; font-weight: 700; margin-top: 0.8rem;">
                      Service Complete - Please Sign Work Completion Form
                    </div>
                  </div>
                  <div class="email-body">
                    <p>Dear ${so.customer.firstName},</p>
                    <p style="margin: 1rem 0;">
                      Your service <strong>${so.services[0].name}</strong> has been completed by our technician team.
                    </p>
                    <p style="margin: 1rem 0;">
                      Please review the work and sign the Work Completion Form (WCF) by clicking the button below:
                    </p>
                    <div style="text-align: center;">
                      <a href="#" class="email-button">
                        <i class="fas fa-signature"></i> Sign WCF Online
                      </a>
                    </div>
                    <p style="margin: 1rem 0; font-size: 0.9rem; color: #666;">
                      Service Order: <strong>SRV-${so.orderId.split('-')[2]}</strong><br>
                      Completed: ${new Date().toLocaleString('en-GB')}<br>
                      Technician: Rui Lopes
                    </p>
                    <p style="margin: 1.5rem 0 0.5rem 0; font-size: 0.85rem; color: #999; border-top: 1px solid #e5e5e5; padding-top: 1rem;">
                      Questions? Contact us at support@yellowgrid.pt or +351 210 123 456
                    </p>
                  </div>
                </div>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">📱 SMS Notification</h4>
                <div class="sms-mockup">
                  <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.8rem;">
                    Today 10:52 AM
                  </div>
                  <div class="sms-bubble">
                    YellowGrid: Your service is complete! Sign the WCF here: yellowgrid.pt/wcf/SRV-${so.orderId.split('-')[2]} - Thank you!
                  </div>
                </div>
              </div>

              <div class="view-section">
                <h4 style="margin-bottom: 1rem;">🌐 Web Portal (After Clicking Link)</h4>
                <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; background: rgba(255, 255, 255, 0.02);">
                  <div style="text-align: center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Work Completion Form</h3>
                    <p style="color: var(--text-muted);">Service Order: SRV-${so.orderId.split('-')[2]}</p>
                  </div>

                  <div style="background: rgba(73, 212, 147, 0.08); border: 2px solid rgba(73, 212, 147, 0.4); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                      <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--accent-green);"></i>
                      <div style="flex: 1;">
                        <strong style="font-size: 1.1rem; color: var(--accent-green);">Sign with No Reserves</strong>
                        <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">Work completed satisfactorily. Payment releases immediately.</p>
                      </div>
                    </div>
                  </div>

                  <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                      <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: var(--accent-orange);"></i>
                      <div style="flex: 1;">
                        <strong style="font-size: 1.1rem;">Sign with Reserves</strong>
                        <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">Issues noted. Auto-creates rework order and holds payment.</p>
                      </div>
                    </div>
                  </div>

                  <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                      <i class="fas fa-times-circle" style="font-size: 2rem; color: var(--accent-red);"></i>
                      <div style="flex: 1;">
                        <strong style="font-size: 1.1rem;">Refuse to Sign</strong>
                        <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">Work unacceptable. Payment blocked until resolution.</p>
                      </div>
                    </div>
                  </div>

                  <textarea style="width: 100%; padding: 1rem; border-radius: 8px; background: rgba(255, 255, 255, 0.04); border: 1px solid var(--border); color: var(--text-main); min-height: 100px; margin-bottom: 1rem;" placeholder="Optional: Add feedback about the service quality, technician professionalism, etc."></textarea>

                  <button class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                    <i class="fas fa-signature"></i> Submit Digital Signature
                  </button>
                </div>
              </div>
            </div>
          `;
        }

        document.getElementById('stakeholderPanel').innerHTML = html;
      };

      const renderAI = () => {
        if (!currentScenario) return;
        
        const so = scenarios[currentScenario].salesOrder;
        const step = steps[currentStep];

        let html = '';

        if (step.id === 'integration') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-robot"></i>
                <strong>Initial Assessment</strong>
              </div>
              <div class="ai-reasoning">
                Analyzing order structure and customer profile...
              </div>
              <div class="ai-confidence">
                <span>Processing</span>
                <div class="confidence-bar">
                  <div class="confidence-fill" style="width: 35%;"></div>
                </div>
                <span>35%</span>
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Customer Signals</span>
              </div>
              <div class="metric-factors">
                <div class="factor-chip">Tier: ${so.customer.tier}</div>
                <div class="factor-chip">Claims: ${so.customer.claimHistory}</div>
                <div class="factor-chip">Customer since: ${new Date(so.customer.customerSince).getFullYear()}</div>
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Order Complexity</span>
              </div>
              <div class="metric-factors">
                <div class="factor-chip">${so.products.length} product(s)</div>
                <div class="factor-chip">${so.services.length} service(s)</div>
                <div class="factor-chip">Total: €${so.totals.total}</div>
              </div>
            </div>
          `;
        } else if (step.id === 'ai-analysis') {
          const riskLevel = so.customer.claimHistory > 0 || so.linkedQuotation ? 'MEDIUM' : 'LOW';
          const tvPotential = so.linkedQuotation || so.sellerNotes.includes('upsell') ? 'HIGH' : 'LOW';
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-brain"></i>
                <strong>Risk Assessment Complete</strong>
              </div>
              <div class="ai-reasoning">
                ${riskLevel === 'LOW' 
                  ? 'No red flags detected. Customer is new (0 claims), order structure is simple (single service), and payment is confirmed.'
                  : 'Moderate risk detected: Previous claim in customer history. However, claim was resolved and customer tier is Premium.'
                }
              </div>
              <div class="ai-confidence">
                <span>Confidence</span>
                <div class="confidence-bar">
                  <div class="confidence-fill" style="width: 87%;"></div>
                </div>
                <span>87%</span>
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Risk Score</span>
              </div>
              <div class="metric-value risk-${riskLevel.toLowerCase()}">${riskLevel === 'LOW' ? '23' : '67'}/100</div>
              <div class="metric-factors">
                ${riskLevel === 'MEDIUM' ? 
                  '<div class="factor-chip">Previous claim</div><div class="factor-chip">Linked quotation</div>' : 
                  '<div class="factor-chip">New customer</div><div class="factor-chip">Low complexity</div>'
                }
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-lightbulb"></i>
                <strong>TV Potential: ${tvPotential}</strong>
              </div>
              <div class="ai-reasoning">
                ${tvPotential === 'HIGH' 
                  ? 'Seller notes indicate strong upsell opportunity ("' + so.sellerNotes.substring(0, 50) + '..."). Recommend bundling quotation with installation.'
                  : 'Limited upsell scope. Single product order with straightforward installation. Recommend lean offer.'
                }
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-people-arrows"></i>
                <strong>Pilote Recommendation</strong>
              </div>
              <div class="ai-reasoning">
                Suggesting <strong>PL-LIA (Lia Santos)</strong> • Greater Lisbon region • Current load: 3 orders (lightest workload)
              </div>
            </div>
          `;
        } else if (step.id === 'operator-triage') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-check-circle"></i>
                <strong>Operator Accepted AI Suggestions</strong>
              </div>
              <div class="ai-reasoning">
                No overrides applied. Risk assessment, pilote assignment, and schedule validated by operator Maria Santos.
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Calendar Validation</span>
              </div>
              <div class="metric-factors">
                <div class="factor-chip">✓ Not Sunday</div>
                <div class="factor-chip">✓ Weekday morning slot</div>
                <div class="factor-chip">✓ Within SLA</div>
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-link"></i>
                <strong>Project Linkage</strong>
              </div>
              <div class="ai-reasoning">
                Service order linked to sales project <strong>${so.salesProjectId}</strong>. No other related orders found in 30-day window.
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-arrow-right"></i>
                <strong>Next Step: Contract Generation</strong>
              </div>
              <div class="ai-reasoning">
                System will auto-generate contract bundle with 2-hour auto-send timer. Operator can expedite or override.
              </div>
            </div>
          `;
        } else if (step.id === 'contract') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-file-contract"></i>
                <strong>Contract Template Selection</strong>
              </div>
              <div class="ai-reasoning">
                Selected <strong>"Standard Installation"</strong> template based on service type (${so.services[0].code}). Single service order, no special clauses required.
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Bundle Configuration</span>
              </div>
              <div class="metric-factors">
                <div class="factor-chip">1 service order</div>
                <div class="factor-chip">0 linked pre-sales</div>
                <div class="factor-chip">Standard terms</div>
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-clock"></i>
                <strong>Auto-Send Timer</strong>
              </div>
              <div class="ai-reasoning">
                Contract will auto-send in <strong>2 hours</strong> unless operator intervenes. Customer will receive email + SMS notification with digital signature link.
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-lock"></i>
                <strong>Provider Matching Blocked</strong>
              </div>
              <div class="ai-reasoning">
                Crew matching will not begin until contract status is <strong>OK</strong> or <strong>NOK</strong>. This prevents crew assignment before customer commitment.
              </div>
            </div>
          `;
        } else if (step.id === 'provider-match') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-diagram-project"></i>
                <strong>Crew Matching Algorithm</strong>
              </div>
              <div class="ai-reasoning">
                Matched 3 crews based on: location proximity (${so.customer.address.split(',')[1]}), service type expertise (kitchen installations), capacity availability, and historical SLA performance.
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Top Match: Provider L</span>
              </div>
              <div class="metric-value" style="color: var(--accent-green); font-size: 1.5rem;">92/100</div>
              <div class="metric-factors">
                <div class="factor-chip">Proximity: 8/10</div>
                <div class="factor-chip">Expertise: 10/10</div>
                <div class="factor-chip">SLA: 9/10</div>
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-hourglass"></i>
                <strong>Response Window</strong>
              </div>
              <div class="ai-reasoning">
                Providers have <strong>4 hours</strong> to respond. Up to <strong>3 rounds of negotiation</strong> allowed. If no acceptance after 3 rounds, escalates to operator task queue.
              </div>
            </div>
          `;
        } else if (step.id === 'go-gate') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-shield-halved"></i>
                <strong>Gate Validation</strong>
              </div>
              <div class="ai-reasoning">
                All prerequisites ${so.payment.status === 'Paid' ? '<strong style="color: var(--accent-green);">PASSED</strong>' : '<strong style="color: var(--accent-orange);">PARTIALLY MET</strong>'}. 
                ${so.payment.status === 'Paid' 
                  ? 'Payment confirmed, delivery on site, contract signed, crew assigned. Crew can check in.' 
                  : 'Payment is pending (invoice method). Delivery and contract are OK. Operator can authorize derogation if needed.'
                }
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Gate Status</span>
              </div>
              <div class="metric-value" style="color: ${so.payment.status === 'Paid' ? 'var(--accent-green)' : 'var(--accent-orange)'}; font-size: 1.5rem;">
                ${so.payment.status === 'Paid' ? 'GO' : 'BLOCKED'}
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-mobile"></i>
                <strong>Crew Notification</strong>
              </div>
              <div class="ai-reasoning">
                ${so.payment.status === 'Paid' 
                  ? 'Mobile app unlocked for crew. Check-in will capture GPS coordinates and timestamp automatically.'
                  : 'Crew mobile app blocked until gate clears. Push notification will be sent when status changes.'
                }
              </div>
            </div>
          `;
        } else if (step.id === 'execution') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-location-dot"></i>
                <strong>Geo-fencing Validation</strong>
              </div>
              <div class="ai-reasoning">
                Crew check-in location verified within <strong>50m</strong> of customer address. Timestamp logged: 09:03 AM (within scheduled window).
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Execution Compliance</span>
              </div>
              <div class="metric-factors">
                <div class="factor-chip">✓ On-time arrival</div>
                <div class="factor-chip">✓ Checklist complete</div>
                <div class="factor-chip">✓ Evidence captured</div>
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-camera"></i>
                <strong>Evidence Validation</strong>
              </div>
              <div class="ai-reasoning">
                Crew uploaded <strong>3 photos</strong> (before/during/after) and <strong>1 audio note</strong>. All evidence synced to Control Tower in real-time.
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-arrow-right"></i>
                <strong>Next: Customer WCF</strong>
              </div>
              <div class="ai-reasoning">
                Job marked complete at 10:47 AM. WCF form sent to customer via SMS + email. Provider payment blocked until customer signs.
              </div>
            </div>
          `;
        } else if (step.id === 'wcf') {
          html = `
            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-signature"></i>
                <strong>WCF Outcome: No Reserves</strong>
              </div>
              <div class="ai-reasoning">
                Customer <strong>${so.customer.name}</strong> signed WCF digitally with no reserves. Work accepted as complete and satisfactory.
              </div>
            </div>

            <div class="metric-card">
              <div class="metric-header">
                <span class="metric-label">Payment Release</span>
              </div>
              <div class="metric-value" style="color: var(--accent-green); font-size: 1.3rem;">€${(so.totals.services * 0.75).toFixed(2)}</div>
              <div style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
                Provider payout (75% of €${so.totals.services}) authorized for release on ${new Date(Date.now() + 86400000).toISOString().split('T')[0]}.
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-check-double"></i>
                <strong>Service Order Closed</strong>
              </div>
              <div class="ai-reasoning">
                Service order <strong>SRV-${so.orderId.split('-')[2]}</strong> moved to CLOSED status. No rework needed. Customer satisfaction recorded. Project ${so.salesProjectId} updated.
              </div>
            </div>

            <div class="ai-insight">
              <div class="ai-insight-header">
                <i class="fas fa-chart-line"></i>
                <strong>Performance Metrics</strong>
              </div>
              <div class="ai-reasoning">
                On-time completion • 0 derogations • 0 re-schedules • Customer satisfaction: Positive feedback recorded.
              </div>
            </div>
          `;
        }

        document.getElementById('aiPanel').innerHTML = html;
      };

      // Define journey cards for each step - Complete workflow
      const journeyCards = {
        'integration': [
          { id: 'kafka-message', type: 'data', title: 'Kafka Message', icon: 'server' },
          { id: 'enrichment', type: 'system', title: 'Enrichment', icon: 'cogs' },
          { id: 'project-creation', type: 'system', title: 'SO Creation', icon: 'folder-plus' }
        ],
        'ai-analysis': [
          { id: 'ai-reasoning', type: 'ai', title: 'AI Analysis', icon: 'robot' }
        ],
        'operator-triage': [
          { id: 'operator-cockpit', type: 'operator', title: 'Operator Triage', icon: 'headset' }
        ],
        'contract': [
          { id: 'contract-notification', type: 'customer', title: 'Contract Email/SMS', icon: 'envelope' },
          { id: 'contract-portal', type: 'customer', title: 'Contract Portal', icon: 'file-signature' }
        ],
        'provider-match': [
          { id: 'provider-funnel', type: 'system', title: 'Provider Matching', icon: 'filter' },
          { id: 'provider-offer', type: 'provider', title: 'Provider Offer', icon: 'mobile-screen-button' }
        ],
        'go-gate': [
          { id: 'go-gate-check', type: 'system', title: 'Go Exec Gate', icon: 'traffic-light' }
        ],
        'tv-execution': [
          { id: 'tv-crew-execution', type: 'crew', title: 'TV Execution', icon: 'mobile-screen-button' }
        ],
        'tv-report': [
          { id: 'tv-report-upload', type: 'crew', title: 'TV Report Upload', icon: 'file-upload' },
          { id: 'tv-report-analysis', type: 'ai', title: 'AI Report Analysis', icon: 'robot' }
        ],
        'tv-decision': [
          { id: 'tv-operator-decision', type: 'operator', title: 'TV Outcome Decision', icon: 'headset' }
        ],
        'adjustment': [
          { id: 'adjustment-quote', type: 'provider', title: 'Adjustment Quote', icon: 'file-invoice' },
          { id: 'derogation-approval', type: 'operator', title: 'Derogation Approval', icon: 'check-circle' }
        ],
        'execution': [
          { id: 'crew-execution', type: 'crew', title: 'Crew Execution', icon: 'mobile-screen-button' }
        ],
        'wcf': [
          { id: 'wcf-notification', type: 'customer', title: 'WCF Email/SMS', icon: 'envelope' },
          { id: 'wcf-portal', type: 'customer', title: 'WCF Signature', icon: 'signature' }
        ]
      };

      // Add new invoice and payment steps
      const invoicePaymentCards = [
        { id: 'invoice-portal', type: 'provider', title: 'Invoice Portal', icon: 'file-invoice', stepId: 'invoice' },
        { id: 'invoice-dataflow', type: 'data', title: 'Invoice Dataflow', icon: 'exchange-alt', stepId: 'invoice' },
        { id: 'payment-portal', type: 'provider', title: 'Payment Portal', icon: 'credit-card', stepId: 'payment' }
      ];

      // Get cards for specific scenario
      const getCardsForScenario = (scenarioId) => {
        let cards = [];
        let cardIndex = 0;
        
        // Define which steps to include for each scenario
        const scenarioSteps = {
          'simple-install': steps,
          'tv-quotation': steps.filter(s => s.id !== 'go-gate' && s.id !== 'wcf'),
          'package-deal': 'custom', // Custom flow for service pack with TV confirmation
          'complex-project': 'custom', // Custom flow for multi-phase project with iterative loops
          'rework': steps,
          'maintenance': steps,
          'depannage': 'custom', // Custom flow for emergency service with urgency triage
          'subscription': 'custom' // Custom flow for recurring service with auto-scheduling
        };
        
        // Custom flow for Service Pack scenario with TV confirmation and automatic flow control
        if (scenarioId === 'package-deal') {
          const packageDealCards = [
            // Integration
            { id: 'kafka-message', type: 'data', title: 'Kafka Message', icon: 'server', stepId: 'integration' },
            { id: 'enrichment', type: 'system', title: 'Enrichment', icon: 'cogs', stepId: 'integration' },
            { id: 'project-creation', type: 'system', title: 'SO Creation', icon: 'folder-plus', stepId: 'integration' },
            // AI Analysis
            { id: 'ai-reasoning', type: 'ai', title: 'AI Analysis', icon: 'robot', stepId: 'ai-analysis' },
            // Operator Triage
            { id: 'operator-cockpit', type: 'operator', title: 'Operator Triage', icon: 'headset', stepId: 'operator-triage' },
            // Contract
            { id: 'contract-notification', type: 'customer', title: 'Contract Email/SMS', icon: 'envelope', stepId: 'contract' },
            { id: 'contract-portal', type: 'customer', title: 'Contract Portal', icon: 'file-signature', stepId: 'contract' },
            // Single Provider Match for BUNDLE (TV + Installation)
            { id: 'provider-funnel', type: 'system', title: 'Provider Matching', icon: 'filter', stepId: 'provider-match' },
            { id: 'provider-offer', type: 'provider', title: 'Provider Bundle Offer', icon: 'mobile-screen-button', stepId: 'provider-match' },
            // TV Execution (no go-gate, happens automatically after provider accepts)
            { id: 'tv-crew-execution', type: 'crew', title: 'TV Execution', icon: 'mobile-screen-button', stepId: 'tv-execution' },
            // TV Report & AI Analysis
            { id: 'tv-report-upload', type: 'crew', title: 'TV Report Upload', icon: 'file-upload', stepId: 'tv-report' },
            { id: 'tv-report-analysis', type: 'ai', title: 'AI Report Analysis', icon: 'robot', stepId: 'tv-report' },
            // TV Outcome Processing (YES unblocks install, NO/YES BUT alerts sales)
            { id: 'tv-outcome-gate', type: 'system', title: 'TV Outcome Gate', icon: 'code-branch', stepId: 'tv-outcome' },
            { id: 'sales-alert', type: 'operator', title: 'Sales Team Alert', icon: 'bell', stepId: 'sales-alert' },
            { id: 'so-update-sync', type: 'system', title: 'SO Update Sync', icon: 'sync', stepId: 'so-sync' },
            // Go Exec for Installation (only here, after TV outcome processed)
            { id: 'go-gate-check', type: 'system', title: 'Go Exec Gate (Install)', icon: 'traffic-light', stepId: 'go-gate' },
            // Crew Execution
            { id: 'crew-execution', type: 'crew', title: 'Crew Execution', icon: 'mobile-screen-button', stepId: 'execution' },
            // WCF
            { id: 'wcf-notification', type: 'customer', title: 'WCF Email/SMS', icon: 'envelope', stepId: 'wcf' },
            { id: 'wcf-portal', type: 'customer', title: 'WCF Signature', icon: 'signature', stepId: 'wcf' }
          ];
          
          // Add invoice and payment cards
          packageDealCards.push(...invoicePaymentCards);
          
          return packageDealCards.map((card, idx) => ({ ...card, index: idx }));
        }

        // Custom flow for Complex Installation Project with iterative loop mechanism
        if (scenarioId === 'complex-project') {
          const so = scenarios[scenarioId].salesOrder;
          const complexProjectCards = [
            // Initial Integration (once)
            { id: 'kafka-message', type: 'data', title: 'Kafka Message', icon: 'server', stepId: 'integration', phase: 0 },
            { id: 'enrichment', type: 'system', title: 'Enrichment', icon: 'cogs', stepId: 'integration', phase: 0 },
            { id: 'project-creation', type: 'system', title: 'Project Creation', icon: 'folder-plus', stepId: 'integration', phase: 0 },
            // AI Analysis (once)
            { id: 'ai-reasoning', type: 'ai', title: 'AI Analysis & Dependency Graph', icon: 'robot', stepId: 'ai-analysis', phase: 0 },
            // Operator Triage (once)
            { id: 'operator-cockpit', type: 'operator', title: 'Operator Triage', icon: 'headset', stepId: 'operator-triage', phase: 0 },
            // Contract (once)
            { id: 'contract-notification', type: 'customer', title: 'Contract Email/SMS', icon: 'envelope', stepId: 'contract', phase: 0 },
            { id: 'contract-portal', type: 'customer', title: 'Contract Portal', icon: 'file-signature', stepId: 'contract', phase: 0 },
            // Provider Matching (once - same provider for all services)
            { id: 'provider-funnel', type: 'system', title: 'Provider Matching', icon: 'filter', stepId: 'provider-match', phase: 0 },
            { id: 'provider-offer', type: 'provider', title: 'Provider Multi-Service Offer', icon: 'mobile-screen-button', stepId: 'provider-match', phase: 0 }
          ];

          // Loop mechanism for each service (4 services = 4 iterations)
          for (let i = 0; i < so.services.length; i++) {
            const service = so.services[i];
            const phase = i + 1;
            const serviceName = service.name;
            
            complexProjectCards.push(
              // Go Exec with dependencies check
              { id: `go-gate-check-${i}`, type: 'system', title: `Go Exec [${serviceName}]`, icon: 'traffic-light', stepId: 'go-gate', phase, serviceIndex: i },
              // Crew Execution
              { id: `crew-execution-${i}`, type: 'crew', title: `Crew Execution [${serviceName}]`, icon: 'mobile-screen-button', stepId: 'execution', phase, serviceIndex: i },
              // Quality Check Visit (replaces per-service WCF - done by independent specialist or operator)
              { id: `quality-visit-${i}`, type: 'operator', title: `Quality Check Visit [${serviceName}]`, icon: 'user-check', stepId: 'quality-visit', phase, serviceIndex: i },
              // Payment Authorization (unlocked by quality acceptance)
              { id: `payment-auth-${i}`, type: 'operator', title: `Payment Authorization [${serviceName}]`, icon: 'stamp', stepId: 'payment-auth', phase, serviceIndex: i },
              // Next Phase Unlock
              { id: `phase-unlock-${i}`, type: 'system', title: `Phase ${phase} Complete → Unlock Phase ${phase + 1}`, icon: 'unlock', stepId: 'phase-unlock', phase, serviceIndex: i }
            );
          }
          
          // Single WCF at the end (after all services complete)
          complexProjectCards.push(
            { id: 'wcf-notification', type: 'customer', title: 'WCF Email/SMS', icon: 'envelope', stepId: 'wcf', phase: so.services.length + 1 },
            { id: 'wcf-portal', type: 'customer', title: 'WCF Signature', icon: 'signature', stepId: 'wcf', phase: so.services.length + 1 },
            // Project Complete
            { id: 'project-complete', type: 'system', title: 'Project Complete', icon: 'flag-checkered', stepId: 'completion', phase: so.services.length + 1 }
          );
          
          return complexProjectCards.map((card, idx) => ({ ...card, index: idx }));
        }

        // Custom flow for Rework scenario (quality recovery with conditional payment)
        if (scenarioId === 'rework') {
          const reworkCards = [
            // Rework Trigger (WCF signed with reserves)
            { id: 'rework-trigger', type: 'customer', title: 'WCF Rejection Event', icon: 'triangle-exclamation', stepId: 'rework-trigger' },
            // Problem Assessment
            { id: 'problem-assessment', type: 'operator', title: 'Problem Assessment', icon: 'magnifying-glass', stepId: 'assessment' },
            { id: 'root-cause-analysis', type: 'operator', title: 'Root Cause Analysis', icon: 'microscope', stepId: 'assessment' },
            // Rework Decision
            { id: 'rework-decision', type: 'operator', title: 'Rework SO Creation', icon: 'folder-plus', stepId: 'decision' },
            // Provider Assignment Logic
            { id: 'provider-assignment', type: 'operator', title: 'Provider Assignment', icon: 'user-gear', stepId: 'provider-assignment' },
            { id: 'provider-notification', type: 'provider', title: 'Rework Provider Notification', icon: 'mobile-screen-button', stepId: 'provider-notification' },
            // Go Exec Gate
            { id: 'go-gate-check', type: 'system', title: 'Go Exec Gate (Rework)', icon: 'traffic-light', stepId: 'go-gate' },
            // Crew Execution (Rework)
            { id: 'crew-execution', type: 'crew', title: 'Crew Execution (Rework)', icon: 'mobile-screen-button', stepId: 'execution' },
            // Quality Check
            { id: 'quality-check', type: 'operator', title: 'Quality Check (Rework)', icon: 'user-check', stepId: 'quality-check' },
            // WCF (Customer acceptance)
            { id: 'wcf-notification', type: 'customer', title: 'WCF Email/SMS', icon: 'envelope', stepId: 'wcf' },
            { id: 'wcf-portal', type: 'customer', title: 'WCF Signature', icon: 'signature', stepId: 'wcf' },
            // Payment Authorization (Conditional)
            { id: 'payment-authorization', type: 'system', title: 'Payment Authorization', icon: 'stamp', stepId: 'payment' },
            // Rework Complete
            { id: 'rework-complete', type: 'system', title: 'Rework Complete', icon: 'circle-check', stepId: 'completion' }
          ];
          
          return reworkCards.map((card, idx) => ({ ...card, index: idx }));
        }

        // Custom flow for Maintenance scenario (asset service - NO products, NO Go Exec)
        if (scenarioId === 'maintenance') {
          const maintenanceCards = [
            // Sales Integration
            { id: 'kafka-message', type: 'data', title: 'Kafka Message', icon: 'server', stepId: 'integration' },
            { id: 'enrichment', type: 'system', title: 'Enrichment', icon: 'cogs', stepId: 'integration' },
            { id: 'so-creation', type: 'system', title: 'SO Creation', icon: 'folder-plus', stepId: 'integration' },
            // AI Analysis (understands it's maintenance, no products needed)
            { id: 'ai-reasoning', type: 'ai', title: 'AI Analysis', icon: 'robot', stepId: 'ai-analysis' },
            // Operator Triage
            { id: 'operator-cockpit', type: 'operator', title: 'Operator Triage', icon: 'headset', stepId: 'operator-triage' },
            // Contract (service agreement)
            { id: 'contract-notification', type: 'customer', title: 'Contract Email/SMS', icon: 'envelope', stepId: 'contract' },
            { id: 'contract-portal', type: 'customer', title: 'Contract Signature', icon: 'file-signature', stepId: 'contract' },
            // Provider Matching (maintenance specialist)
            { id: 'provider-funnel', type: 'system', title: 'Provider Matching', icon: 'filter', stepId: 'provider-match' },
            { id: 'provider-offer', type: 'provider', title: 'Provider Offer', icon: 'mobile-screen-button', stepId: 'provider-match' },
            // Asset Information (replaces product delivery - shows what's being maintained)
            { id: 'asset-details', type: 'system', title: 'Asset Information', icon: 'clipboard-list', stepId: 'asset-info' },
            // Provider Notification (with asset details)
            { id: 'provider-notification-maint', type: 'provider', title: 'Provider Job Details', icon: 'mobile-screen-button', stepId: 'provider-notification' },
            // NO GO EXEC - Jump directly to execution (provider brings own parts)
            // Crew Execution (maintenance work)
            { id: 'crew-execution-maint', type: 'crew', title: 'Crew Execution', icon: 'wrench', stepId: 'execution' },
            // WCF (work completion)
            { id: 'wcf-notification', type: 'customer', title: 'WCF Email/SMS', icon: 'envelope', stepId: 'wcf' },
            { id: 'wcf-portal', type: 'customer', title: 'WCF Signature', icon: 'signature', stepId: 'wcf' },
            // Service Report (maintenance-specific - shows work performed, parts used, recommendations)
            { id: 'service-report', type: 'system', title: 'Service Report Generation', icon: 'file-medical', stepId: 'service-report' },
            // Payment Authorization
            { id: 'payment-auth-maint', type: 'system', title: 'Payment Authorization', icon: 'stamp', stepId: 'payment' },
            // Maintenance Complete
            { id: 'maintenance-complete', type: 'system', title: 'Maintenance Complete', icon: 'circle-check', stepId: 'completion' }
          ];
          
          return maintenanceCards.map((card, idx) => ({ ...card, index: idx }));
        }

        // Custom flow for Dépannage scenario (urgent service - expedited multi-provider bidding, first-to-accept wins)
        if (scenarioId === 'depannage') {
          const depannageCards = [
            // Initial Sales Integration (customer purchases urgent service online/in-store)
            { id: 'kafka-message', type: 'data', title: 'Kafka Message', icon: 'server', stepId: 'integration' },
            { id: 'enrichment', type: 'system', title: 'Enrichment', icon: 'cogs', stepId: 'integration' },
            { id: 'project-creation', type: 'system', title: 'SO Creation', icon: 'folder-plus', stepId: 'integration' },
            { id: 'ai-reasoning', type: 'ai', title: 'AI Analysis', icon: 'robot', stepId: 'ai-analysis' },
            { id: 'operator-cockpit', type: 'operator', title: 'Operator Triage', icon: 'headset', stepId: 'operator-triage' },
            // Expedited Multi-Provider Dispatch (5 providers contacted simultaneously)
            { id: 'multi-provider-dispatch', type: 'system', title: 'Multi-Provider Dispatch', icon: 'tower-broadcast', stepId: 'multi-dispatch' },
            { id: 'provider-bidding-race', type: 'system', title: 'Provider Bidding Race', icon: 'stopwatch', stepId: 'bidding-race' },
            { id: 'first-acceptance', type: 'provider', title: 'First Provider Accepts', icon: 'hand-point-up', stepId: 'first-accept' },
            { id: 'offers-withdrawal', type: 'system', title: 'Offers Withdrawn from Others', icon: 'ban', stepId: 'withdrawal' },
            // Provider Dispatched
            { id: 'provider-dispatch-notification', type: 'provider', title: 'Provider Dispatch Confirmed', icon: 'mobile-screen-button', stepId: 'provider-dispatch' },
            { id: 'customer-eta-notification', type: 'customer', title: 'Customer ETA Notification', icon: 'clock', stepId: 'customer-eta' },
            // On-Site Work
            { id: 'onsite-assessment', type: 'crew', title: 'On-Site Assessment', icon: 'clipboard-check', stepId: 'assessment' },
            { id: 'urgent-execution', type: 'crew', title: 'Urgent Service Execution', icon: 'wrench', stepId: 'execution' },
            // WCF (work completion)
            { id: 'wcf-notification', type: 'customer', title: 'WCF Email/SMS', icon: 'envelope', stepId: 'wcf' },
            { id: 'wcf-portal', type: 'customer', title: 'WCF Signature', icon: 'signature', stepId: 'wcf' },
            // Provider Invoice & Payment (platform pays provider)
            { id: 'invoice-portal-dep', type: 'provider', title: 'Pro Forma Invoice', icon: 'file-invoice', stepId: 'invoice' },
            { id: 'invoice-dataflow', type: 'data', title: 'Invoice Dataflow', icon: 'exchange-alt', stepId: 'invoice' },
            { id: 'payment-authorization-dep', type: 'system', title: 'Provider Payment Authorization', icon: 'stamp', stepId: 'payment-auth' },
            { id: 'payment-portal-dep', type: 'provider', title: 'Provider Payment', icon: 'credit-card', stepId: 'provider-payment' },
            // Service Complete (B2B: customer paid retailer at purchase, platform pays provider after completion)
            { id: 'depannage-complete', type: 'system', title: 'Dépannage Service Complete', icon: 'circle-check', stepId: 'completion' }
          ];
          
          return depannageCards.map((card, idx) => ({ ...card, index: idx }));
        }

        // Custom flow for Subscription scenario (recurring service with auto-scheduling)
        if (scenarioId === 'subscription') {
          const subscriptionCards = [
            // Initial Sales Integration (subscription purchase)
            { id: 'kafka-message', type: 'data', title: 'Kafka Message', icon: 'server', stepId: 'integration' },
            { id: 'enrichment', type: 'system', title: 'Enrichment', icon: 'cogs', stepId: 'integration' },
            { id: 'project-creation', type: 'system', title: 'SO Creation', icon: 'folder-plus', stepId: 'integration' },
            { id: 'ai-reasoning', type: 'ai', title: 'AI Analysis', icon: 'robot', stepId: 'ai-analysis' },
            { id: 'operator-cockpit', type: 'operator', title: 'Operator Triage', icon: 'headset', stepId: 'operator-triage' },
            // Service Reminder (auto-sent 2 weeks before)
            { id: 'service-reminder', type: 'customer', title: 'Service Reminder', icon: 'bell', stepId: 'reminder' },
            // Schedule Confirmation (customer confirms/reschedules)
            { id: 'schedule-confirmation', type: 'customer', title: 'Schedule Confirmation', icon: 'calendar-check', stepId: 'confirmation' },
            // Provider Assignment (preferably same technician)
            { id: 'provider-assignment-sub', type: 'system', title: 'Provider Assignment', icon: 'user-check', stepId: 'provider-assignment' },
            // Provider Notification (with asset history)
            { id: 'provider-notification-sub', type: 'provider', title: 'Provider Job Notification', icon: 'mobile-screen-button', stepId: 'provider-notification' },
            // Asset History Review (provider sees previous visits)
            { id: 'asset-history', type: 'system', title: 'Asset Service History', icon: 'history', stepId: 'asset-history' },
            // Crew Execution (subscription maintenance)
            { id: 'crew-execution-sub', type: 'crew', title: 'Crew Execution', icon: 'wrench', stepId: 'execution' },
            // WCF (work completion)
            { id: 'wcf-notification', type: 'customer', title: 'WCF Email/SMS', icon: 'envelope', stepId: 'wcf' },
            { id: 'wcf-portal', type: 'customer', title: 'WCF Signature', icon: 'signature', stepId: 'wcf' },
            // Service Report (health tracking)
            { id: 'service-report-sub', type: 'system', title: 'Service Report & Health Score', icon: 'file-medical', stepId: 'service-report' },
            // Provider Invoice & Payment
            { id: 'invoice-portal-sub', type: 'provider', title: 'Pro Forma Invoice', icon: 'file-invoice', stepId: 'invoice' },
            { id: 'invoice-dataflow', type: 'data', title: 'Invoice Dataflow', icon: 'exchange-alt', stepId: 'invoice' },
            { id: 'payment-authorization-sub', type: 'system', title: 'Provider Payment Authorization', icon: 'stamp', stepId: 'payment-auth' },
            { id: 'payment-portal-sub', type: 'provider', title: 'Provider Payment', icon: 'credit-card', stepId: 'provider-payment' },
            // Next Service Auto-Schedule
            { id: 'auto-schedule-next', type: 'system', title: 'Auto-Schedule Next Service', icon: 'calendar-plus', stepId: 'auto-schedule' },
            // Subscription Continue
            { id: 'subscription-continues', type: 'system', title: 'Subscription Active', icon: 'rotate', stepId: 'subscription-active' }
          ];
          
          return subscriptionCards.map((card, idx) => ({ ...card, index: idx }));
        }
        
        const activeSteps = scenarioSteps[scenarioId] || steps;
        
        for (const [stepIdx, step] of activeSteps.entries()) {
          const stepCards = journeyCards[step.id] || [];
          for (const card of stepCards) {
            cards.push({
              ...card,
              stepId: step.id,
              stepIndex: stepIdx,
              stepTitle: step.title,
              globalIndex: cardIndex++
            });
          }
        }
        
        // Add invoice and payment cards
        for (const card of invoicePaymentCards) {
          cards.push({
            ...card,
            stepIndex: activeSteps.length,
            stepTitle: card.stepId === 'invoice' ? 'Invoice' : 'Payment',
            globalIndex: cardIndex++
          });
        }
        
        return cards;
      };

      // Flatten all cards with step context
      let allCards = [];
      let cardIndex = 0;
      for (const [stepIdx, step] of steps.entries()) {
        const cards = journeyCards[step.id] || [];
        for (const card of cards) {
          allCards.push({
            ...card,
            stepId: step.id,
            stepIndex: stepIdx,
            stepTitle: step.title,
            globalIndex: cardIndex++
          });
        }
      }
      
      // Add invoice and payment cards
      for (const card of invoicePaymentCards) {
        allCards.push({
          ...card,
          stepIndex: steps.length,
          stepTitle: card.stepId === 'invoice' ? 'Invoice' : 'Payment',
          globalIndex: cardIndex++
        });
      }

      let currentCardIndex = 0;

      // Card rendering functions
      const renderKafkaMessageCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-server"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">New sales order received from ${so.salesChannel}</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1rem;"><i class="fas fa-stream"></i> Kafka Event</h3>
              <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; background: #000; padding: 1rem; border-radius: 8px; overflow-x: auto;">
                <div style="color: #49d493;">Topic: <span style="color: #fff;">sales.orders.created</span></div>
                <div style="color: #49d493;">Partition: <span style="color: #fff;">3</span></div>
                <div style="color: #49d493;">Offset: <span style="color: #fff;">982471</span></div>
                <div style="color: #49d493;">Key: <span style="color: #fff;">${so.orderId}</span></div>
              </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1rem;"><i class="fas fa-code"></i> Complete Message Payload</h3>
              <div style="font-family: 'Courier New', monospace; font-size: 0.75rem; background: #000; padding: 1.5rem; border-radius: 8px; max-height: 400px; overflow-y: auto; line-height: 1.7;">
                <div><span style="color: #49d493;">{</span></div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"orderId"</span>: <span style="color: #fff;">"${so.orderId}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"salesChannel"</span>: <span style="color: #fff;">"${so.salesChannel}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"store"</span>: <span style="color: #fff;">"${so.store}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"salesProjectId"</span>: <span style="color: #fff;">"${so.salesProjectId || 'null'}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"leadId"</span>: <span style="color: #fff;">"${so.leadId || 'null'}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"quotation"</span>: <span style="color: #fff;">${so.linkedQuotation ? '"' + so.linkedQuotation + '"' : 'null'}</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"salesman"</span>: <span style="color: #fff;">"${so.salesman}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"salesmanEmail"</span>: <span style="color: #fff;">"${so.salesmanEmail}"</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"customer"</span>: <span style="color: #49d493;">{</span></div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"customerId"</span>: <span style="color: #fff;">"${so.customer.customerId}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"name"</span>: <span style="color: #fff;">"${so.customer.name}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"email"</span>: <span style="color: #fff;">"${so.customer.email}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"phone"</span>: <span style="color: #fff;">"${so.customer.phone}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"address"</span>: <span style="color: #fff;">"${so.customer.address}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"city"</span>: <span style="color: #fff;">"${so.customer.city}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"tier"</span>: <span style="color: #fff;">"${so.customer.tier}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"lifetimeValue"</span>: <span style="color: #4eabff;">${so.customer.lifetimeValue}</span></div>
                <div style="padding-left: 1rem;"><span style="color: #49d493;">}</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"products"</span>: <span style="color: #c084fc;">[</span></div>
                ${so.products.map((p, idx) => `
                  <div style="padding-left: 2rem;"><span style="color: #49d493;">{</span></div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"sku"</span>: <span style="color: #fff;">"${p.sku}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"name"</span>: <span style="color: #fff;">"${p.name}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"quantity"</span>: <span style="color: #4eabff;">${p.quantity}</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"unitPrice"</span>: <span style="color: #4eabff;">${p.unitPrice}</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"deliveryDate"</span>: <span style="color: #fff;">"${p.deliveryDate}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"stockStatus"</span>: <span style="color: #fff;">"${p.stockStatus}"</span></div>
                  <div style="padding-left: 2rem;"><span style="color: #49d493;">}</span>${idx < so.products.length - 1 ? ',' : ''}</div>
                `).join('')}
                <div style="padding-left: 1rem;"><span style="color: #c084fc;">]</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"services"</span>: <span style="color: #c084fc;">[</span></div>
                ${so.services.map((s, idx) => `
                  <div style="padding-left: 2rem;"><span style="color: #49d493;">{</span></div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"code"</span>: <span style="color: #fff;">"${s.code}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"name"</span>: <span style="color: #fff;">"${s.name}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"scheduledDate"</span>: <span style="color: #fff;">"${s.scheduledDate}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"timeSlot"</span>: <span style="color: #fff;">"${s.timeSlot}"</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"duration"</span>: <span style="color: #4eabff;">${s.duration}</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"unitPrice"</span>: <span style="color: #4eabff;">${s.unitPrice}</span>,</div>
                  <div style="padding-left: 3rem;"><span style="color: #fbbf24;">"skillLevel"</span>: <span style="color: #fff;">"${s.skillLevel}"</span></div>
                  <div style="padding-left: 2rem;"><span style="color: #49d493;">}</span>${idx < so.services.length - 1 ? ',' : ''}</div>
                `).join('')}
                <div style="padding-left: 1rem;"><span style="color: #c084fc;">]</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"payment"</span>: <span style="color: #49d493;">{</span></div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"status"</span>: <span style="color: #49d493;">"${so.payment.status}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"method"</span>: <span style="color: #fff;">"${so.payment.method}"</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"paidAmount"</span>: <span style="color: #4eabff;">${so.payment.paidAmount}</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"transactionId"</span>: <span style="color: #fff;">"${so.payment.transactionId}"</span></div>
                <div style="padding-left: 1rem;"><span style="color: #49d493;">}</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"totals"</span>: <span style="color: #49d493;">{</span></div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"subtotal"</span>: <span style="color: #4eabff;">${so.totals.subtotal}</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"tax"</span>: <span style="color: #4eabff;">${so.totals.totalTax}</span>,</div>
                <div style="padding-left: 2rem;"><span style="color: #fbbf24;">"total"</span>: <span style="color: #4eabff;">${so.totals.total}</span></div>
                <div style="padding-left: 1rem;"><span style="color: #49d493;">}</span>,</div>
                <div style="padding-left: 1rem;"><span style="color: #fbbf24;">"sellerNotes"</span>: <span style="color: #fff;">"${so.sellerNotes ? so.sellerNotes.substring(0, 50) + '...' : 'None'}"</span></div>
                <div><span style="color: #49d493;">}</span></div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                System Processing <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProjectCreationCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-cogs"></i> AUTOMATED
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Creating service order and linking to sales project</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-search" style="color: var(--accent-blue);"></i>
                  Existing Projects Check
                </h3>
                <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
                  Searching for active projects for customer ${so.customer.customerId}...
                </div>
                <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 8px; padding: 1rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    <strong>Project Found</strong>
                  </div>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">
                    Project: ${so.salesProjectId}<br>
                    Status: Active<br>
                    Created: ${so.customer.customerSince}
                  </div>
                </div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-link" style="color: var(--yellow);"></i>
                  Service Order Linking
                </h3>
                <div style="background: rgba(255, 203, 50, 0.08); border: 1px solid rgba(255, 203, 50, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                  <div style="font-weight: 600; margin-bottom: 0.5rem;">Action Taken:</div>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">
                    ✓ Linked to Sales Project <strong>SALES-PROJ-1244</strong><br>
                    ✓ Customer context preserved<br>
                    ✓ Historical data accessible
                  </div>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                  <i class="fas fa-info-circle"></i> Enables: cross-order analytics, bundled contracts, unified customer view
                </div>
              </div>
            </div>

            <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <h4 style="margin-bottom: 1rem;"><i class="fas fa-folder-open"></i> Project Context</h4>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                <div style="text-align: center;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-blue);">3</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Total Orders</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">€${so.customer.lifetimeValue}</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Project Value</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--yellow);">${so.customer.tier}</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Customer Tier</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">0</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Claims</div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Send to AI Analysis <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderEnrichmentCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-cogs"></i> AUTOMATED
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Enriching order with business context</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Service Requirements Set</strong>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-muted); line-height: 1.7;">
                  <strong>Service List and Requirements:</strong><br>
                  ${so.services.map((s, idx) => `Service ${idx + 1} - Quantity: ${s.quantity} - Slots ${s.duration} min - ${s.skillLevel}`).join('<br>')}<br>
                  <strong style="color: var(--accent-green);">Total slots required: ${so.services.reduce((sum, s) => sum + (s.duration * s.quantity), 0)} min</strong>
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Product Data Enriched</strong>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-muted); line-height: 1.7;">
                  ${so.products && so.products.length > 0 ? `
                    <strong>Products delivery dates:</strong><br>
                    ${so.products.map((p, idx) => `Product ${idx + 1} - ${p.deliveryDate || 'TBD'}`).join('<br>')}<br>
                    <strong style="color: var(--accent-green);">Max Product Delivery Date - ${so.products[0]?.deliveryDate || 'N/A'}</strong>
                  ` : `
                    <strong>No products in this order</strong><br>
                    This is a service-only order<br>
                    <em style="color: var(--accent-green);">No product delivery required</em>
                  `}
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Customer Profile</strong>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-muted); line-height: 1.7;">
                  <strong>Name:</strong> ${so.customer.name}<br>
                  <strong>Tier:</strong> ${so.customer.tier}<br>
                  <strong>LTV:</strong> €${so.customer.lifetimeValue}<br>
                  <strong>Claims:</strong> ${so.customer.claimHistory}<br>
                  <strong>Email:</strong> ${so.customer.email}<br>
                  <strong>Mobile:</strong> ${so.customer.phone}
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Project Linked</strong>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-muted); line-height: 1.7;">
                  <strong>Sales Project:</strong> ${so.salesProjectId}<br>
                  ${so.linkedPreEstimation ? `<strong>Pre-estimation:</strong> ${so.linkedPreEstimation}<br>` : ''}
                  ${so.linkedQuotation ? `<strong>Sales Quotation/Devis:</strong> ${so.linkedQuotation}<br>` : ''}
                  <strong>Lead:</strong> ${so.leadId}
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Send to AI Analysis <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderAIReasoningCard = (so, card) => {
        const riskScore = so.customer.claimHistory > 0 ? 67 : 23;
        const riskLevel = riskScore > 50 ? 'MEDIUM' : 'LOW';
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-robot"></i> AI ENGINE
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Analyzing order risk, scheduling, and resource matching</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 3rem; color: var(--accent-${riskLevel === 'LOW' ? 'green' : 'orange'}); margin-bottom: 0.5rem;">${riskScore}</div>
                <div style="font-weight: 600; margin-bottom: 0.3rem;">Risk Score</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">${riskLevel} RISK</div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 3rem; color: var(--accent-blue); margin-bottom: 0.5rem;">${so.services.length}</div>
                <div style="font-weight: 600; margin-bottom: 0.3rem;">Service${so.services.length > 1 ? 's' : ''} Planned</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">Total: ${so.services.reduce((sum, s) => sum + (s.duration * s.quantity), 0)} min</div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 3rem; color: var(--yellow); margin-bottom: 0.5rem;">✓</div>
                <div style="font-weight: 600; margin-bottom: 0.3rem;">Schedule Valid</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);">COMPLIANT</div>
              </div>
            </div>

            <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1rem;"><i class="fas fa-brain"></i> AI Recommendations</h3>
              <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                  <span><strong>Pilote du chantier recommended:</strong> Lia Santos (PL-LIA) - Current load: ${so.services.length > 1 ? '3 projects - 1340' : '2 projects - 850'} min of services to be executed</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                  <span><strong>Schedule:</strong> ${so.services[0].scheduledDate} ${so.services[0].timeSlot} (Compliant - weekday AM)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-project-diagram" style="color: var(--accent-blue);"></i>
                  <span><strong>Project:</strong> ${so.salesProjectId} ${so.linkedQuotation ? '(Quotation: ' + so.linkedQuotation + ')' : '(New project)'}</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-${so.products.length > 0 ? 'box' : 'tools'}" style="color: var(--yellow);"></i>
                  <span><strong>Project Name Update to:</strong> Kitchen Remodeling</span>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Send to Operator <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderOperatorCockpitCard = (so, card) => {
        const riskLevel = so.customer.claimHistory > 0 ? 'MEDIUM' : 'LOW';
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(255, 203, 50, 0.15); color: var(--yellow); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-headset"></i> OPERATOR
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Control Tower Cockpit</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Service Operator: Lia Santos</p>
            </div>

            ${renderOperatorCockpitContent(so, riskLevel)}

            <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary">Override Risk</button>
                <button class="btn btn-primary" onclick="dashboard.nextCard()">
                  ✓ Confirm & Send Contract <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      };

      const renderOperatorCockpitContent = (so, riskLevel) => {
        return `
          <div class="cockpit-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="cockpit-card" style="background: linear-gradient(135deg, rgba(78, 168, 255, 0.1), rgba(78, 168, 255, 0.05)); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 12px; padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; color: var(--accent-blue);">Risk Score</span>
                <i class="fas fa-${riskLevel === 'LOW' ? 'shield-check' : 'shield-exclamation'}" style="color: var(--accent-${riskLevel === 'LOW' ? 'green' : 'orange'}); font-size: 1.3rem;"></i>
              </div>
              <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-${riskLevel === 'LOW' ? 'green' : 'orange'}); margin-bottom: 0.5rem;">${riskLevel === 'LOW' ? '23' : '67'}</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">
                ${riskLevel === 'LOW' ? 'No red flags' : 'Previous claim + quotation'}
              </div>
            </div>
            
            <div class="cockpit-card" style="background: linear-gradient(135deg, rgba(255, 203, 50, 0.1), rgba(255, 203, 50, 0.05)); border: 1px solid rgba(255, 203, 50, 0.3); border-radius: 12px; padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; color: var(--yellow);">Customer Tier</span>
                <i class="fas fa-crown" style="color: var(--yellow); font-size: 1.3rem;"></i>
              </div>
              <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">${so.customer.tier}</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">
                LTV: €${so.customer.lifetimeValue}
              </div>
            </div>
            
            <div class="cockpit-card" style="background: linear-gradient(135deg, rgba(73, 212, 147, 0.1), rgba(73, 212, 147, 0.05)); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; color: var(--accent-green);">Payment</span>
                <i class="fas fa-${so.payment.status === 'Paid' ? 'circle-check' : 'clock'}" style="color: var(--accent-${so.payment.status === 'Paid' ? 'green' : 'orange'}); font-size: 1.3rem;"></i>
              </div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--accent-${so.payment.status === 'Paid' ? 'green' : 'orange'}); margin-bottom: 0.5rem;">${so.payment.status.toUpperCase()}</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">
                ${so.payment.status === 'Paid' ? `€${so.payment.paidAmount}` : `Due: ${so.payment.dueDate || 'N/A'}`}
              </div>
            </div>
          </div>

          <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 8px; padding: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
              <i class="fas fa-robot" style="color: var(--accent-purple);"></i>
              <strong style="color: var(--accent-purple);">AI Recommendations Accepted</strong>
            </div>
            <div style="font-size: 0.9rem; line-height: 1.7;">
              ✓ Pilote du chantier recommended: Lia Santos (PL-LIA) - Current load: ${so.services.length > 1 ? '3 projects - 1340' : '2 projects - 850'} min of services to be executed<br>
              ✓ Schedule: ${so.services[0].scheduledDate} ${so.services[0].timeSlot} (Compliant - weekday AM)<br>
              ✓ Service: ${so.services[0].name}<br>
              ✓ Project: ${so.salesProjectId}${so.linkedQuotation ? ' (Quotation: ' + so.linkedQuotation + ')' : ''}
            </div>
          </div>
        `;
      };

      const renderContractNotificationCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user"></i> CUSTOMER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Email & SMS sent to ${so.customer.name}</p>
            </div>

            <div class="email-mockup" style="background: #fff; color: #333; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 600px; margin: 0 auto 2rem;">
              <div class="email-header" style="padding: 1.5rem; border-bottom: 1px solid #e5e5e5;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                  <div style="background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1rem; font-weight: 700; border-radius: 4px;">YellowGrid</div>
                  <div style="flex: 1;"></div>
                  <div style="font-size: 0.85rem; color: #666;">Just now</div>
                </div>
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                  <strong>From:</strong> contracts@yellowgrid.pt
                </div>
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.3rem;">
                  <strong>To:</strong> ${so.customer.email}
                </div>
                <div style="font-size: 1.1rem; font-weight: 700; margin-top: 0.8rem;">
                  Service Contract Ready for Signature
                </div>
              </div>
              <div class="email-body" style="padding: 1.5rem;">
                <p>Dear ${so.customer.firstName},</p>
                <p style="margin: 1rem 0;">Your service contract is ready. Please sign within 48 hours to confirm your ${so.services[0].scheduledDate} appointment.</p>
                <div style="text-align: center; margin: 1.5rem 0;">
                  <div style="background: var(--yellow); color: #1a1a1a; padding: 1rem 2rem; border-radius: 8px; display: inline-block; font-weight: 700; cursor: pointer;">
                    <i class="fas fa-file-signature"></i> Review & Sign Contract
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Customer Opens Email <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderContractPortalCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user"></i> CUSTOMER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Contract Signature Portal</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">${so.customer.name} reviewing contract</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 2px solid var(--border); border-radius: 12px; padding: 2rem; max-width: 800px; margin: 0 auto 2rem;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="display: inline-block; background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1.5rem; font-weight: 700; border-radius: 4px; margin-bottom: 1rem;">YellowGrid</div>
                <h3 style="font-size: 1.8rem; margin-bottom: 0.5rem;">Service Contract</h3>
                <p style="color: var(--text-muted);">Total: <strong style="color: var(--yellow); font-size: 1.5rem;">€${so.totals.total}</strong></p>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 2px solid rgba(73, 212, 147, 0.4); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <i class="fas fa-check-circle" style="font-size: 2.5rem; color: var(--accent-green);"></i>
                  <div style="flex: 1;">
                    <strong style="font-size: 1.2rem; color: var(--accent-green);">I Accept Terms & Conditions</strong>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">Authorize service execution on ${so.services[0].scheduledDate}</p>
                  </div>
                </div>
              </div>

              <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 1.5rem; text-align: center; margin-bottom: 1.5rem;">
                <i class="fas fa-signature" style="font-size: 2rem; color: var(--yellow); margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.2rem; font-style: italic; margin-top: 1rem;">${so.customer.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Signed: ${new Date().toLocaleDateString('en-GB')}</div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                <i class="fas fa-check-circle"></i> Sign Contract <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProviderFunnelCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-robot"></i> AI MATCHING
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Provider Selection Funnel</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Scoring and ranking providers</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-trophy"></i> Top Candidates</h3>
              
              <div style="background: linear-gradient(135deg, rgba(255, 203, 50, 0.15), rgba(255, 203, 50, 0.05)); border: 2px solid var(--yellow); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 0.3rem;">🥇 Provider L - Rui Lopes</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Lisboa Region • 2 technicians • Level 3</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--yellow);">92</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Match Score</div>
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">DISTANCE</div>
                    <div style="font-weight: 600;">8.2 km</div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">AVAILABILITY</div>
                    <div style="font-weight: 600; color: var(--accent-green);">Available</div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">SLA</div>
                    <div style="font-weight: 600;">T+48h</div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">RATING</div>
                    <div style="font-weight: 600;">4.8 ⭐</div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem;">🥈 Provider M - João Silva</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Lisboa Region • 3 technicians • Level 3</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--text-muted);">85</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Score</div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem;">🥉 Provider N - Pedro Costa</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Lisboa Region • 1 technician • Level 2</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--text-muted);">78</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Score</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <i class="fas fa-robot" style="color: var(--accent-purple);"></i>
                <strong style="color: var(--accent-purple);">AI Decision</strong>
              </div>
              <div style="font-size: 0.95rem;">Sending offer to Provider L (score 92/100). Higher availability, closer location, better historical performance.</div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Send Offer to Provider L <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProviderOfferCard = (so, card) => {
        const isBundle = currentScenario === 'package-deal' && so.services.length > 1;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(251, 191, 36, 0.15); color: var(--accent-orange); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-handshake"></i> PROVIDER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Provider Mobile App</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Provider L - Rui Lopes</p>
            </div>

            <div class="mobile-screen" style="max-width: 400px; margin: 0 auto 2rem; background: #000; border-radius: 32px; padding: 1.5rem 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
              <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 1.3rem; font-weight: 700;">YellowGrid Pro</div>
              </div>

              <div class="mobile-card" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1a1405; padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">${isBundle ? 'Service Bundle Offer' : 'New Job Offer'}</div>
                <div style="font-size: 1.8rem; font-weight: 700; margin-bottom: 0.3rem;">${so.customer.city}</div>
                <div style="font-size: 0.9rem;">
                  ${isBundle ? 'TV + Installation Package' : so.services[0].name}
                </div>
              </div>

              <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                ${isBundle ? `
                  <div style="background: rgba(192, 132, 252, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--accent-purple);">
                      <i class="fas fa-layer-group"></i> BUNDLE: 2 Services
                    </div>
                    <div style="font-size: 0.85rem; line-height: 1.6;">
                      1. ${so.services[0].name} (${so.services[0].scheduledDate})<br>
                      2. ${so.services[1].name} (${so.services[1].scheduledDate})<br>
                      <span style="color: var(--accent-purple); font-weight: 600;">Installation check-in blocked until TV completed</span>
                    </div>
                  </div>
                ` : ''}
                <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem;">${isBundle ? 'Service #1: ' : ''}${so.services[0].name}</div>
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                  <div style="flex: 1;">
                    <div style="font-size: 0.75rem; color: #999; margin-bottom: 0.3rem;">DATE</div>
                    <div style="font-weight: 600;">${so.services[0].scheduledDate}</div>
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 0.75rem; color: #999; margin-bottom: 0.3rem;">TIME</div>
                    <div style="font-weight: 600;">${so.services[0].timeSlot}</div>
                  </div>
                </div>
                <div style="background: rgba(73, 212, 147, 0.2); padding: 0.8rem; border-radius: 8px; font-size: 0.9rem; margin-bottom: 1rem;">
                  <strong style="color: #49d493;"><i class="fas fa-check"></i> Your Crew Available</strong><br>
                  <span style="color: #ccc;">Rui Lopes • 2 installers • SLA: T+48h</span>
                </div>

                <div style="background: rgba(255, 203, 50, 0.15); border: 1px solid rgba(255, 203, 50, 0.4); padding: 0.8rem; border-radius: 8px; font-size: 0.9rem; margin-bottom: 1rem;">
                  <strong style="color: var(--yellow);"><i class="fas fa-clock"></i> Expires in 1h 47min</strong><br>
                  <span style="color: #999;">Respond before offer expires</span>
                </div>

                <button style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #49d493, #31a576); color: #000; font-weight: 700; border: none; border-radius: 12px; cursor: pointer; margin-bottom: 0.75rem;">
                  <i class="fas fa-check"></i> Accept Offer
                </button>
                <button style="width: 100%; padding: 1rem; background: rgba(78, 168, 255, 0.2); color: var(--accent-blue); font-weight: 600; border: 1px solid var(--accent-blue); border-radius: 12px; cursor: pointer; margin-bottom: 0.75rem;">
                  <i class="fas fa-calendar-alt"></i> Accept & Propose Different Date
                </button>
                <button style="width: 100%; padding: 0.8rem; background: rgba(255, 255, 255, 0.05); color: #999; font-weight: 600; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer;">
                  <i class="fas fa-times"></i> Refuse Offer
                </button>
              </div>

              <div style="background: rgba(78, 168, 255, 0.1); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 12px; padding: 0.75rem; text-align: center;">
                <div style="font-size: 0.8rem;">
                  <i class="fas fa-info-circle" style="color: var(--accent-blue);"></i>
                  <span style="color: #999;"> Auto-accepted for ES/IT markets</span>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Provider Accepted <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderGoGateCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(73, 212, 147, 0.15); color: var(--accent-green); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-shield-check"></i> AUTOMATED
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Verifying readiness for execution</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Contract Signed</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  Customer signature received
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Payment Verified</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  €${so.payment.paidAmount} confirmed
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Provider Confirmed</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  Rui Lopes crew assigned
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 12px; padding: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-check-circle" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <strong style="font-size: 1.1rem;">Stock Available</strong>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                  Products ready for delivery
                </div>
              </div>
            </div>

            <div style="background: rgba(73, 212, 147, 0.15); border: 2px solid var(--accent-green); border-radius: 12px; padding: 2rem; text-align: center; margin-bottom: 2rem;">
              <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--accent-green); margin-bottom: 1rem;"></i>
              <h3 style="font-size: 1.5rem; color: var(--accent-green); margin-bottom: 0.5rem;">GO-EXEC APPROVED</h3>
              <p style="color: var(--text-muted);">All conditions met. Service ready for execution.</p>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Unblock Check-in <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderCrewExecutionCard = (so, card) => {
        const mainService = so.services.length > 1 ? so.services[1] : so.services[0];
        const hasProducts = so.products && so.products.length > 0;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-hard-hat"></i> CREW
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Crew Mobile App</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Rui Lopes - Crew Lead</p>
            </div>

            <div class="mobile-screen" style="max-width: 400px; margin: 0 auto 2rem; background: #000; border-radius: 32px; padding: 1.5rem 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
              <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 1.3rem; font-weight: 700;">YellowGrid Pro</div>
                <div style="font-size: 0.85rem; color: #999; margin-top: 0.3rem;">Service Execution</div>
              </div>

              <div style="background: linear-gradient(135deg, #49d493, #38a169); color: #fff; padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">
                  <i class="fas fa-check-circle"></i> Checked In
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem;">Job #SRV-${so.orderId.split('-')[2]}</div>
                <div style="font-size: 0.9rem;">Started ${mainService.timeSlot.split('-')[0]} • Duration: ${mainService.duration} min</div>
              </div>

              <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                  <div style="font-size: 1.1rem; font-weight: 700;">${so.customer.name}</div>
                  <a href="tel:${so.customer.phone}" style="padding: 0.5rem 0.8rem; background: rgba(73, 212, 147, 0.2); color: var(--accent-green); border-radius: 8px; text-decoration: none; font-size: 0.85rem;">
                    <i class="fas fa-phone"></i> Call
                  </a>
                </div>
                
                <div style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.8rem; padding: 0.8rem; background: rgba(78, 168, 255, 0.1); border-radius: 8px;">
                  <i class="fas fa-map-marker-alt" style="color: var(--accent-blue); margin-top: 0.2rem;"></i>
                  <div style="flex: 1;">
                    <div style="font-size: 0.9rem; line-height: 1.4;">${so.customer.addressLine1}${so.customer.addressLine2 ? '<br>' + so.customer.addressLine2 : ''}</div>
                    <div style="font-size: 0.85rem; color: #999; margin-top: 0.3rem;">${so.customer.postalCode} ${so.customer.city}</div>
                  </div>
                  <button style="padding: 0.5rem 0.8rem; background: rgba(78, 168, 255, 0.2); color: var(--accent-blue); border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer;">
                    <i class="fas fa-route"></i>
                  </button>
                </div>

                <div style="background: rgba(192, 132, 252, 0.15); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem;">
                  <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-purple);"><i class="fas fa-clipboard-list"></i> Service Details</div>
                  <div style="font-size: 0.85rem; line-height: 1.6;">
                    <strong>Type:</strong> ${mainService.name}<br>
                    <strong>Category:</strong> ${mainService.category}<br>
                    <strong>Duration:</strong> ${mainService.duration} min<br>
                    <strong>Skill:</strong> ${mainService.skillLevel}
                  </div>
                </div>

                ${hasProducts ? `
                  <div style="background: rgba(251, 191, 36, 0.15); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-orange);"><i class="fas fa-box"></i> Products to Install</div>
                    ${so.products.map(p => `
                      <div style="font-size: 0.85rem; margin-bottom: 0.3rem;">
                        • ${p.name}<br>
                        <span style="color: #999; font-size: 0.8rem;">SKU: ${p.sku} | ${p.brand}</span>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}

                ${mainService.equipmentNeeded && mainService.equipmentNeeded.length > 0 ? `
                  <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;"><i class="fas fa-toolbox"></i> Equipment Needed</div>
                    <div style="font-size: 0.8rem; color: #ccc; line-height: 1.5;">
                      ${mainService.equipmentNeeded.map(eq => `• ${eq}`).join('<br>')}
                    </div>
                  </div>
                ` : ''}

                ${mainService.safetyRequirements && mainService.safetyRequirements.length > 0 ? `
                  <div style="background: rgba(239, 68, 68, 0.15); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Safety Requirements</div>
                    <div style="font-size: 0.8rem; color: #fca5a5; line-height: 1.5;">
                      ${mainService.safetyRequirements.map(sr => `• ${sr}`).join('<br>')}
                    </div>
                  </div>
                ` : ''}

                ${so.specialInstructions ? `
                  <div style="background: rgba(78, 168, 255, 0.1); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-blue);"><i class="fas fa-info-circle"></i> Special Instructions</div>
                    <div style="font-size: 0.8rem; color: #ccc; line-height: 1.5;">
                      ${so.specialInstructions.substring(0, 150)}${so.specialInstructions.length > 150 ? '...' : ''}
                    </div>
                  </div>
                ` : ''}
              </div>

              <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.8rem;">
                  <button style="padding: 0.8rem; background: rgba(73, 212, 147, 0.2); color: var(--accent-green); border: 1px solid var(--accent-green); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                    <i class="fas fa-camera"></i> Photos (4)
                  </button>
                  <button style="padding: 0.8rem; background: rgba(78, 168, 255, 0.2); color: var(--accent-blue); border: 1px solid var(--accent-blue); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                    <i class="fas fa-sticky-note"></i> Notes
                  </button>
                  <button style="padding: 0.8rem; background: rgba(192, 132, 252, 0.2); color: var(--accent-purple); border: 1px solid var(--accent-purple); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                    <i class="fas fa-microphone"></i> Audio
                  </button>
                  <button style="padding: 0.8rem; background: rgba(251, 191, 36, 0.2); color: var(--accent-orange); border: 1px solid var(--accent-orange); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                    <i class="fas fa-check-square"></i> Checklist
                  </button>
                </div>

                <div style="background: rgba(73, 212, 147, 0.2); padding: 0.8rem; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem; color: var(--accent-green);">✓ 4/4</div>
                  <div style="font-size: 0.85rem; color: #ccc;">Tasks Completed</div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                <i class="fas fa-check-double"></i> Check Out & Request WCF <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderWCFNotificationCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user"></i> CUSTOMER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Email & SMS sent to ${so.customer.name}</p>
            </div>

            <div class="email-mockup" style="background: #fff; color: #333; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 600px; margin: 0 auto 2rem;">
              <div class="email-header" style="padding: 1.5rem; border-bottom: 1px solid #e5e5e5;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                  <div style="background: var(--yellow); color: #1a1a1a; padding: 0.5rem 1rem; font-weight: 700; border-radius: 4px;">YellowGrid</div>
                  <div style="flex: 1;"></div>
                  <div style="font-size: 0.85rem; color: #666;">10:52 AM</div>
                </div>
                <div style="font-size: 1.1rem; font-weight: 700;">
                  Service Complete - Please Sign WCF
                </div>
              </div>
              <div class="email-body" style="padding: 1.5rem;">
                <p>Dear ${so.customer.firstName},</p>
                <p style="margin: 1rem 0;">Your service <strong>${so.services[0].name}</strong> has been completed. Please sign the Work Completion Form.</p>
                <div style="text-align: center; margin: 1.5rem 0;">
                  <div style="background: var(--accent-green); color: #fff; padding: 1rem 2rem; border-radius: 8px; display: inline-block; font-weight: 700; cursor: pointer;">
                    <i class="fas fa-signature"></i> Sign WCF Online
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Customer Opens Email <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderWCFPortalCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user"></i> CUSTOMER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Work Completion Form</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">${so.customer.name} reviewing completed work</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 2px solid var(--border); border-radius: 12px; padding: 2rem; max-width: 800px; margin: 0 auto 2rem;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <h3 style="font-size: 1.8rem; margin-bottom: 0.5rem;">Work Completion Form</h3>
                <p style="color: var(--text-muted);">Service Order: <strong>SRV-${so.orderId.split('-')[2]}</strong></p>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 2px solid rgba(73, 212, 147, 0.4); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <i class="fas fa-check-circle" style="font-size: 2.5rem; color: var(--accent-green);"></i>
                  <div style="flex: 1;">
                    <strong style="font-size: 1.2rem; color: var(--accent-green);">Sign with No Reserves</strong>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">Work completed satisfactorily. Payment releases immediately.</p>
                  </div>
                </div>
              </div>

              <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 1.5rem; text-align: center; margin-bottom: 1.5rem;">
                <i class="fas fa-signature" style="font-size: 2rem; color: var(--yellow); margin-bottom: 0.5rem;"></i>
                <div style="font-size: 1.2rem; font-style: italic; margin-top: 1rem;">${so.customer.name}</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Signed: ${new Date().toLocaleDateString('en-GB')}</div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <div style="text-align: center; flex: 1;">
                <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="alert('🎉 Journey Complete! Service order closed successfully.')">
                  <i class="fas fa-signature"></i> Sign WCF & Complete Journey
                </button>
                <div style="margin-top: 1rem; color: var(--accent-green);">
                  <i class="fas fa-check-circle"></i> <strong>Final Step</strong> - Service order will be closed
                </div>
              </div>
              <button class="btn btn-secondary" onclick="dashboard.nextCard()">
                Pro-forma Invoice <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderInvoicePortalCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(251, 191, 36, 0.15); color: var(--accent-orange); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-handshake"></i> PROVIDER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Provider L - Rui Lopes</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
                <div>
                  <h3 style="margin-bottom: 0.5rem;"><i class="fas fa-file-invoice"></i> Pro Forma Invoice</h3>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">Auto-generated after service completion</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Invoice #</div>
                  <div style="font-size: 1.2rem; font-weight: 700;">INV-2024-${so.orderId.split('-')[2]}</div>
                </div>
              </div>

              <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; padding-bottom: 0.8rem; border-bottom: 1px solid var(--border);">
                  <span>Service Description</span>
                  <span>Amount</span>
                </div>
                <div style="padding: 0.8rem 0; border-bottom: 1px solid var(--border);">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>${so.services[0].name}</span>
                    <span style="font-weight: 600;">€${so.services[0].price}</span>
                  </div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Date: ${so.services[0].scheduledDate} • Duration: ${so.services[0].duration} min</div>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid var(--border);">
                  <span style="color: var(--text-muted);">Equipment & Materials</span>
                  <span style="font-weight: 600;">€45.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid var(--border);">
                  <span style="color: var(--text-muted);">Travel Expenses</span>
                  <span style="font-weight: 600;">€12.50</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid var(--border);">
                  <span style="color: var(--text-muted);">Subtotal</span>
                  <span style="font-weight: 600;">€${(parseFloat(so.services[0].price) + 57.50).toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid var(--border);">
                  <span style="color: var(--text-muted);">VAT (23%)</span>
                  <span style="font-weight: 600;">€${((parseFloat(so.services[0].price) + 57.50) * 0.23).toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 1rem;">
                  <span style="font-size: 1.2rem; font-weight: 700;">Total Amount</span>
                  <span style="font-size: 1.5rem; font-weight: 700; color: var(--yellow);">€${((parseFloat(so.services[0].price) + 57.50) * 1.23).toFixed(2)}</span>
                </div>
              </div>

              <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" style="flex: 1; background: var(--accent-green);">
                  <i class="fas fa-check"></i> Accept Invoice
                </button>
                <button class="btn btn-secondary" style="flex: 1; background: rgba(255, 82, 82, 0.2); color: var(--accent-red);">
                  <i class="fas fa-exclamation-triangle"></i> Contest Invoice
                </button>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Invoice Accepted <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderInvoiceDataflowCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-exchange-alt"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Invoice processing and payment signals</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-stream"></i> Invoice Dataflow</h3>

              <div style="position: relative; padding-left: 2rem;">
                <div style="position: absolute; left: 0.75rem; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, var(--accent-green), var(--accent-blue), var(--yellow));"></div>

                <div style="position: relative; margin-bottom: 2rem;">
                  <div style="position: absolute; left: -1.4rem; width: 24px; height: 24px; background: var(--accent-green); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check" style="font-size: 0.7rem;"></i>
                  </div>
                  <div style="background: rgba(73, 212, 147, 0.1); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 8px; padding: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--accent-green);">
                      <i class="fas fa-file-invoice"></i> Invoice Received from Provider
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Pro forma invoice INV-2024-${so.orderId.split('-')[2]} • €${((parseFloat(so.services[0].price) + 57.50) * 1.23).toFixed(2)}</div>
                  </div>
                </div>

                <div style="position: relative; margin-bottom: 2rem;">
                  <div style="position: absolute; left: -1.4rem; width: 24px; height: 24px; background: var(--accent-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check" style="font-size: 0.7rem;"></i>
                  </div>
                  <div style="background: rgba(78, 168, 255, 0.1); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 8px; padding: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--accent-blue);">
                      <i class="fas fa-robot"></i> Payment Signal Generated
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Payment scheduled for T+30 days • Expected: ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}</div>
                  </div>
                </div>

                <div style="position: relative;">
                  <div style="position: absolute; left: -1.4rem; width: 24px; height: 24px; background: var(--yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check" style="font-size: 0.7rem; color: #000;"></i>
                  </div>
                  <div style="background: rgba(255, 203, 50, 0.1); border: 1px solid rgba(255, 203, 50, 0.3); border-radius: 8px; padding: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem; color: var(--yellow);">
                      <i class="fas fa-bell"></i> Provider Notification Sent
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Payment confirmation dispatched to provider portal</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                View Payment Status <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderPaymentPortalCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(251, 191, 36, 0.15); color: var(--accent-orange); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-handshake"></i> PROVIDER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Provider L - Rui Lopes</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-money-check-alt"></i> Payment Dashboard</h3>

              <div style="background: linear-gradient(135deg, rgba(73, 212, 147, 0.15), rgba(73, 212, 147, 0.05)); border: 1px solid var(--accent-green); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="text-align: center;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">TOTAL PENDING</div>
                  <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green); margin-bottom: 0.3rem;">€${((parseFloat(so.services[0].price) + 57.50) * 1.23).toFixed(2)}</div>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">1 invoice • Payment date: ${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}</div>
                </div>
              </div>

              <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <div>
                    <div style="font-weight: 700; margin-bottom: 0.3rem;">INV-2024-${so.orderId.split('-')[2]}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">${so.services[0].name}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 1.3rem; font-weight: 700;">€${((parseFloat(so.services[0].price) + 57.50) * 1.23).toFixed(2)}</div>
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">STATUS</div>
                    <div style="font-weight: 600; color: var(--yellow);">
                      <i class="fas fa-clock"></i> Scheduled
                    </div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">PAYMENT DATE</div>
                    <div style="font-weight: 600;">${new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString()}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">METHOD</div>
                    <div style="font-weight: 600;">Bank Transfer</div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.9rem;">
                  <i class="fas fa-history" style="color: var(--accent-green);"></i>
                  <strong style="color: var(--accent-green);"> Historical Data:</strong>
                  <span style="color: var(--text-muted);"> 24 invoices paid • Avg. 28 days • 100% payment rate</span>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <div style="text-align: center; flex: 1;">
                <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="alert('🎉 Journey Complete! End-to-end workflow from Kafka to Payment.')">
                  <i class="fas fa-flag-checkered"></i> Complete Journey
                </button>
                <div style="margin-top: 1rem; color: var(--accent-green);">
                  <i class="fas fa-check-circle"></i> <strong>Full Lifecycle</strong> - From ingestion to payment
                </div>
              </div>
            </div>
          </div>
        `;
      };

      // Service Pack - TV Confirmation Flow Render Functions
      const renderTVCrewExecutionCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-hard-hat"></i> CREW
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Technical Visit Execution</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Technician: Rui Lopes - Expert Level</p>
            </div>

            <div class="mobile-screen" style="max-width: 400px; margin: 0 auto 2rem; background: #000; border-radius: 32px; padding: 1.5rem 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
              <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 1.3rem; font-weight: 700;">Confirmation TV</div>
              </div>

              <div style="background: linear-gradient(135deg, #49d493, #38a169); color: #fff; padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">
                  <i class="fas fa-check-circle"></i> On Site
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem;">TV #${so.orderId.split('-')[2]}</div>
                <div style="font-size: 0.9rem;">${so.services[0].scheduledDate} • ${so.services[0].timeSlot}</div>
              </div>

              <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem;">${so.customer.name}</div>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                  <i class="fas fa-map-marker-alt" style="color: var(--accent-blue);"></i>
                  <span>${so.customer.addressLine1}, ${so.customer.city}</span>
                </div>

                <div style="background: rgba(192, 132, 252, 0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                  <div style="font-weight: 700; margin-bottom: 0.5rem;"><i class="fas fa-clipboard-check"></i> Validation Checklist:</div>
                  <div style="font-size: 0.85rem; line-height: 1.8;">
                    ✓ Water supply accessible<br>
                    ✓ Electrical outlet 220V nearby<br>
                    ✓ Space dimensions: 60×82×55cm<br>
                    ⚠️ Cabinet modification needed<br>
                    ✓ Drainage accessible
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                  <button style="padding: 0.8rem; background: rgba(73, 212, 147, 0.2); color: var(--accent-green); border: 1px solid var(--accent-green); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                    <i class="fas fa-camera"></i> Photos (12)
                  </button>
                  <button style="padding: 0.8rem; background: rgba(78, 168, 255, 0.2); color: var(--accent-blue); border: 1px solid var(--accent-blue); border-radius: 8px; font-size: 0.85rem; font-weight: 600;">
                    <i class="fas fa-ruler"></i> Measures
                  </button>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Complete TV & Upload Report <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderTVReportUploadCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-hard-hat"></i> CREW
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Technician submitting TV findings</p>
            </div>

            <div style="max-width: 900px; margin: 0 auto;">
              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-file-alt"></i> Technical Visit Report</h3>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                  <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 8px; padding: 1rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-green);">✓ PASSED</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                      • Water supply OK<br>
                      • Electrical 220V OK<br>
                      • Drainage OK<br>
                      • Space dimensions OK
                    </div>
                  </div>
                  <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 1rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-orange);">⚠️ ISSUES FOUND</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                      • Cabinet modification required<br>
                      • Additional cutting work needed<br>
                      • Estimated +45 min labor<br>
                      • Material: €35
                    </div>
                  </div>
                </div>

                <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                  <div style="font-weight: 600; margin-bottom: 0.5rem;"><i class="fas fa-lightbulb"></i> Technician Recommendation:</div>
                  <div style="font-size: 0.95rem; line-height: 1.6;">
                    "Installation is feasible but requires cabinet modification. Customer's existing cabinet needs cutting to fit dishwasher dimensions. Recommend additional €57.50 (€35 materials + €22.50 labor @ 45min). Customer is aware and agrees to proceed with adjustment."
                  </div>
                </div>

                <div style="background: rgba(251, 191, 36, 0.15); border: 2px solid rgba(251, 191, 36, 0.5); border-radius: 12px; padding: 1.5rem; text-align: center;">
                  <div style="font-size: 1.3rem; font-weight: 700; color: var(--accent-orange); margin-bottom: 0.5rem;">
                    <i class="fas fa-exclamation-triangle"></i> OUTCOME: YES, BUT...
                  </div>
                  <div style="font-size: 0.9rem; color: var(--text-muted);">Installation approved with scope/price adjustment required</div>
                </div>
              </div>

              <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-paperclip" style="color: var(--accent-blue);"></i>
                  <span><strong>Attachments:</strong> 12 photos, 3 measurements, 1 customer signature</span>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Submit to AI Analysis <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderTVReportAnalysisCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-robot"></i> AI ENGINE
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Analyzing TV report and validating findings</p>
            </div>

            <div style="max-width: 900px; margin: 0 auto;">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                  <div style="font-size: 3rem; color: var(--accent-orange); margin-bottom: 0.5rem;">YES BUT</div>
                  <div style="font-weight: 600; margin-bottom: 0.3rem;">TV Outcome</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Adjustment Required</div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                  <div style="font-size: 3rem; color: var(--accent-green); margin-bottom: 0.5rem;">95%</div>
                  <div style="font-weight: 600; margin-bottom: 0.3rem;">Confidence</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">High Reliability</div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                  <div style="font-size: 3rem; color: var(--accent-blue); margin-bottom: 0.5rem;">€57.50</div>
                  <div style="font-weight: 600; margin-bottom: 0.3rem;">Extra Cost</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">+7.6%</div>
                </div>
              </div>

              <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;"><i class="fas fa-brain"></i> AI Analysis Results</h3>
                <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                  <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    <span><strong>Photo Analysis:</strong> 12 images processed - Cabinet cutting clearance validated</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    <span><strong>Measurements:</strong> Space dimensions 61×83×56cm confirmed (product 60×82×55cm)</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--accent-orange);"></i>
                    <span><strong>Cost Validation:</strong> €57.50 adjustment is 12% below market rate for similar modifications</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <i class="fas fa-user-check" style="color: var(--accent-green);"></i>
                    <span><strong>Customer Consent:</strong> Digital signature detected on modification approval</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <i class="fas fa-check-double" style="color: var(--accent-blue);"></i>
                    <span><strong>Recommendation:</strong> Proceed with adjustment - Requires operator derogation approval</span>
                  </div>
                </div>
              </div>

              <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-route" style="color: var(--accent-orange); font-size: 1.5rem;"></i>
                  <div>
                    <div style="font-weight: 600; color: var(--accent-orange);">Next Step: Operator Decision Required</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">TV outcome "YES BUT" requires manual review and derogation approval</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Send to Operator Decision <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderTVOutcomeGateCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-robot"></i> AUTOMATED
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Automatic outcome processing and flow routing</p>
            </div>

            <div style="max-width: 900px; margin: 0 auto;">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                <div style="background: rgba(73, 212, 147, 0.1); border: 2px solid rgba(73, 212, 147, 0.4); border-radius: 12px; padding: 1.5rem; text-align: center;">
                  <div style="font-size: 3rem; color: var(--accent-green); margin-bottom: 0.5rem;"><i class="fas fa-check-circle"></i></div>
                  <div style="font-weight: 600;">YES</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Auto-unblock</div>
                </div>

                <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 12px; padding: 1.5rem; text-align: center;">
                  <div style="font-size: 3rem; color: #ef4444; margin-bottom: 0.5rem;"><i class="fas fa-times-circle"></i></div>
                  <div style="font-weight: 600;">NO</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Alert Sales</div>
                </div>

                <div style="background: rgba(251, 191, 36, 0.1); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 12px; padding: 1.5rem; text-align: center;">
                  <div style="font-size: 3rem; color: var(--accent-orange); margin-bottom: 0.5rem;"><i class="fas fa-exclamation-triangle"></i></div>
                  <div style="font-weight: 600;">YES, BUT...</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">Alert Sales</div>
                </div>
              </div>

              <div style="background: rgba(251, 191, 36, 0.15); border: 2px solid rgba(251, 191, 36, 0.5); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                  <div style="font-size: 2rem; font-weight: 700; color: var(--accent-orange);">
                    <i class="fas fa-code-branch"></i> TV OUTCOME: YES, BUT...
                  </div>
                  <div style="font-size: 1.1rem; color: var(--text-muted); margin-top: 0.5rem;">Automatic routing to sales team</div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                  <h3 style="margin-bottom: 1rem;"><i class="fas fa-clipboard-list"></i> TV Findings Summary</h3>
                  <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                    <div style="font-size: 0.9rem; line-height: 1.8;">
                      <strong>Issue:</strong> Cabinet modification required<br>
                      <strong>Work Needed:</strong> Cutting + materials (+45 min)<br>
                      <strong>Customer Status:</strong> <span style="color: var(--accent-green);"><i class="fas fa-check"></i> Signed approval on-site</span>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 0.85rem; margin-bottom: 0.3rem;">Additional Cost</div>
                      <div style="font-size: 2rem; font-weight: 700; color: var(--accent-orange);">+€57.50</div>
                    </div>
                  </div>
                </div>

                <div style="background: rgba(192, 132, 252, 0.1); border-radius: 8px; padding: 1rem;">
                  <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <i class="fas fa-route" style="color: var(--accent-purple); font-size: 1.5rem;"></i>
                    <div>
                      <div style="font-weight: 600; color: var(--accent-purple);">Automatic Flow Control</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">
                        YES → Installation auto-unblocked<br>
                        NO / YES BUT → Alert triggered to sales team for SO handling
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-bell" style="color: var(--accent-orange); font-size: 1.2rem;"></i>
                  <div>
                    <div style="font-weight: 600;">Next: Sales Team Alert</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Sales team notified to handle SO adjustment or cancellation in sales domain</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Trigger Sales Alert <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderSalesAlertCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(255, 203, 50, 0.15); color: var(--yellow); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user-tie"></i> SALES TEAM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Salesperson: ${so.salesman} - SO Exception Handling</p>
            </div>

            <div style="max-width: 1000px; margin: 0 auto;">
              <div style="background: rgba(251, 191, 36, 0.15); border: 2px solid rgba(251, 191, 36, 0.5); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                  <div style="font-size: 3rem; color: var(--accent-orange); margin-bottom: 0.5rem;"><i class="fas fa-bell"></i></div>
                  <div style="font-size: 2rem; font-weight: 700;">TV Exception Alert</div>
                  <div style="font-size: 1.1rem; color: var(--text-muted); margin-top: 0.5rem;">Outcome: YES, BUT... - Sales Order adjustment required</div>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; margin-bottom: 2rem;">
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                  <h3 style="margin-bottom: 1rem;"><i class="fas fa-clipboard-list"></i> TV Findings</h3>
                  <div style="font-size: 0.9rem; line-height: 1.8;">
                    <strong>Issue:</strong> Cabinet modification required<br>
                    <strong>Root Cause:</strong> Customer's existing cabinet doesn't fit dishwasher dimensions<br>
                    <strong>Work Required:</strong> Cutting, materials, finishing (+45 min)<br>
                    <strong>Customer Status:</strong> <span style="color: var(--accent-green);"><i class="fas fa-check"></i> Approved on-site</span><br>
                    <strong>Additional Cost:</strong> <span style="color: var(--accent-orange); font-weight: 700;">+€57.50</span>
                  </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                  <h3 style="margin-bottom: 1rem;"><i class="fas fa-shopping-cart"></i> Current Sales Order</h3>
                  <div style="font-size: 0.9rem; line-height: 1.8;">
                    <strong>SO ID:</strong> ${so.orderId}<br>
                    <strong>Customer:</strong> ${so.customer.name}<br>
                    <strong>Original Total:</strong> €${so.totals.total}<br>
                    <strong>Payment Status:</strong> ${so.payment.status}<br>
                    <strong>Store:</strong> ${so.store}<br>
                    <strong>Salesperson:</strong> ${so.salesman}
                  </div>
                </div>
              </div>

              <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid rgba(78, 168, 255, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;"><i class="fas fa-tasks"></i> Sales Team Actions Required</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                  <div>
                    <div style="font-weight: 600; margin-bottom: 0.8rem; color: var(--accent-blue);">Option 1: Update Sales Order</div>
                    <div style="font-size: 0.85rem; line-height: 1.7;">
                      • Add cabinet modification service line<br>
                      • Update SO total: €${so.totals.total} → €${(Number.parseFloat(so.totals.total) + 57.50).toFixed(2)}<br>
                      • Contact customer for payment approval<br>
                      • Update service order automatically syncs
                    </div>
                  </div>
                  <div>
                    <div style="font-weight: 600; margin-bottom: 0.8rem; color: #ef4444;">Option 2: Cancel Sales Order</div>
                    <div style="font-size: 0.85rem; line-height: 1.7;">
                      • Cancel SO ${so.orderId}<br>
                      • Process customer refund<br>
                      • Service order cancels automatically<br>
                      • Provider released from assignment
                    </div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-info-circle" style="color: var(--accent-purple); font-size: 1.5rem;"></i>
                  <div>
                    <div style="font-weight: 600; color: var(--accent-purple);">Sales Domain Handling</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">All price and scope adjustments happen in sales domain. Service domain waits for updated SO or cancellation event.</div>
                  </div>
                </div>
              </div>

              <div style="text-align: center; padding: 1.5rem; background: rgba(73, 212, 147, 0.1); border: 2px solid rgba(73, 212, 147, 0.4); border-radius: 12px;">
                <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-green);">
                  <i class="fas fa-check-circle"></i> Sales Team Updated SO
                </div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Sales order updated with cabinet modification service • Customer approved additional payment</div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                SO Updated - Sync to Service <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderSOUpdateSyncCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-robot"></i> AUTOMATED
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Automatic synchronization from sales to service domain</p>
            </div>

            <div style="max-width: 900px; margin: 0 auto;">
              <div style="background: rgba(73, 212, 147, 0.1); border: 2px solid rgba(73, 212, 147, 0.4); border-radius: 12px; padding: 2rem; text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 4rem; color: var(--accent-green); margin-bottom: 1rem;">
                  <i class="fas fa-sync"></i>
                </div>
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Sales Order Updated</div>
                <div style="font-size: 1.1rem; color: var(--text-muted);">Service order automatically synchronized</div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; margin-bottom: 2rem;">
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                  <h3 style="margin-bottom: 1rem;"><i class="fas fa-shopping-cart"></i> Updated Sales Order</h3>
                  <div style="font-size: 0.9rem; line-height: 1.8;">
                    <strong>SO ID:</strong> ${so.orderId}<br>
                    <strong>Updated By:</strong> ${so.salesman}<br>
                    <strong>Update Time:</strong> ${new Date().toLocaleTimeString('en-GB')}<br>
                    <strong>Change Type:</strong> Service line added<br>
                    <strong>New Total:</strong> €${(Number.parseFloat(so.totals.total) + 57.50).toFixed(2)}<br>
                    <strong>Customer:</strong> Approved payment
                  </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem;">
                  <h3 style="margin-bottom: 1rem;"><i class="fas fa-tools"></i> Service Order Update</h3>
                  <div style="font-size: 0.9rem; line-height: 1.8;">
                    <strong>Service Added:</strong> Cabinet Modification<br>
                    <strong>Duration:</strong> +45 minutes<br>
                    <strong>Cost:</strong> €57.50<br>
                    <strong>Assigned To:</strong> Same provider<br>
                    <strong>Scheduled:</strong> During installation<br>
                    <strong>Status:</strong> Installation unblocked
                  </div>
                </div>
              </div>

              <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid rgba(192, 132, 252, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;"><i class="fas fa-exchange-alt"></i> Sync Process</h3>
                <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                  <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    <span><strong>Kafka Event:</strong> SO-UPDATE event published to service domain</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    <span><strong>Service Lines:</strong> Cabinet modification service added to bundle</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    <span><strong>Provider Assignment:</strong> Same provider maintains both services</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <i class="fas fa-check-circle" style="color: var(--accent-green);"></i>
                    <span><strong>Installation Status:</strong> Check-in unblocked - ready to proceed</span>
                  </div>
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid rgba(73, 212, 147, 0.3); border-radius: 8px; padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                  <i class="fas fa-route" style="color: var(--accent-green); font-size: 1.5rem;"></i>
                  <div>
                    <div style="font-weight: 600; color: var(--accent-green);">Ready for Installation</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">TV confirmed, SO updated, service synchronized. Provider can now proceed with installation check-in.</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Proceed to Go-Exec Gate <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      // Complex Project Render Functions
      const renderQualityVisitCard = (so, card) => {
        const service = so.services[card.serviceIndex];
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user-check"></i> QUALITY SPECIALIST
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Independent Quality Inspector - Paulo Costa</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-magnifying-glass"></i> On-Site Quality Inspection - Phase ${card.phase}</h3>

              <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem; font-size: 1.1rem;">${service.name}</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.9rem;">
                  <div><strong>Service Order:</strong> ${service.serviceOrderId}</div>
                  <div><strong>Inspection Date:</strong> ${new Date(Date.now() + card.phase * 3 * 24*60*60*1000).toLocaleDateString()}</div>
                  <div><strong>Service Value:</strong> €${service.totalPrice}</div>
                  <div><strong>Inspector:</strong> Independent Specialist</div>
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-green);"><i class="fas fa-check-circle"></i> Quality Inspection Results</div>
                <div style="font-size: 0.9rem; line-height: 1.8;">
                  ✅ Work completed according to specifications<br>
                  ✅ Materials quality verified<br>
                  ✅ Safety standards met<br>
                  ✅ No defects or rework needed<br>
                  ✅ Photos and measurements documented<br>
                  ✅ Ready for next phase
                </div>
              </div>

              <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <div style="font-size: 0.9rem;">
                  <i class="fas fa-lightbulb" style="color: var(--accent-orange);"></i>
                  <strong> Quality Visit Role:</strong> Independent specialist validates work completion. Acceptance triggers payment authorization AND unblocks next service phase.
                </div>
              </div>

              <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid var(--accent-purple); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                  <strong>Note:</strong> Customer WCF signature happens once at project end. Quality visits control phase progression and payment releases.
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-success" onclick="dashboard.nextCard()">
                <i class="fas fa-stamp"></i> Accept & Authorize Payment <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderPaymentAuthCard = (so, card) => {
        const service = so.services[card.serviceIndex];
        const milestone = so.payment.paymentMilestones[card.serviceIndex];
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(73, 212, 147, 0.15); color: var(--accent-green); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-stamp"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Automated Payment Processing</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-file-invoice-dollar"></i> Payment Authorization - ${milestone.milestone}</h3>

              <div style="background: rgba(73, 212, 147, 0.15); border: 2px solid var(--accent-green); border-radius: 12px; padding: 2rem; margin-bottom: 1.5rem; text-align: center;">
                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">PAYMENT AMOUNT</div>
                <div style="font-size: 3rem; font-weight: 700; color: var(--accent-green);">€${milestone.amount.toFixed(2)}</div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">${service.name} - Phase ${card.phase}</div>
              </div>

              <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;"><i class="fas fa-robot"></i> Automatic Authorization Triggered</div>
                <div style="font-size: 0.9rem; line-height: 1.8;">
                  ✅ Quality visit accepted by independent specialist<br>
                  ✅ Provider invoice received and validated<br>
                  ✅ Service within scope and budget<br>
                  ✅ Milestone conditions met<br>
                  ✅ No blocking issues detected
                </div>
              </div>

              <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <div style="font-size: 0.9rem;">
                  <i class="fas fa-bolt" style="color: var(--accent-blue);"></i>
                  <strong> Triggered By:</strong> Quality visit acceptance automatically authorizes this payment milestone
                </div>
              </div>

              <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid var(--accent-purple); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.85rem; color: var(--text-muted);">
                  <strong>Business Rule:</strong> Payment authorization is conditional on quality acceptance. No manual approval needed when quality specialist validates work.
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                <i class="fas fa-check"></i> Payment Authorized <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderPhaseUnlockCard = (so, card) => {
        const nextService = card.serviceIndex < so.services.length - 1 ? so.services[card.serviceIndex + 1] : null;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-gears"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Automated Phase Management</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-diagram-project"></i> Critical Path Update</h3>

              <div style="background: linear-gradient(135deg, rgba(73, 212, 147, 0.15), rgba(73, 212, 147, 0.05)); border: 2px solid var(--accent-green); border-radius: 12px; padding: 2rem; margin-bottom: 1.5rem; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green); margin-bottom: 0.5rem;">Phase ${card.phase} Complete</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Service executed, quality visit accepted, payment authorized</div>
              </div>

              ${nextService ? `
                <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                  <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-blue);"><i class="fas fa-unlock"></i> Next Phase Unlocked</div>
                  <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">${nextService.name}</div>
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.9rem; margin-top: 1rem;">
                    <div><strong>Service Order:</strong> ${nextService.serviceOrderId}</div>
                    <div><strong>Scheduled:</strong> ${nextService.scheduledDate}</div>
                    <div><strong>Duration:</strong> ${nextService.duration} min</div>
                    <div><strong>Technicians:</strong> ${nextService.techniciansRequired}</div>
                  </div>
                </div>

                <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 1rem;">
                  <div style="font-size: 0.9rem;">
                    <i class="fas fa-hourglass-half" style="color: var(--accent-orange);"></i>
                    <strong> Dependencies Met:</strong> ${nextService.precedenceRule}
                  </div>
                </div>
              ` : `
                <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.05)); border: 2px solid var(--accent-orange); border-radius: 12px; padding: 2rem; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 1rem;">🏆</div>
                  <div style="font-size: 1.3rem; font-weight: 700; color: var(--accent-orange);">All Services Complete</div>
                  <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 0.5rem;">Final commissioning ready to begin</div>
                </div>
              `}
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                ${nextService ? '<i class="fas fa-play"></i> Continue to Next Phase' : '<i class="fas fa-flag-checkered"></i> Proceed to Completion'} <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProjectCompleteCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(73, 212, 147, 0.15); color: var(--accent-green); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-trophy"></i> PROJECT
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Project Complete</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">${so.orderId} - All Phases Delivered</p>
            </div>

            <div style="background: linear-gradient(135deg, rgba(73, 212, 147, 0.2), rgba(73, 212, 147, 0.05)); border: 2px solid var(--accent-green); border-radius: 12px; padding: 3rem; text-align: center; margin-bottom: 2rem;">
              <div style="font-size: 5rem; margin-bottom: 1rem;">🎉</div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green); margin-bottom: 1rem;">Complex Project Successfully Completed</div>
              <div style="font-size: 1.1rem; color: var(--text-muted);">Multi-phase installation with iterative quality checks and milestone payments</div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-blue); margin-bottom: 0.5rem;">${so.services.length}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Services Completed</div>
              </div>
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green); margin-bottom: 0.5rem;">€${so.totals.total.toFixed(2)}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Total Project Value</div>
              </div>
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-purple); margin-bottom: 0.5rem;">${so.projectPhases.length}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Phases Executed</div>
              </div>
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-orange); margin-bottom: 0.5rem;">${Math.ceil((new Date(so.projectPhases[so.projectPhases.length-1].startDate) - new Date(so.projectPhases[0].startDate)) / (1000*60*60*24))}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Days Duration</div>
              </div>
            </div>

              <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-list-check"></i> Workflow Highlights</h3>
              <div style="font-size: 0.95rem; line-height: 2;">
                ✅ <strong>Multi-Service Orchestration:</strong> ${so.services.length} services sequenced with dependencies<br>
                ✅ <strong>Iterative Loop:</strong> Each service went through cycle (go exec → execution → quality visit → payment)<br>
                ✅ <strong>Quality Visits:</strong> Independent specialist validates each phase completion<br>
                ✅ <strong>Milestone Payments:</strong> ${so.payment.paymentMilestones.length} payments unlocked by quality acceptance<br>
                ✅ <strong>Critical Path:</strong> Dependencies enforced (Demolition → Tiling → Fixtures → Finishing)<br>
                ✅ <strong>Same Provider:</strong> All services handled by HomePro Renovations<br>
                ✅ <strong>Single WCF:</strong> Customer signs once at project end (not per service)<br>
                ✅ <strong>No Scope Creep:</strong> All changes handled in sales domain
              </div>
            </div>            <div style="text-align: center; margin-top: 2rem;">
              <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="alert('🎉 Complex Installation Project Complete! Demonstrated multi-phase workflow with iterative loops.')">
                <i class="fas fa-flag-checkered"></i> Complete Journey
              </button>
              <div style="margin-top: 1rem; color: var(--accent-green);">
                <i class="fas fa-check-circle"></i> <strong>Full Lifecycle</strong> - Enterprise-grade project management
              </div>
            </div>
          </div>
        `;
      };

      // Rework Scenario Render Functions
      const renderReworkTriggerCard = (so, card) => {
        const reworkSO = scenarios['rework'].salesOrder;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(239, 68, 68, 0.15); color: #ef4444; padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-triangle-exclamation"></i> CUSTOMER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Customer identified quality issues - WCF signed with reserves</p>
            </div>

            <div style="background: rgba(239, 68, 68, 0.08); border: 2px solid #ef4444; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem; color: #ef4444;"><i class="fas fa-exclamation-circle"></i> Quality Issue Reported</h3>
              
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; font-size: 0.9rem;">
                <div><strong>Original SO:</strong> ${reworkSO.originalSoReference.soId}</div>
                <div><strong>Service:</strong> ${reworkSO.originalSoReference.serviceName}</div>
                <div><strong>Completed:</strong> ${new Date(reworkSO.originalCompletionDate).toLocaleDateString()}</div>
                <div><strong>Reported:</strong> ${new Date(reworkSO.problemDetails.reportedDate).toLocaleDateString()}</div>
                <div><strong>Original Provider:</strong> ${reworkSO.originalProvider.name}</div>
                <div><strong>WCF Status:</strong> <span style="color: #ef4444; font-weight: 600;">${reworkSO.problemDetails.wcfStatus}</span></div>
              </div>

              <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;">Customer Complaint:</div>
                <div style="font-size: 0.95rem; line-height: 1.8; color: var(--text-muted);">
                  ${reworkSO.problemDetails.description}
                </div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Category</div>
                  <div style="font-weight: 600;">${reworkSO.problemDetails.issueCategory}</div>
                </div>
                <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Severity</div>
                  <div style="font-weight: 600; color: #ef4444;">${reworkSO.problemDetails.severity}</div>
                </div>
                <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Evidence</div>
                  <div style="font-weight: 600;">${reworkSO.problemDetails.evidencePhotos.length} Photos</div>
                </div>
              </div>
            </div>

            <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
              <div style="font-size: 0.9rem;">
                <i class="fas fa-lightbulb" style="color: var(--accent-orange);"></i>
                <strong> Rework Trigger:</strong> Quality issues during final inspection. Customer signed WCF but noted specific problems. Service domain initiates corrective action - no sales involvement, no customer charge.
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Proceed to Assessment <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProblemAssessmentCard = (so, card) => {
        const reworkSO = scenarios['rework'].salesOrder;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user-tie"></i> OPERATOR
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Operator reviews complaint and validates issue legitimacy</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-clipboard-check"></i> Operator Inspection</h3>

              <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;">Evidence Review</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                  ${reworkSO.problemDetails.evidencePhotos.map(photo => `
                    <div style="background: rgba(0, 0, 0, 0.3); border-radius: 4px; padding: 0.75rem; text-align: center;">
                      <i class="fas fa-image" style="font-size: 1.5rem; color: var(--accent-blue); margin-bottom: 0.5rem;"></i>
                      <div style="font-size: 0.8rem; color: var(--text-muted); word-wrap: break-word;">${photo}</div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-green);"><i class="fas fa-check-circle"></i> Assessment Results</div>
                <div style="font-size: 0.9rem; line-height: 1.8;">
                  ✅ <strong>Complaint Valid:</strong> Quality standards not met<br>
                  ✅ <strong>Photos Reviewed:</strong> Evidence confirms customer claims<br>
                  ✅ <strong>Measurements Verified:</strong> Grout lines 2-5mm (spec: 3mm ±0.5mm)<br>
                  ✅ <strong>Waterproofing Test:</strong> Moisture detected in shower corner<br>
                  ✅ <strong>Professional Standards:</strong> Workmanship below acceptable level<br>
                  ✅ <strong>Customer Impact:</strong> Bathroom unusable until fixed
                </div>
              </div>

              <div style="background: rgba(239, 68, 68, 0.08); border: 1px solid #ef4444; border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.9rem;">
                  <strong>Operator Decision:</strong> Rework required - quality issue confirmed. Original provider responsibility. Service domain will handle correction.
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Proceed to Root Cause <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderRootCauseAnalysisCard = (so, card) => {
        const reworkSO = scenarios['rework'].salesOrder;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user-tie"></i> OPERATOR
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Identifying the underlying cause of quality failure</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-microscope"></i> Root Cause Analysis</h3>

              <div style="background: rgba(239, 68, 68, 0.08); border: 1px solid #ef4444; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;">Root Cause Identified:</div>
                <div style="font-size: 1.05rem; line-height: 1.8;">
                  ${reworkSO.problemDetails.rootCause}
                </div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem;">
                  <div style="font-weight: 700; margin-bottom: 1rem;"><i class="fas fa-wrench"></i> Technical Factors</div>
                  <div style="font-size: 0.9rem; line-height: 1.8; color: var(--text-muted);">
                    • Waterproofing membrane<br>&nbsp;&nbsp;overlap insufficient<br>
                    • Grout line consistency not<br>&nbsp;&nbsp;maintained<br>
                    • Tile alignment tools not used<br>
                    • Quality control skipped
                  </div>
                </div>
                <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem;">
                  <div style="font-weight: 700; margin-bottom: 1rem;"><i class="fas fa-clock"></i> Process Factors</div>
                  <div style="font-size: 0.9rem; line-height: 1.8; color: var(--text-muted);">
                    • Rushed execution timeline<br>
                    • Crew inexperienced with<br>&nbsp;&nbsp;waterproofing specs<br>
                    • No quality checkpoints<br>
                    • Provider overscheduled
                  </div>
                </div>
              </div>

              <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid var(--accent-purple); border-radius: 8px; padding: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;"><i class="fas fa-chart-line"></i> Quality Incident Logged</div>
                <div style="font-size: 0.9rem; line-height: 1.8;">
                  <strong>Provider:</strong> ${reworkSO.originalProvider.name}<br>
                  <strong>Impact:</strong> Rating review, quality metrics updated<br>
                  <strong>Action:</strong> Performance evaluation, possible retraining<br>
                  <strong>Customer Trust:</strong> Lost confidence - different provider recommended
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Create Rework SO <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderReworkDecisionCard = (so, card) => {
        const reworkSO = scenarios['rework'].salesOrder;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user-tie"></i> OPERATOR
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Operator creates rework service order</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-folder-plus"></i> Rework Service Order</h3>

              <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.9rem;">
                  <div><strong>Rework SO ID:</strong> ${reworkSO.soId}</div>
                  <div><strong>Original SO:</strong> ${reworkSO.originalSoId}</div>
                  <div><strong>Reason:</strong> ${reworkSO.reworkReason === 'wcf-reserves' ? 'WCF Signed with Reserves' : 'Warranty Claim'}</div>
                  <div><strong>Created:</strong> ${new Date(reworkSO.createdDate).toLocaleDateString()}</div>
                  <div><strong>Priority:</strong> <span style="color: #ef4444; font-weight: 600;">${reworkSO.priority}</span></div>
                  <div><strong>Customer:</strong> ${reworkSO.customer.name}</div>
                </div>
              </div>

              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;">Rework Scope:</div>
                <div style="font-size: 0.95rem; line-height: 1.8;">
                  <strong>Service:</strong> ${reworkSO.services[0].name}<br>
                  <strong>Description:</strong> ${reworkSO.services[0].description.substring(0, 200)}...
                </div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Duration</div>
                  <div style="font-weight: 600;">${reworkSO.services[0].duration} min</div>
                </div>
                <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Customer Pays</div>
                  <div style="font-weight: 600; color: var(--accent-green);">€${reworkSO.financials.customerPayment.toFixed(2)}</div>
                </div>
                <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1rem; text-align: center;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Provider Receives</div>
                  <div style="font-weight: 600; color: var(--accent-blue);">€${reworkSO.financials.providerPayment.toFixed(2)}</div>
                </div>
              </div>
            </div>

            <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
              <div style="font-size: 0.9rem;">
                <i class="fas fa-shield-alt" style="color: var(--accent-green);"></i>
                <strong> Service Domain:</strong> Rework handled entirely in service domain. No sales involvement. Customer protected from quality issues - pays nothing for rework.
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Assign Provider <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProviderAssignmentCard = (so, card) => {
        const reworkSO = scenarios['rework'].salesOrder;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user-tie"></i> OPERATOR
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Conditional payment logic: Same vs Different Provider</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-user-gear"></i> Provider Selection Logic</h3>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                <div style="background: rgba(239, 68, 68, 0.08); border: 2px solid #ef4444; border-radius: 8px; padding: 1.5rem;">
                  <div style="font-weight: 700; margin-bottom: 1rem; color: #ef4444;"><i class="fas fa-user-xmark"></i> Original Provider</div>
                  <div style="font-size: 0.9rem; line-height: 1.8; margin-bottom: 1rem;">
                    <strong>Name:</strong> ${reworkSO.originalProvider.name}<br>
                    <strong>Rating:</strong> ${reworkSO.originalProvider.rating}/5.0<br>
                    <strong>Status:</strong> <span style="color: #ef4444;">Quality Incident</span><br>
                    <strong>Customer Trust:</strong> Lost
                  </div>
                  <div style="background: rgba(0, 0, 0, 0.3); border-radius: 4px; padding: 0.75rem; text-align: center;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.3rem;">If selected for rework:</div>
                    <div style="font-size: 1.3rem; font-weight: 700; color: #ef4444;">Payment: €0.00</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.3rem;">Fixes own mistake</div>
                  </div>
                </div>

                <div style="background: rgba(73, 212, 147, 0.08); border: 2px solid var(--accent-green); border-radius: 8px; padding: 1.5rem;">
                  <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-green);"><i class="fas fa-user-check"></i> Different Provider</div>
                  <div style="font-size: 0.9rem; line-height: 1.8; margin-bottom: 1rem;">
                    <strong>Name:</strong> ${reworkSO.reworkProvider.name}<br>
                    <strong>Rating:</strong> ${reworkSO.reworkProvider.rating}/5.0<br>
                    <strong>Specialization:</strong> ${reworkSO.reworkProvider.specialization}<br>
                    <strong>Jobs Completed:</strong> ${reworkSO.reworkProvider.completedJobs}
                  </div>
                  <div style="background: rgba(0, 0, 0, 0.3); border-radius: 4px; padding: 0.75rem; text-align: center; border: 2px solid var(--accent-green);">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.3rem;">If selected for rework:</div>
                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--accent-green);">Payment: €${reworkSO.financials.providerPayment.toFixed(2)}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.3rem;">Full payment</div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-blue);"><i class="fas fa-gavel"></i> Operator Decision</div>
                <div style="font-size: 0.95rem; line-height: 1.8;">
                  <strong>Selected:</strong> ${reworkSO.reworkProvider.name} ✅<br>
                  <strong>Reason:</strong> Customer lost confidence in original provider. High priority fix requires specialized remedial expertise.<br>
                  <strong>Payment:</strong> €${reworkSO.financials.providerPayment.toFixed(2)} will be paid to ${reworkSO.reworkProvider.name}<br>
                  <strong>Customer Impact:</strong> No charge - quality issue protection
                </div>
              </div>

              <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid var(--accent-purple); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.85rem; line-height: 1.6;">
                  <strong>Payment Logic:</strong><br>
                  • <strong>Same Provider Rework:</strong> Provider pays own costs (€0 platform payment) - warranty obligation<br>
                  • <strong>Different Provider Rework:</strong> Platform pays provider normally - compensates new provider for fixing another's mistake<br>
                  • <strong>Customer Always:</strong> Pays €0 for rework - protected from quality issues
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Notify Provider <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProviderNotificationCard = (so, card) => {
        const reworkSO = scenarios['rework'].salesOrder;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(134, 88, 223, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-mobile-screen-button"></i> PROVIDER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Rework Provider Notification</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">${reworkSO.reworkProvider.name} receives rework assignment</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-bell"></i> Provider Mobile App - Rework Assignment</h3>

              <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid var(--accent-purple); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                  <div>
                    <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem;">Rework Assignment</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">${reworkSO.soId}</div>
                  </div>
                  <div style="background: #ef4444; color: #fff; padding: 0.3rem 0.8rem; border-radius: 999px; font-size: 0.8rem; font-weight: 600;">
                    HIGH PRIORITY
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; font-size: 0.9rem;">
                  <div><strong>Service:</strong> Rework: Tiling</div>
                  <div><strong>Value:</strong> €${reworkSO.financials.providerPayment.toFixed(2)}</div>
                  <div><strong>Customer:</strong> ${reworkSO.customer.name}</div>
                  <div><strong>Duration:</strong> ${reworkSO.services[0].duration} min</div>
                </div>
              </div>

              <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;">Rework Context:</div>
                <div style="font-size: 0.9rem; line-height: 1.8; color: var(--text-muted);">
                  <strong>Original Work:</strong> ${reworkSO.originalSoReference.serviceName} by ${reworkSO.originalProvider.name}<br>
                  <strong>Issue:</strong> ${reworkSO.problemDetails.description.substring(0, 120)}...<br>
                  <strong>Your Task:</strong> Correct all quality issues to professional standards
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <div style="font-size: 0.9rem;">
                  <strong>Payment:</strong> €${reworkSO.financials.providerPayment.toFixed(2)} upon completion and WCF acceptance<br>
                  <strong>Note:</strong> Different provider rework - you will be compensated for fixing another provider's work
                </div>
              </div>

              <div style="text-align: center;">
                <button class="btn btn-primary" style="font-size: 1.1rem; padding: 0.75rem 2rem;">
                  <i class="fas fa-check"></i> Accept Rework Assignment
                </button>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Proceed to Go Exec <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderQualityCheckCard = (so, card) => {
        const reworkSO = scenarios['rework'].salesOrder;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-user-tie"></i> OPERATOR
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Validation that quality issues have been resolved</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-clipboard-check"></i> Rework Quality Inspection</h3>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-green);"><i class="fas fa-check-circle"></i> Quality Standards Met</div>
                <div style="font-size: 0.9rem; line-height: 1.8;">
                  ✅ Grout lines consistent at 3mm ±0.5mm (previously 2-5mm variation)<br>
                  ✅ Waterproofing test passed - no moisture detected after 24 hours<br>
                  ✅ Tile alignment perfect - ±0.5mm tolerance met<br>
                  ✅ Professional finish achieved - meets specifications<br>
                  ✅ All materials properly installed per manufacturer specs<br>
                  ✅ No defects or rework needed<br>
                  ✅ Work area clean and properly finished<br>
                  ✅ Customer expectations exceeded
                </div>
              </div>

              <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid var(--accent-purple); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <div style="font-size: 0.9rem;">
                  <strong>Before vs After Comparison:</strong><br>
                  • <strong>Grout Lines:</strong> 2-5mm inconsistent → 3mm ±0.5mm uniform<br>
                  • <strong>Waterproofing:</strong> Failed moisture test → Passed 24-hour test<br>
                  • <strong>Alignment:</strong> 3mm off → ±0.5mm tolerance met<br>
                  • <strong>Overall:</strong> Substandard → Professional grade
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.9rem; font-weight: 600; color: var(--accent-green);">
                  <i class="fas fa-check-double"></i> Rework Approved - Ready for Customer WCF
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Request WCF <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderPaymentAuthorizationCard = (so, card) => {
        const reworkSO = scenarios['rework'].salesOrder;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(73, 212, 147, 0.15); color: var(--accent-green); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-cog"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Conditional payment processing based on provider assignment</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-calculator"></i> Payment Logic Evaluation</h3>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                <div style="background: rgba(239, 68, 68, 0.08); border: 1px solid #ef4444; border-radius: 8px; padding: 1.5rem;">
                  <div style="font-weight: 700; margin-bottom: 1rem; color: #ef4444;"><i class="fas fa-user-xmark"></i> Customer Payment</div>
                  <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; font-weight: 700; color: #ef4444; margin-bottom: 0.5rem;">€${reworkSO.financials.customerPayment.toFixed(2)}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Quality issue - no customer charge</div>
                  </div>
                </div>

                <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1.5rem;">
                  <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-green);"><i class="fas fa-user-check"></i> Provider Payment</div>
                  <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; font-weight: 700; color: var(--accent-green); margin-bottom: 0.5rem;">€${reworkSO.financials.providerPayment.toFixed(2)}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Different provider - full payment</div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.9rem; font-weight: 600; color: var(--accent-green);">
                  <i class="fas fa-check-circle"></i> Payment Authorized - €${reworkSO.financials.providerPayment.toFixed(2)} will be transferred to ${reworkSO.reworkProvider.name}
                </div>
              </div>
            </div>

            <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
              <div style="font-size: 0.9rem;">
                <i class="fas fa-lightbulb" style="color: var(--accent-orange);"></i>
                <strong> Payment Logic Summary:</strong> IF same provider → €0 payment (warranty) | IF different provider → full payment (compensation) | Customer always pays €0 (quality protection)
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Complete Rework <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderReworkCompleteCard = (so, card) => {
        const reworkSO = scenarios['rework'].salesOrder;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(73, 212, 147, 0.15); color: var(--accent-green); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-flag-checkered"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Quality issue resolved - Service domain recovery complete</p>
            </div>

            <div style="background: linear-gradient(135deg, rgba(73, 212, 147, 0.2), rgba(73, 212, 147, 0.05)); border: 2px solid var(--accent-green); border-radius: 12px; padding: 3rem; text-align: center; margin-bottom: 2rem;">
              <div style="font-size: 5rem; margin-bottom: 1rem;">✅</div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green); margin-bottom: 1rem;">Rework Successfully Completed</div>
              <div style="font-size: 1.1rem; color: var(--text-muted);">Quality issue resolved through service domain recovery workflow</div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: #ef4444; margin-bottom: 0.5rem;">€${reworkSO.financials.customerPayment.toFixed(2)}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Customer Paid</div>
                <div style="font-size: 0.8rem; color: var(--accent-green); margin-top: 0.5rem;">Protected from quality issues</div>
              </div>
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green); margin-bottom: 0.5rem;">€${reworkSO.financials.providerPayment.toFixed(2)}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Provider Received</div>
                <div style="font-size: 0.8rem; color: var(--accent-blue); margin-top: 0.5rem;">${reworkSO.reworkProvider.name}</div>
              </div>
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-purple); margin-bottom: 0.5rem;">${reworkSO.services[0].duration}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Minutes</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Rework duration</div>
              </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-list-check"></i> Rework Workflow Summary</h3>
              <div style="font-size: 0.95rem; line-height: 2;">
                ✅ <strong>Trigger:</strong> WCF signed with reserves - quality issues identified<br>
                ✅ <strong>Assessment:</strong> Operator validated complaint with evidence<br>
                ✅ <strong>Root Cause:</strong> Rushed execution, inadequate waterproofing, poor quality control<br>
                ✅ <strong>Rework SO:</strong> New service order created (${reworkSO.soId})<br>
                ✅ <strong>Provider Logic:</strong> Different provider assigned (customer trust lost)<br>
                ✅ <strong>Execution:</strong> ${reworkSO.reworkProvider.name} performed corrections<br>
                ✅ <strong>Quality Check:</strong> All standards met, issues resolved<br>
                ✅ <strong>WCF:</strong> Customer accepted work without reserves<br>
                ✅ <strong>Payment:</strong> €${reworkSO.financials.providerPayment.toFixed(2)} paid to different provider (conditional logic)<br>
                ✅ <strong>Customer Impact:</strong> €0 cost - protected from quality issues
              </div>
            </div>

            <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid var(--accent-purple); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1rem;"><i class="fas fa-trophy"></i> Platform Value Demonstrated</h3>
              <div style="font-size: 0.9rem; line-height: 1.8;">
                <strong>Service Domain Autonomy:</strong> Rework handled entirely in service domain - no sales involvement required<br>
                <strong>Customer Protection:</strong> €0 cost for quality issues - platform shields customers<br>
                <strong>Conditional Payment:</strong> Smart logic - same provider (€0) vs different provider (full payment)<br>
                <strong>Quality Control:</strong> Systematic assessment, root cause analysis, validation process<br>
                <strong>Provider Accountability:</strong> Quality incidents logged, ratings impacted, performance tracked<br>
                <strong>Flexibility:</strong> Can assign different provider when customer trust is lost
              </div>
            </div>

            <div style="text-align: center;">
              <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="alert('✅ Rework Complete! Demonstrated service domain quality recovery with conditional payment logic.')">
                <i class="fas fa-flag-checkered"></i> Complete Journey
              </button>
              <div style="margin-top: 1rem; color: var(--accent-green);">
                <i class="fas fa-shield-alt"></i> <strong>Service Domain Recovery</strong> - Quality issue resolved transparently
              </div>
            </div>
          </div>
        `;
      };

      // ===== MAINTENANCE SCENARIO RENDER FUNCTIONS =====

      const renderAssetDetailsCard = (so, card) => {
        const asset = so.asset;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(192, 132, 252, 0.15); color: var(--accent-purple); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-clipboard-list"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Equipment details and service history</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-wrench"></i> Asset Information</h3>
              
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; margin-bottom: 2rem;">
                <div>
                  <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 1.5rem;">
                    <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-orange);"><i class="fas fa-info-circle"></i> Equipment Details</div>
                    <div style="font-size: 0.9rem; line-height: 2;">
                      <strong>Type:</strong> ${asset.assetType}<br>
                      <strong>Brand:</strong> ${asset.brand}<br>
                      <strong>Model:</strong> ${asset.model}<br>
                      <strong>Serial #:</strong> ${asset.serialNumber}<br>
                      <strong>Location:</strong> ${asset.location}
                    </div>
                  </div>
                </div>

                <div>
                  <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1.5rem;">
                    <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-blue);"><i class="fas fa-gauge"></i> Technical Specifications</div>
                    <div style="font-size: 0.9rem; line-height: 2;">
                      <strong>Capacity:</strong> ${asset.capacity}<br>
                      <strong>Power:</strong> ${asset.powerRating}<br>
                      <strong>Fuel:</strong> ${asset.fuelType}<br>
                      <strong>Efficiency:</strong> ${asset.efficiency}<br>
                      <strong>Age:</strong> ${asset.yearsInService} years
                    </div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-green);"><i class="fas fa-history"></i> Service History</div>
                <div style="font-size: 0.9rem;">
                  ${asset.serviceHistory.map(service => `
                    <div style="padding: 0.8rem; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 0.5rem;">
                      <strong>${service.date}:</strong> ${service.type} by ${service.provider}<br>
                      <span style="color: var(--text-muted); font-size: 0.85rem;">${service.notes} • Cost: €${service.cost}</span>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div style="background: rgba(192, 132, 252, 0.08); border: 1px solid var(--accent-purple); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.9rem;">
                  <i class="fas fa-shield-alt" style="color: var(--accent-purple);"></i>
                  <strong> Safety Features:</strong> ${asset.safetyFeatures.join(', ')}
                </div>
              </div>
            </div>

            <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
              <div style="font-size: 0.9rem;">
                <i class="fas fa-lightbulb" style="color: var(--accent-orange);"></i>
                <strong> Key Point:</strong> No product delivery required - Provider brings all necessary parts and consumables included in service price.
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Proceed to Crew Execution <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProviderNotificationMaintCard = (so, card) => {
        const asset = so.asset;
        const service = so.services[0];
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(251, 191, 36, 0.15); color: var(--accent-orange); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-hard-hat"></i> PROVIDER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">${so.provider.name} receives maintenance job</p>
            </div>

            <div class="mobile-screen" style="max-width: 400px; margin: 0 auto 2rem; background: #000; border-radius: 32px; padding: 1.5rem 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
              <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 1.3rem; font-weight: 700;">YellowGrid Pro</div>
                <div style="font-size: 0.85rem; color: #999; margin-top: 0.3rem;">Maintenance Service</div>
              </div>

              <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #fff; padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">
                  <i class="fas fa-wrench"></i> Maintenance Job
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem;">Job #SRV-${so.orderId.split('-')[2]}</div>
                <div style="font-size: 0.9rem;">${service.scheduledDate} • ${service.timeSlot} • ${service.duration} min</div>
              </div>

              <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;"><i class="fas fa-toolbox"></i> Asset Details</div>
                <div style="font-size: 0.85rem; line-height: 1.8; background: rgba(251, 191, 36, 0.2); padding: 0.8rem; border-radius: 8px;">
                  <strong>${asset.brand} ${asset.model}</strong><br>
                  Serial: ${asset.serialNumber}<br>
                  Type: ${asset.assetType} • ${asset.capacity}<br>
                  Age: ${asset.yearsInService} years • ${asset.fuelType}<br>
                  Last Service: ${asset.lastServiceDate}
                </div>
              </div>

              <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-weight: 700; margin-bottom: 0.8rem;"><i class="fas fa-clipboard-check"></i> Work Scope</div>
                <div style="font-size: 0.75rem; line-height: 1.6; max-height: 120px; overflow-y: auto;">
                  ${service.workScope.slice(0, 8).map(item => `• ${item}<br>`).join('')}
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.15); padding: 1rem; border-radius: 16px;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-green);"><i class="fas fa-box"></i> Parts Included</div>
                <div style="font-size: 0.75rem; color: #ccc;">
                  ✓ All parts included in service price<br>
                  ✓ Provider manages own inventory<br>
                  ✓ ${service.partsIncluded.length} consumables covered
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Provider Accepted <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderCrewExecutionMaintCard = (so, card) => {
        const asset = so.asset;
        const service = so.services[0];
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-hard-hat"></i> CREW
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> Crew Mobile App</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Maintenance Engineer - On-Site Service</p>
            </div>

            <div class="mobile-screen" style="max-width: 400px; margin: 0 auto 2rem; background: #000; border-radius: 32px; padding: 1.5rem 1rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
              <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 1.3rem; font-weight: 700;">YellowGrid Pro</div>
                <div style="font-size: 0.85rem; color: #999; margin-top: 0.3rem;">Maintenance Execution</div>
              </div>

              <div style="background: linear-gradient(135deg, #49d493, #38a169); color: #fff; padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">
                  <i class="fas fa-check-circle"></i> On-Site Maintenance
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem;">${asset.brand} ${asset.assetType}</div>
                <div style="font-size: 0.9rem;">Started ${service.timeSlot.split('-')[0]} • Duration: ${service.duration} min</div>
              </div>

              <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 16px; margin-bottom: 1rem;">
                <div style="font-weight: 700; margin-bottom: 0.8rem;"><i class="fas fa-list-check"></i> Maintenance Checklist</div>
                <div style="font-size: 0.8rem; line-height: 1.8; max-height: 180px; overflow-y: auto;">
                  ${service.workScope.map((item, idx) => `
                    <div style="padding: 0.4rem; background: rgba(73, 212, 147, 0.1); border-left: 3px solid var(--accent-green); margin-bottom: 0.3rem; border-radius: 4px;">
                      ✓ ${item}
                    </div>
                  `).join('')}
                </div>
              </div>

              <div style="background: rgba(251, 191, 36, 0.15); border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-orange);"><i class="fas fa-box-open"></i> Parts Used</div>
                <div style="font-size: 0.75rem; line-height: 1.5;">
                  ${service.partsIncluded.map(part => `• ${part}<br>`).join('')}
                  <span style="color: var(--accent-green); font-weight: 600;">✓ All parts included in service price</span>
                </div>
              </div>

              <div style="background: rgba(192, 132, 252, 0.15); border-radius: 8px; padding: 0.8rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-purple);"><i class="fas fa-camera"></i> Documentation</div>
                <div style="font-size: 0.75rem; color: #ccc;">
                  📸 Before/during/after photos captured<br>
                  📝 Service report being generated<br>
                  ✅ Combustion analysis completed
                </div>
              </div>
            </div>

            <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
              <div style="font-size: 0.9rem;">
                <i class="fas fa-info-circle" style="color: var(--accent-green);"></i>
                <strong> Maintenance Complete:</strong> All checklist items completed. Equipment tested and running normally. Service report will be generated after customer signs WCF.
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Job Complete <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderServiceReportCard = (so, card) => {
        const asset = so.asset;
        const service = so.services[0];
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-file-medical"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Auto-generated maintenance certificate and service report</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 2px solid var(--border); border-radius: 12px; padding: 2rem; max-width: 800px; margin: 0 auto 2rem;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <h3 style="font-size: 1.8rem; margin-bottom: 0.5rem;">Service Completion Certificate</h3>
                <p style="color: var(--text-muted);">Job #SRV-${so.orderId.split('-')[2]} • ${service.scheduledDate}</p>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 2px solid var(--accent-green); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <i class="fas fa-certificate" style="font-size: 2.5rem; color: var(--accent-green);"></i>
                  <div style="flex: 1;">
                    <strong style="font-size: 1.2rem; color: var(--accent-green);">Maintenance Completed Successfully</strong>
                    <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0.3rem 0 0 0;">All service items completed per checklist. Equipment tested and operational.</p>
                  </div>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.3rem;">Equipment</div>
                  <div style="font-weight: 600;">${asset.brand} ${asset.model}</div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">Serial: ${asset.serialNumber}</div>
                </div>
                <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.3rem;">Service Provider</div>
                  <div style="font-weight: 600;">${so.provider.name}</div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">${so.provider.certifications[0]}</div>
                </div>
              </div>

              <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-blue);"><i class="fas fa-clipboard-check"></i> Work Performed</div>
                <div style="font-size: 0.85rem; line-height: 1.8;">
                  ${service.deliverables.map(item => `✓ ${item}<br>`).join('')}
                </div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="text-align: center; padding: 1rem; background: rgba(73, 212, 147, 0.08); border-radius: 8px;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">A+</div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">Efficiency Rating</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: rgba(73, 212, 147, 0.08); border-radius: 8px;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-green);">PASS</div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">Safety Test</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: rgba(78, 168, 255, 0.08); border-radius: 8px;">
                  <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-blue);">12mo</div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">Next Service</div>
                </div>
              </div>

              <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.9rem;">
                  <i class="fas fa-lightbulb" style="color: var(--accent-orange);"></i>
                  <strong> Recommendation:</strong> Schedule next annual maintenance in 12 months (Nov 2026). All systems operating within normal parameters.
                </div>
              </div>
            </div>

            <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
              <div style="font-size: 0.9rem;">
                <i class="fas fa-file-pdf" style="color: var(--accent-blue);"></i>
                <strong> Documents Generated:</strong> Service certificate, Gas safety certificate, Combustion analysis report, Photo documentation - all available in customer portal.
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Authorize Payment <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderPaymentAuthMaintCard = (so, card) => {
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(73, 212, 147, 0.15); color: var(--accent-green); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-stamp"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Automatic payment processing for maintenance service</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-file-invoice-dollar"></i> Payment Authorization</h3>

              <div style="background: rgba(73, 212, 147, 0.15); border: 2px solid var(--accent-green); border-radius: 12px; padding: 2rem; margin-bottom: 1.5rem; text-align: center;">
                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">TOTAL PAYMENT</div>
                <div style="font-size: 3rem; font-weight: 700; color: var(--accent-green);">€${so.totals.total.toFixed(2)}</div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">Annual Boiler Maintenance (All-inclusive)</div>
              </div>

              <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;"><i class="fas fa-robot"></i> Automatic Authorization Triggered</div>
                <div style="font-size: 0.9rem; line-height: 1.8;">
                  ✅ Service completed successfully<br>
                  ✅ Work completion form signed by customer<br>
                  ✅ Service report generated and approved<br>
                  ✅ All certifications issued<br>
                  ✅ No issues or complaints reported
                </div>
              </div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Payment Method</div>
                  <div style="font-weight: 600;">${so.payment.method}</div>
                  <div style="font-size: 0.8rem; color: var(--accent-green); margin-top: 0.5rem;"><i class="fas fa-check-circle"></i> Auto-charged on completion</div>
                </div>
                <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Provider Payout</div>
                  <div style="font-weight: 600;">€${(so.totals.subtotalServices * 0.75).toFixed(2)}</div>
                  <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Released in 24-48 hours</div>
                </div>
              </div>

              <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.9rem;">
                  <i class="fas fa-info-circle" style="color: var(--accent-orange);"></i>
                  <strong> Maintenance Pricing:</strong> All-inclusive service price covers labor, parts, consumables, and certifications. No hidden fees.
                </div>
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                <i class="fas fa-check"></i> Payment Authorized <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderMaintenanceCompleteCard = (so, card) => {
        const asset = so.asset;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(73, 212, 147, 0.15); color: var(--accent-green); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-flag-checkered"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Service complete - Equipment maintained and certified</p>
            </div>

            <div style="background: linear-gradient(135deg, rgba(73, 212, 147, 0.2), rgba(73, 212, 147, 0.05)); border: 2px solid var(--accent-green); border-radius: 12px; padding: 3rem; text-align: center; margin-bottom: 2rem;">
              <div style="font-size: 5rem; margin-bottom: 1rem;">✅</div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green); margin-bottom: 1rem;">Maintenance Successfully Completed</div>
              <div style="font-size: 1.1rem; color: var(--text-muted);">Asset serviced, certified, and ready for next 12 months</div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-green); margin-bottom: 0.5rem;">€${so.totals.total.toFixed(2)}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Service Price</div>
                <div style="font-size: 0.8rem; color: var(--accent-green); margin-top: 0.5rem;">All-inclusive</div>
              </div>
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-blue); margin-bottom: 0.5rem;">${so.services[0].duration}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Minutes</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Service duration</div>
              </div>
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-orange); margin-bottom: 0.5rem;">12mo</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Next Service</div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Due Nov 2026</div>
              </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-list-check"></i> Maintenance Workflow Summary</h3>
              <div style="font-size: 0.95rem; line-height: 2;">
                ✅ <strong>No Products:</strong> Provider brought all parts - no product delivery phase<br>
                ✅ <strong>No Go Exec:</strong> Jumped directly to execution after contract<br>
                ✅ <strong>Asset Details:</strong> ${asset.brand} ${asset.model} (${asset.yearsInService} years old)<br>
                ✅ <strong>Comprehensive Service:</strong> ${so.services[0].workScope.length} checklist items completed<br>
                ✅ <strong>Certifications:</strong> Service certificate + Gas safety certificate issued<br>
                ✅ <strong>Service Report:</strong> Generated with findings and recommendations<br>
                ✅ <strong>Payment:</strong> €${so.totals.total.toFixed(2)} auto-charged to ${so.payment.method}<br>
                ✅ <strong>Provider:</strong> ${so.provider.name} (Rating: ${so.provider.rating}/5.0)
              </div>
            </div>

            <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1rem;"><i class="fas fa-key"></i> Key Differentiators - Maintenance vs Installation</h3>
              <div style="font-size: 0.9rem; line-height: 2;">
                <strong>Maintenance Flow:</strong> Contract → Provider → <span style="text-decoration: line-through; color: #666;">Product Delivery</span> → <span style="text-decoration: line-through; color: #666;">Go Exec</span> → Asset Info → Execution → WCF → Report → Payment<br>
                <strong>Installation Flow:</strong> Contract → Provider → Product Delivery → Go Exec → Execution → WCF → Payment<br>
                <br>
                <strong style="color: var(--accent-orange);">No Go Exec Gate:</strong> Maintenance doesn't wait for product delivery - provider brings parts<br>
                <strong style="color: var(--accent-purple);">Asset Focus:</strong> Asset details replace product cards - shows what's being maintained<br>
                <strong style="color: var(--accent-blue);">Service Report:</strong> Maintenance generates certification and recommendations
              </div>
            </div>

            <div style="text-align: center;">
              <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="alert('✅ Maintenance Complete! Demonstrated asset-centric service flow with no product dependency.')">
                <i class="fas fa-flag-checkered"></i> Complete Journey
              </button>
              <div style="margin-top: 1rem; color: var(--accent-green);">
                <i class="fas fa-wrench"></i> <strong>Maintenance Scenario</strong> - Asset servicing with provider-managed inventory
              </div>
            </div>
          </div>
        `;
      };

      // ===== DÉPANNAGE SCENARIO RENDER FUNCTIONS =====

      const renderMultiProviderDispatchCard = (so, card) => {
        const bidding = so.providerBidding;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-tower-broadcast"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Expedited dispatch to multiple providers simultaneously</p>
            </div>

            <div style="background: rgba(251, 191, 36, 0.08); border: 2px solid var(--accent-orange); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3.5rem; margin-bottom: 1rem;">🚀</div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">DÉPANNAGE EXPEDITED PROCESS</div>
                <div style="font-size: 1.1rem; color: var(--text-muted);">Multi-Provider Dispatch - First to Accept Wins</div>
              </div>

              <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem; color: var(--accent-orange);"><i class="fas fa-bolt"></i> Dispatch Strategy</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                  <div style="text-align: center; padding: 1rem; background: rgba(78, 168, 255, 0.1); border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-blue);">${bidding.providersContacted}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Providers Contacted</div>
                  </div>
                  <div style="text-align: center; padding: 1rem; background: rgba(251, 191, 36, 0.1); border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-orange);">${bidding.timeLimit}</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Response Window</div>
                  </div>
                  <div style="text-align: center; padding: 1rem; background: rgba(73, 212, 147, 0.1); border-radius: 8px;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green);">1st</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">First Wins</div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;"><i class="fas fa-users"></i> ${bidding.providersContacted} Eligible Providers</div>
                ${bidding.providers.map((p, idx) => `
                  <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                      <div style="font-weight: 600;">${idx + 1}. ${p.name}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${p.distanceFromCustomer} away</div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 0.85rem; color: var(--accent-blue);">Contacted: ${new Date(p.contacted).toLocaleTimeString()}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">Waiting for response...</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <div style="background: rgba(78, 168, 255, 0.08); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
              <div style="font-size: 0.9rem;">
                <i class="fas fa-info-circle" style="color: var(--accent-blue);"></i>
                <strong> Dépannage Logic:</strong> System dispatches to ${bidding.providersContacted} eligible providers simultaneously. First provider to accept wins the job. All other offers automatically withdrawn.
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Watch Bidding Race <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderProviderBiddingRaceCard = (so, card) => {
        const bidding = so.providerBidding;
        const winner = bidding.providers.find(p => p.status === 'Winner - Assigned');
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(251, 191, 36, 0.15); color: var(--accent-orange); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-stopwatch"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Real-time provider responses - Race to accept</p>
            </div>

            <div style="background: rgba(251, 191, 36, 0.08); border: 2px solid var(--accent-orange); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">⏱️</div>
                <div style="font-size: 1.3rem; font-weight: 700; color: var(--accent-orange); margin-bottom: 0.5rem;">BIDDING IN PROGRESS</div>
                <div style="font-size: 1rem; color: var(--text-muted);">Elapsed Time: ${bidding.totalElapsedTime}</div>
              </div>

              <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1.5rem;">
                <div style="font-weight: 700; margin-bottom: 1rem;"><i class="fas fa-list-check"></i> Provider Responses</div>
                ${bidding.providers.map((p, idx) => {
                  let statusColor = 'var(--text-muted)';
                  let statusIcon = 'hourglass-half';
                  let statusBg = 'rgba(255,255,255,0.03)';
                  
                  if (p.response === 'Accepted') {
                    statusColor = 'var(--accent-green)';
                    statusIcon = 'circle-check';
                    statusBg = 'rgba(73, 212, 147, 0.15)';
                  } else if (p.response === 'Declined') {
                    statusColor = '#ef4444';
                    statusIcon = 'circle-xmark';
                    statusBg = 'rgba(239, 68, 68, 0.08)';
                  } else if (p.response === 'Offer Withdrawn') {
                    statusColor = 'var(--text-muted)';
                    statusIcon = 'ban';
                    statusBg = 'rgba(255,255,255,0.02)';
                  }
                  
                  return `
                    <div style="padding: 1rem; background: ${statusBg}; border-radius: 6px; margin-bottom: 0.75rem; border-left: 3px solid ${statusColor};">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                          <div style="font-weight: 600; margin-bottom: 0.3rem;">${idx + 1}. ${p.name}</div>
                          <div style="font-size: 0.85rem; color: var(--text-muted);">${p.distanceFromCustomer} • ${p.response === 'No Response' ? 'Waiting...' : p.responseTime}</div>
                        </div>
                        <div style="text-align: right;">
                          <div style="font-size: 1.2rem; color: ${statusColor};"><i class="fas fa-${statusIcon}"></i></div>
                          <div style="font-size: 0.85rem; font-weight: 600; color: ${statusColor};">${p.response}</div>
                        </div>
                      </div>
                      ${p.declineReason ? `<div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; font-style: italic;">Reason: ${p.declineReason}</div>` : ''}
                      ${p.status.includes('Winner') ? `<div style="font-size: 0.85rem; color: var(--accent-green); margin-top: 0.5rem; font-weight: 600;"><i class="fas fa-trophy"></i> ${p.status}</div>` : ''}
                      ${p.status.includes('withdrawn') ? `<div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; font-style: italic;">${p.status}</div>` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>

            <div style="background: rgba(73, 212, 147, 0.08); border: 2px solid var(--accent-green); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
              <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-green); margin-bottom: 0.5rem;">
                <i class="fas fa-trophy"></i> WINNER: ${winner.name}
              </div>
              <div style="font-size: 0.95rem; line-height: 1.8;">
                ✓ <strong>Response Time:</strong> ${winner.responseTime}<br>
                ✓ <strong>Accepted At:</strong> ${new Date(winner.acceptedAt).toLocaleTimeString()}<br>
                ✓ <strong>Distance:</strong> ${winner.distanceFromCustomer}<br>
                ✓ <strong>ETA:</strong> ${winner.estimatedArrival}
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()">
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Provider Accepted <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderDepannageCompleteCard = (so, card) => {
        const bidding = so.providerBidding;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(73, 212, 147, 0.15); color: var(--accent-green); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-flag-checkered"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Urgent service completed - Customer issue resolved</p>
            </div>

            <div style="background: linear-gradient(135deg, rgba(73, 212, 147, 0.2), rgba(73, 212, 147, 0.05)); border: 2px solid var(--accent-green); border-radius: 12px; padding: 3rem; text-align: center; margin-bottom: 2rem;">
              <div style="font-size: 5rem; margin-bottom: 1rem;">✅</div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green); margin-bottom: 1rem;">Dépannage Service Complete</div>
              <div style="font-size: 1.1rem; color: var(--text-muted);">Urgent same-day service delivered - Issue resolved within SLA</div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--accent-orange); margin-bottom: 0.5rem;">${bidding.providersContacted}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Providers Dispatched</div>
              </div>
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green); margin-bottom: 0.5rem;">${bidding.totalElapsedTime.split(' ')[0]}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Assignment Time</div>
              </div>
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--accent-blue); margin-bottom: 0.5rem;">${so.urgencyLevel}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Urgency Level</div>
              </div>
              <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--accent-purple); margin-bottom: 0.5rem;">€${so.financials.providerPayment.toFixed(2)}</div>
                <div style="font-size: 0.9rem; color: var(--text-muted);">Provider Paid</div>
              </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-list-check"></i> Dépannage Flow Summary</h3>
              <div style="font-size: 0.95rem; line-height: 2;">
                🚀 <strong>Sales Channel:</strong> ${so.salesChannel} - Customer purchased urgent service online<br>
                🚀 <strong>Multi-Dispatch:</strong> ${bidding.providersContacted} providers contacted simultaneously<br>
                🚀 <strong>Winner:</strong> ${bidding.winningProvider} (accepted in ${bidding.totalElapsedTime})<br>
                🚀 <strong>Service:</strong> ${so.services[0].name}<br>
                🚀 <strong>Provider Payment:</strong> Platform pays €${so.financials.providerPayment.toFixed(2)} to provider after completion<br>
                🚀 <strong>Customer Payment:</strong> Customer paid RETAILER €${so.financials.customerPayment.toFixed(2)} at purchase (web portal)<br>
                🚀 <strong>Platform Fee:</strong> €${so.financials.platformFee.toFixed(2)} (${((so.financials.platformFee / (so.financials.providerPayment + so.financials.platformFee)) * 100).toFixed(0)}%)
              </div>
            </div>

            <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
              <h3 style="margin-bottom: 1rem;"><i class="fas fa-key"></i> Dépannage vs Standard Service</h3>
              <div style="font-size: 0.9rem; line-height: 2;">
                <strong style="color: var(--accent-orange);">Dispatch:</strong> Multi-provider (5 at once) vs single provider sequential<br>
                <strong style="color: var(--accent-green);">Speed:</strong> ${bidding.totalElapsedTime} assignment vs hours/days standard<br>
                <strong style="color: var(--accent-blue);">Payment Flow:</strong> Customer → Retailer (at purchase) | Platform → Provider (after completion)<br>
                <strong style="color: var(--accent-purple);">SLA:</strong> ${so.slaCommitment}
              </div>
            </div>

            <div style="text-align: center;">
              <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="alert('✅ Dépannage Complete! Demonstrated expedited multi-provider bidding with first-to-accept assignment.')">
                <i class="fas fa-flag-checkered"></i> Complete Journey
              </button>
              <div style="margin-top: 1rem; color: var(--accent-green);">
                <i class="fas fa-bolt"></i> <strong>Dépannage Scenario</strong> - Urgent service with expedited dispatch
              </div>
            </div>
          </div>
        `;
      };

      // ===== SUBSCRIPTION SCENARIO RENDER FUNCTIONS =====

      const renderServiceReminderCard = (so, card) => {
        const sub = so.subscription;
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(78, 168, 255, 0.15); color: var(--accent-blue); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-bell"></i> CUSTOMER
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Auto-scheduled subscription service notification</p>
            </div>

            <div style="background: rgba(78, 168, 255, 0.08); border: 2px solid var(--accent-blue); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">📅</div>
                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Quarterly Service Due</div>
                <div style="font-size: 1.1rem; color: var(--text-muted);">Visit ${so.serviceVisitNumber} of ${so.totalVisitsInContract} in your annual plan</div>
              </div>

              <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                  <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.3rem;">Subscription Plan</div>
                    <div style="font-weight: 700;">${sub.planName}</div>
                    <div style="font-size: 0.9rem; color: var(--accent-blue);">${sub.tier} Tier</div>
                  </div>
                  <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.3rem;">Monthly Fee</div>
                    <div style="font-weight: 700;">€${sub.monthlyFee.toFixed(2)}</div>
                    <div style="font-size: 0.9rem; color: var(--accent-green);">Service included</div>
                  </div>
                </div>
              </div>

              <div style="background: rgba(73, 212, 147, 0.08); border: 1px solid var(--accent-green); border-radius: 8px; padding: 1rem;">
                <div style="font-size: 0.9rem;">
                  <strong><i class="fas fa-calendar-check"></i> Scheduled:</strong> ${so.services[0].scheduledDate} at ${so.services[0].timeSlot}<br>
                  <strong><i class="fas fa-wrench"></i> Service:</strong> ${so.services[0].name}<br>
                  <strong><i class="fas fa-user"></i> Technician:</strong> ${so.provider.assignedTechnician} (same as previous visits)
                </div>
              </div>
            </div>

            <div style="background: rgba(251, 191, 36, 0.08); border: 1px solid var(--accent-orange); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
              <div style="font-size: 0.9rem;">
                <i class="fas fa-info-circle" style="color: var(--accent-orange);"></i>
                <strong> Subscription Benefits Active:</strong> No additional charge for this visit • 15% discount on any repairs needed • Priority emergency response
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Confirm Schedule <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderSubscriptionContinuesCard = (so, card) => {
        const sub = so.subscription;
        const asset = so.assets[0];
        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: rgba(73, 212, 147, 0.15); color: var(--accent-green); padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-rotate"></i> SYSTEM
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">Subscription continues - Next service auto-scheduled</p>
            </div>

            <div style="background: linear-gradient(135deg, rgba(73, 212, 147, 0.2), rgba(73, 212, 147, 0.05)); border: 2px solid var(--accent-green); border-radius: 12px; padding: 3rem; text-align: center; margin-bottom: 2rem;">
              <div style="font-size: 5rem; margin-bottom: 1rem;">🔄</div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--accent-green); margin-bottom: 1rem;">Subscription Active & Renewed</div>
              <div style="font-size: 1.1rem; color: var(--text-muted);">Next service auto-scheduled for ${asset.nextServiceDue}</div>
            </div>

            <div style="text-align: center;">
              <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="alert('✅ Subscription Active! Demonstrated recurring service model with auto-scheduling and relationship continuity.')">
                <i class="fas fa-flag-checkered"></i> Complete Journey
              </button>
              <div style="margin-top: 1rem; color: var(--accent-green);">
                <i class="fas fa-rotate"></i> <strong>Subscription Scenario</strong> - Recurring maintenance with auto-renewal
              </div>
            </div>
          </div>
        `;
      };

      // ===== GENERIC CARD RENDERER FOR UNMAPPED CARDS =====
      
      const renderGenericCard = (so, card) => {
        const actorColors = {
          'CUSTOMER': 'rgba(239, 68, 68, 0.15), #ef4444',
          'PROVIDER': 'rgba(251, 191, 36, 0.15), var(--accent-orange)',
          'CREW': 'rgba(73, 212, 147, 0.15), var(--accent-green)',
          'SYSTEM': 'rgba(78, 168, 255, 0.15), var(--accent-blue)',
          'AI': 'rgba(192, 132, 252, 0.15), var(--accent-purple)'
        };
        const [bgColor, textColor] = (actorColors[card.actor] || 'rgba(255,255,255,0.05), var(--text-primary)').split(', ');

        return `
          <div style="padding: 2rem;">
            <div style="margin-bottom: 2rem;">
              <div style="display: inline-block; background: ${bgColor}; color: ${textColor}; padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-${card.icon}"></i> ${card.actor}
              </div>
              <h2 style="font-size: 2rem; margin-bottom: 0.5rem;"><i class="fas fa-${card.icon}"></i> ${card.title}</h2>
              <p style="color: var(--text-muted); font-size: 1.1rem;">${card.subtitle || 'Processing step in workflow'}</p>
            </div>

            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
              <div style="font-size: 1.1rem; line-height: 1.8; color: var(--text-muted);">
                This step represents: <strong>${card.title}</strong>
                ${card.subtitle ? `<br><br>${card.subtitle}` : ''}
                ${so.customer ? `<br><br><strong>Customer:</strong> ${so.customer.name}` : ''}
                ${so.provider ? `<br><strong>Provider:</strong> ${so.provider.name}` : ''}
              </div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem;">
              <button class="btn btn-secondary" onclick="dashboard.previousCard()" ${currentCardIndex === 0 ? 'disabled' : ''}>
                <i class="fas fa-arrow-left"></i> Back
              </button>
              <button class="btn btn-primary" onclick="dashboard.nextCard()">
                Next Step <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        `;
      };

      const renderMetroLine = () => {
        const html = allCards.map((card, idx) => {
          const isActive = idx === currentCardIndex;
          const isCompleted = idx < currentCardIndex;
          const dotClass = isActive ? 'active' : (isCompleted ? 'completed' : '');
          const lineClass = isCompleted ? 'completed' : '';
          
          return `
            <div class="metro-station">
              <div class="station-dot ${dotClass}" onclick="dashboard.goToCard(${idx})" title="${card.title}">
                <i class="fas fa-${card.icon}"></i>
                <div class="station-label">${card.title}</div>
              </div>
              ${idx < allCards.length - 1 ? `<div class="station-line ${lineClass}"></div>` : ''}
            </div>
          `;
        }).join('');
        
        document.getElementById('metroLine').innerHTML = html;
      };

      const renderCard = () => {
        const card = allCards[currentCardIndex];
        if (!card) return;

        const so = scenarios[currentScenario].salesOrder;
        let html = '';

        // Render different card types
        if (card.id === 'kafka-message') {
          html = renderKafkaMessageCard(so, card);
        } else if (card.id === 'enrichment') {
          html = renderEnrichmentCard(so, card);
        } else if (card.id === 'project-creation') {
          html = renderProjectCreationCard(so, card);
        } else if (card.id === 'ai-reasoning') {
          html = renderAIReasoningCard(so, card);
        } else if (card.id === 'operator-cockpit') {
          html = renderOperatorCockpitCard(so, card);
        } else if (card.id === 'contract-notification') {
          html = renderContractNotificationCard(so, card);
        } else if (card.id === 'contract-portal') {
          html = renderContractPortalCard(so, card);
        } else if (card.id === 'provider-funnel') {
          html = renderProviderFunnelCard(so, card);
        } else if (card.id === 'provider-offer') {
          html = renderProviderOfferCard(so, card);
        } else if (card.id.startsWith('go-gate-check')) {
          html = renderGoGateCard(so, card);
        } else if (card.id === 'tv-crew-execution') {
          html = renderTVCrewExecutionCard(so, card);
        } else if (card.id === 'tv-report-upload') {
          html = renderTVReportUploadCard(so, card);
        } else if (card.id === 'tv-report-analysis') {
          html = renderTVReportAnalysisCard(so, card);
        } else if (card.id === 'tv-outcome-gate') {
          html = renderTVOutcomeGateCard(so, card);
        } else if (card.id === 'sales-alert') {
          html = renderSalesAlertCard(so, card);
        } else if (card.id === 'so-update-sync') {
          html = renderSOUpdateSyncCard(so, card);
        } else if (card.id.startsWith('crew-execution')) {
          html = renderCrewExecutionCard(so, card);
        } else if (card.id === 'wcf-notification') {
          html = renderWCFNotificationCard(so, card);
        } else if (card.id === 'wcf-portal') {
          html = renderWCFPortalCard(so, card);
        } else if (card.id.startsWith('quality-visit')) {
          html = renderQualityVisitCard(so, card);
        } else if (card.id.startsWith('invoice-portal')) {
          html = renderInvoicePortalCard(so, card);
        } else if (card.id === 'invoice-dataflow') {
          html = renderInvoiceDataflowCard(so, card);
        } else if (card.id === 'payment-authorization') {
          html = renderPaymentAuthorizationCard(so, card);
        } else if (card.id.startsWith('payment-auth')) {
          html = renderPaymentAuthCard(so, card);
        } else if (card.id.startsWith('payment-portal')) {
          html = renderPaymentPortalCard(so, card);
        } else if (card.id.startsWith('phase-unlock')) {
          html = renderPhaseUnlockCard(so, card);
        } else if (card.id === 'project-complete') {
          html = renderProjectCompleteCard(so, card);
        } else if (card.id === 'rework-trigger') {
          html = renderReworkTriggerCard(so, card);
        } else if (card.id === 'problem-assessment') {
          html = renderProblemAssessmentCard(so, card);
        } else if (card.id === 'root-cause-analysis') {
          html = renderRootCauseAnalysisCard(so, card);
        } else if (card.id === 'rework-decision') {
          html = renderReworkDecisionCard(so, card);
        } else if (card.id === 'provider-assignment') {
          html = renderProviderAssignmentCard(so, card);
        } else if (card.id === 'provider-notification') {
          html = renderProviderNotificationCard(so, card);
        } else if (card.id === 'quality-check') {
          html = renderQualityCheckCard(so, card);
        } else if (card.id === 'rework-complete') {
          html = renderReworkCompleteCard(so, card);
        } else if (card.id === 'asset-details') {
          html = renderAssetDetailsCard(so, card);
        } else if (card.id === 'provider-notification-maint') {
          html = renderProviderNotificationMaintCard(so, card);
        } else if (card.id === 'crew-execution-maint') {
          html = renderCrewExecutionMaintCard(so, card);
        } else if (card.id === 'service-report') {
          html = renderServiceReportCard(so, card);
        } else if (card.id === 'payment-auth-maint') {
          html = renderPaymentAuthMaintCard(so, card);
        } else if (card.id === 'maintenance-complete') {
          html = renderMaintenanceCompleteCard(so, card);
        } else if (card.id === 'multi-provider-dispatch') {
          html = renderMultiProviderDispatchCard(so, card);
        } else if (card.id === 'provider-bidding-race') {
          html = renderProviderBiddingRaceCard(so, card);
        } else if (card.id === 'depannage-complete') {
          html = renderDepannageCompleteCard(so, card);
        } else if (card.id === 'service-reminder') {
          html = renderServiceReminderCard(so, card);
        } else if (card.id === 'subscription-continues') {
          html = renderSubscriptionContinuesCard(so, card);
        } else if (card.id === 'invoice-portal-dep' || card.id === 'invoice-portal-sub') {
          html = renderInvoicePortalCard(so, card);
        } else if (card.id === 'payment-authorization-dep' || card.id === 'payment-authorization-sub') {
          html = renderPaymentAuthorizationCard(so, card);
        } else if (card.id === 'payment-portal-dep' || card.id === 'payment-portal-sub') {
          html = renderPaymentPortalCard(so, card);
        } else {
          // Generic render for unmapped cards (provider assignments, crew execution, etc.)
          html = renderGenericCard(so, card);
        }

        document.getElementById('journeyCard').innerHTML = html;
      };

      const loadScenario = (scenarioId) => {
        if (!scenarioId) return;
        currentScenario = scenarioId;
        currentCardIndex = 0;
        allCards = getCardsForScenario(scenarioId);
        renderMetroLine();
        renderCard();
      };

      const nextCard = () => {
        if (currentCardIndex < allCards.length - 1) {
          currentCardIndex++;
          renderMetroLine();
          renderCard();
        }
      };

      const previousCard = () => {
        if (currentCardIndex > 0) {
          currentCardIndex--;
          renderMetroLine();
          renderCard();
        }
      };

      const goToCard = (index) => {
        if (index >= 0 && index < allCards.length) {
          currentCardIndex = index;
          renderMetroLine();
          renderCard();
        }
      };

      const nextStep = () => {
        nextCard(); // Keep for backward compatibility with button
      };

      window.dashboard = {
        loadScenario,
        nextStep,
        nextCard,
        previousCard,
        goToCard
      };

      // Auto-load Simple Installation scenario on page load
      setTimeout(() => {
        loadScenario('simple-install');
        document.getElementById('scenarioSelect').value = 'simple-install';
      }, 100);
    })();
  </script>
</body>
</html>
